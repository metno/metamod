OAI PMH 2.0 server adapted to METAMOD2
======================================

This OAI PMH data provider is adapted from software developed by Heinrich Stamerjohanns,
Institute for Science Networking. A README file mostly written by him can be found in the
doc directory. This README file explains how the software works in the METAMOD2 environment.

The software comprise the following PHP files:

oai2.php                        - Startpage for all queries

index.php                       - Wellcome page. Not used by METAMOD2

test_buildxml.php               - Small wrapper to initate tests on the oai2/buildxml.php
                                  object class.

oai2/oaidp-config.php           - Configuration. This file was originally designed to contain
                                  all adaptations needed by a web site using this software.
                                  In METAMOD2, the file contain such configuration in addition
                                  to more algoritmic stuff.

                                  Some of the most important configuration is included in the
                                  $METADATAFORMATS array. This array is indexed by the
                                  metadataPrefix variable (Get-variable) which may take one of
                                  the values: 'oai_dc', 'dif', 'iso19115' or 'iso19139'.
                                  Each element is itself an array containing key -> value pairs
                                  that describe configuration dependent on the selected metadata 
                                  format. One of the keys used, is 'myhandler'. The 
                                  corresponding value is the same for all the matadata formats,
                                  namely: 'record_gen.php'. This is the name of the file
                                  that generates the important (and complex) <metadata> XML
                                  element.

                                  The file contains a very important function, getRecords.
                                  This function fetches from the metadata database, all the
                                  needed metadata from all the requested datasets. Which
                                  metadata to fetch are taken from the $key_conversion array
                                  (documented below). The datasets to fetch is given by
                                  arguments to the function (either an identifier corresponding
                                  to the DS_name field in the database, or a time period).
                                  The metadata is returned as an array indexed by the DS_id
                                  database field. Each element in this array is itself an array,
                                  indexed by selected field names in the DataSet database table,
                                  or by values from the MT_name field in the Metadata table.

oai2/var_topic.php              - File added for METAMOD2. Contain tables for translation
                                  from database values to strings needed in the produced DIF
                                  records.

oai2/get_exception.php          - File added for METAMOD2. Contains the get_exception function
                                  used to trig special treatment of various productions of
                                  XML content. The function is called if the "mtname value"
                                  taken from the $key_conversion array contains a number after
                                  the MT_name string. This exception number, together with the
                                  MT_name string and the value found for MT_name in the database,
                                  is sent as arguments to the function. The function will return
                                  an alternative value for MT_name, based on this information.

oai2/record_dc.php              - Used for Dublin Core productions. Not much used by METAMOD2.

oai2/listsets.php               - Used for presenting which OAI sets are supported. METAMOD2
                                  do not use sets.

oai2/identify.php               - Used to present a small identifaction XML.

oai2/listmetadataformats.php    - Used to present which metadataformats are supported.

oai2/getrecord.php              - Used to provide a metadata XML for one dataset. Serves URLs like:

                                  http://dokipy.met.no/r1/pmh/oai2.php?verb=GetRecord&
                                       metadataPrefix=dif&identifier=oai:met.no:metamod/DAMOC/conc

oai2/oaidp-util.php             - Various utility function: Format conversion, checking, error 
                                  reporting etc.

oai2/buildxml.php               - File added for METAMOD2. Defines an object class buildxml
                                  that is used to build (part of) XML files incrementally.
                                  The main functionality is found in the 'add' method that
                                  takes a path and a string value as arguments. For example:

                                  $b1->add('Data_Center Data_Center_Name Short_Name', 'NO/MET');

                                  will produce:

                                  <Data_Center>
                                     <Data_Center_Name>
                                        <Short_Name>NO/MET</Short_Name>
                                     </Data_Center_Name>
                                  </Data_Center>

                                  More elaborate pathes using extra syntax is possible. Also,
                                  the last element produced before the current 'add' invocation
                                  will be considered. A possible outcome will be to merge the
                                  new XML element into the last element.

oai2/listrecords.php            - Used to provide a metadata XML for several datasets. Serves URLs 
                                  like:

                                  http://dokipy.met.no/r1/pmh/oai2.php?verb=ListRecords&
                                       metadataPrefix=dif&from=2008-09-03

oai2/listidentifiers.php        - Used to provide an XML containing only header information for
                                  each requested dataset. A header has two elements: identifier
                                  and datestamp. Serves URLs like:

                                  http://dokipy.met.no/r1/pmh/oai2.php?verb=ListIdentifiers&
                                       metadataPrefix=dif&from=2008-09-03

oai2/record_gen.php             - This file is the main workhorse for producing the metadata
                                  parts of the XML files. It is included in other files where
                                  this functionality is needed. The variable $output is initialized
                                  before this file is included, and will contain unfinished
                                  initial XML code. Record_gen.php will then add a <metadata> XML
                                  element to this variable.

Overall program flow.
---------------------

URLs like http://dokipy.met.no/r1/pmh/oai2.php?... activates:

    oai2.php       Performing the following actions:

                   - The variable $output is set to an empty string.
                   - One of the following files is activated (included), depending on the Get-variable
                     'verb':

                     oai2/getrecord.php
                     oai2/identify.php
                     oai2/listidentifiers.php
                     oai2/listmetadataformats.php
                     oai2/listrecords.php
                     oai2/listsets.php

                   - These files will fill the variable $output with XML content.
                   - Together with header etc. and a final </OAI_PMH> tag, the output is sent to the
                     user. Before this is done, XML validation may take place.

Only the oai2/getrecord.php and oai2/listrecords.php files will output metadata elements. The actions
performed by these files are described in more detail below:

    oai2/getrecord.php

                   Two Get-variables, 'identifier' and 'metadataPrefix' are collected. The value of
                   'metadataPrefix' is, among other things, used to find which PHP file is applied in
                   order to construct the <metadata> element in the XML. The variable $inc_record will
                   be set to the name of this file. In all cases, this name will be 'record_gen.php'.
                   So, at least for the met.no implementation, this file name could have been used
                   directly as an alternative to using the $inc_record value.
                   
                   The 'identifier' value is used as the argument to function getRecords, that fetches
                   all metadata key - value pairs from the database.

                   After adding a <header> element to the variable $output, the oai2/record_gen.php
                   file is activated (or more precisely "oai2/".$inc_record). This file adds the
                   <metadata> element to the variable $output. The oai2/record_gen.php file is
                   described in more detail below.
                   
    oai2/listrecords.php

                   This file collects several Get-variables. 'from' and 'until' difines a time interval
                   that is used to request all datasets that have a last changed date within this time
                   interval. The 'metadataPrefix' is also collected, and used in the same manner as 
                   described above (for oai2/getrecord.php). Also a 'resumptionToken' variable is
                   collected if it exists.

                   The function getRecords is called with arguments describing the time interval given
                   by 'from' and 'until'.  As described above, this function returns, for each matching
                   dataset, all metadata key - value pairs describing the dataset.

                   Then, metadata for all datasets (or for a subset of the datasets if resumptionToken
                   is used) are added to the variable $output. For each dataset, a <record> element is
                   produced, containing a <header> and a <metadata> element. The <metadata> element is
                   produced by the oai2/record_gen.php file as described above (for oai2/getrecord.php).

The two files above (oai2/getrecord.php and oai2/listrecords.php) both use the following file to
produce the actual matadata XML content for each dataset:

    oai2/record_gen.php

                   This file adds a <metadata> element to the variable $output that describes one
                   dataset.

                   The file uses a variable, $record, that represents one element in the array returned
                   from the getRecords function. This variable is set outside the oai2/record_gen.php
                   file. The $record varible is an array with the following structure:

                       $record['DS_name']        = Value of the DS_name field in the DataSets database
                                                   table
                       $record['DS_status']      = Tells if the dataset has a deleted status or not 
                                                   (text string 'true' for deleted, 'false' othervise).
                       $record['OAI_datestamp']  = Value of the DS_datestamp field in the DataSets 
                                                   database table
                       $record['DS_datestamp']   = Only the date part of the DS_datestamp field in the
                                                   DataSets database table
                       $record['DS_ownertag']    = Value of the DS_ownertag field in the DataSets table
                       $record['DS_metadataFormat']
                                                 = Value of the DS_metadataFormat field in the DataSets
                                                   table (= 'MM2' or 'DIF')

                       Then follows elements describing the values found in the Metadata database table.
                       The array key used for these elements are the MT_name field in this table. For 
                       each MT_name value, several rows in the Metadata table may exist that describe 
                       the same dataset. Accordingly, an array is used to represent all the values found 
                       in these rows. Suppose $mtname represents the MT_name key, then elements as 
                       follows are found:
                   
                       $record[$mtname]          = Array of MD_content values taken from the Metadata
                                                   database table (rows coupled to the DataSets table 
                                                   row through the DS_Has_MD relationship)

                   Before generating metadata XML content, the program checks if any XML file exists
                   that can be used unmodified to be included in the output XML as the content of the
                   <metadata> element. If so, this file is added to the variable $output.

                   Othervise, the content of the <metadata> element is produced on the basis of the
                   $record array, and using the $key_conversion array as a "template".

The $key_conversion array is used both in the getRecords function and in the oai2/record_gen.php file.
It serves both as a source on which metadata to fetch from the database (in the getRecords function) and
as a "template" for producing the XML (in the oai2/record_gen.php file). A documentation of this array
follows:

    $key_conversion = array(
       '!DS_name 1', 'Entry_ID', '','',
       'title', 'Entry_Title', '','Not Available',
# there is no way to make sure, that PI_name, title institution and dataref belong
# to the same Data_Set. As long as the data is extracted via digest_nc, we allow only
# one Data_Set, but when received from other sources (i.e. from DIF), this is not clear.
# Just hoping for the best. HK 13.05.2009
       'PI_name', '*Data_Set_Citation Dataset_Creator', '','Not Available',
       'title', 'Data_Set_Citation Dataset_Title', '','Not Available',
       '', 'Data_Set_Citation Dataset_Release_Date', 'Not Available', '',
       '', 'Data_Set_Citation Dataset_Release_Place', 'Not Available', '',
       'institution', 'Data_Set_Citation Dataset_Publisher', '','',
       '', 'Data_Set_Citation Version', 'Not Available', '',
       '', '*Personnel Role', 'Technical Contact', '',
       '', 'Personnel First_Name', 'Egil', '',
       '', 'Personnel Last_Name', 'Støren', '',
       '', 'Personnel Email', 'Not Available', '',
       '', 'Personnel Phone', '+4722963000', '',
       '', 'Personnel Contact_Address Address', "Norwegian Meteorological Institute\nP.O. Box 43\nBlindern",'',
       '', 'Personnel Contact_Address City', 'Oslo','',
       '', 'Personnel Contact_Address Postal_Code', 'N-0313','',
       '', 'Personnel Contact_Address Country', 'Norway','',
       'variable 99', '*Parameters Category', 'EARTH SCIENCE','Not Available',
       'variable 1', 'Parameters Topic', '','Not Available',
       'variable 2', 'Parameters Term', '','Not Available',
       'variable 3', 'Parameters Variable_Level_1', '','',
       'variable -1', 'Parameters Detailed_Variable', '','',
       'topiccategory 1', 'ISO_Topic_Category', '','', # required by IPY
       'keywords', 'Keyword', '','',
       'datacollection_period 1', 'Temporal_Coverage Start_Date', '','', # required by IPY
       'datacollection_period 2', 'Temporal_Coverage Stop_Date', '','',  # required by IPY
       '', 'Data_Set_Progress', 'In Work', '', # in work, means Not Available here
       'bounding_box 1', 'Spatial_Coverage', '','', # required by IPY
       'area 1', '*Location Location_Category', '','', # required by IPY
       'area 2', 'Location Location_Type', '','',
       'area 3', 'Location Location_Subregion1', '','',
       'area -1', 'Location Detailed_Location', '','',
       'area 10', '*Location Location_Category', '','', # required by GCMD
       'area 11', 'Location Location_Type', '','', # required by GCMD
       'area 12', '*Location Location_Category', '','', # required by GCMD
       'area 13', 'Location Location_Type', '','', # required by GCMD
       'latitude_resolution 1', 'Data_Resolution Latitude_Resolution', '','',
       'longitude_resolution 1', 'Data_Resolution Longitude_Resolution', '','',
       'project_name 3', '*Project Short_Name', '', 'Not Available', # required by GCMD (IPY projects)
       'project_name 4', 'Project Long_Name', '', '', # required by GCMD (IPY projects)
       'project_name 1', '*Project Short_Name', '', '',
       'project_name 2', 'Project Long_Name', '', '',
       'distribution_statement', 'Access_Constraints', '','Not Available',
       '', 'Use_Constraints', 'Not Available', '',
       '', 'Data_Set_Language', 'Not Available', '',
       '', 'Data_Center Data_Center_Name Short_Name', 'NO/MET','',
       '', 'Data_Center Data_Center_Name Long_Name', 'Norwegian Meteorological Institute, Norway','',
       '', 'Data_Center Data_Center_URL', 'http://met.no/','',
       '', 'Data_Center Personnel Role', 'Data Center Contact','',
       '', 'Data_Center Personnel First_Name', 'Egil','',
       '', 'Data_Center Personnel Last_Name', 'Støren','',
       '', 'Data_Center Personnel Phone', '+4722963000','',
       '', 'Data_Center Personnel Contact_Address Address', "Norwegian Meteorological Institute\nP.O. Box 43\nBlindern",'',
       '', 'Data_Center Personnel Contact_Address City', 'Oslo','',
       '', 'Data_Center Personnel Contact_Address Postal_Code', 'N-0313','',
       '', 'Data_Center Personnel Contact_Address Country', 'Norway','',
       'references', 'Reference', '','',
       'abstract', 'Summary Abstract', '','Not Available',
       'dataref 99', '*Related_URL URL_Content_Type Type', 'VIEW RELATED INFORMATION','', # URLs should appear here according to GCMD
       'dataref 1', 'Related_URL URL', '','', # URLs should appear here according to GCMD
       'gtsFileIdentifier 1', '*Related_URL', '', '',
       'gtsInstancePattern 1', '*Related_URL', '', '',
       '', '*IDN_Node Short_Name', 'ARCTIC/NO', '',
       '', '*IDN_Node Short_Name', 'ARCTIC', '',
       '', '*IDN_Node Short_Name', 'IPY', '',
       '', '*IDN_Node Short_Name', 'DOKIPY', '',
       '', 'Metadata_Name', 'CEOS IDN DIF','',
       '', 'Metadata_Version', '9.7','',
       '!DS_creationDate', 'DIF_Creation_Date', '','',
       '!DS_datestamp', 'Last_DIF_Revision_Date', '','',
       '', 'Private', 'False','',
    );

                   In this array, sets of four consecutive elements (starting with elements 0, 1, 2
                   and 3 on the first line) constitute the translation of one metadata item in the
                   database to one XML element in the DIF.

                   Each set comprise the following components:

                   - Name of metadata type in the database (or an empty string). This is the key
                     used to get to the value(s) in the array $record.
                   - Sequence of element names used in the DIF
                   - Constant value
                   - Default value (used if no other value exists)

                   If these four components has, for example, the following contenet:

                   'institution', 'Data_Set_Citation Dataset_Publisher', '', '',

                   and "METNO Norwegian Meteorological Institute" is the value in the database found
                   for the 'institution' metadata type, then the following text will be part of the DIF
                   XML:

                   <DIF ...>
                     ...
                     <Data_Set_Citation>
                       ...
                       <Dataset_Publisher>METNO Norwegian Meteorological Institute</Dataset_Publisher>
                       ...
                     </Data_Set_Citation>
                     ...
                   </DIF>

                   The sequence of "sets of 4 values" in the array define the sequence of the elements
                   in the DIF XML. If possible, one set will use the same higher level XML elements as
                   the previous set.

                   These points constitute the general rule, but some special rules apply:

                   - If an '!' prepends the metadata type name, the name represents a field name in the
                     Datasts table instead (but the value is still available in the $record array).
                   - If the third component in the set (the constant value) is non-empty, it is used as
                     the value in the DIF XML. The first component will then usually be empty.
                   - A number may follow the metadata type name. This indicate a spacial conversion of
                     the metadata value in the database. This conversion is implemented in the
                     get_exception.php routine.
                   - If several consecutive sets have the same metadata type name, they will appear as
                     consecutive elements in the DIF XML. When this is the case, different conversions
                     of the metatdata value will take place (indicated by a number as explained above).
                   - Several metadata values for the same metadata type and dataset, produce several
                     DIF XML elements.
                   - An asterix (*) prepending an element name in the sequence of element names will
                     force the start of a new DIF XML element at this level. (Othervise, new elements
                     will, if possible, add to an already started higher level element).
