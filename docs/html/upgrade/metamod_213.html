<html><head><title>Upgrading to METAMOD 2.13 from 2.12</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" type="text/css" title="pod_stylesheet" href="../mmdocs.css?view=co">

</head>
<body class='pod'>
<!--
  generated by Metamod::Pod::Simple::HTML vv2.0.1,
  using Pod::Simple::PullParser v3.30,
  under Perl v5.014002 at Mon Jun  1 15:09:47 2015 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Metamod::Pod::Simple::HTML, and/or subclassing Metamod::Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Metamod::Pod::Simple::HTML for advice.
   See 'perldoc Metamod::Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<div id='banner'>METAMOD Documentation | <a name='___top' href='../index.html'>main menu</a> | <a href='index.html'>upgrade</a></div>
<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#Upgrading_to_METAMOD_2.13_from_2.12'>Upgrading to METAMOD 2.13 from 2.12</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#PostgreSQL_9.1'>PostgreSQL 9.1</a>
    <li class='indexItem indexItem2'><a href='#Dependency_libraries'>Dependency libraries</a>
    <li class='indexItem indexItem2'><a href='#Static_files'>Static files</a>
    <li class='indexItem indexItem2'><a href='#Configuration'>Configuration</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#lsconf'>lsconf</a>
      <li class='indexItem indexItem3'><a href='#Deprecated_configuration_settings'>Deprecated configuration settings</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#New_WMS_features'>New WMS features</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#WMS_background_maps'>WMS background maps</a>
      <li class='indexItem indexItem3'><a href='#Dynamic_map_search'>Dynamic map search</a>
      <ul   class='indexList indexList4'>
        <li class='indexItem indexItem4'><a href='#Running_under_older_PostgreSQL_version_(8.x)'>Running under older PostgreSQL version (8.x)</a>
      </ul>
      <li class='indexItem indexItem3'><a href='#Querystring_parameters_now_permitted_in_WMS_URLs'>Querystring parameters now permitted in WMS URLs</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Validation_of_ISO_19139%2F19115_documents_in_OAI-PMH'>Validation of ISO 19139/19115 documents in OAI-PMH</a>
    <li class='indexItem indexItem2'><a href='#New_operations_on_datasets_((2.13.13%2B)'>New operations on datasets ((2.13.13+)</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#get_dataref.pl'>get_dataref.pl</a>
      <li class='indexItem indexItem3'><a href='#Importing_data'>Importing data</a>
      <li class='indexItem indexItem3'><a href='#Consolidated_transform_and_timeseries_plot%2Fdownload'>Consolidated transform and timeseries plot/download</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Upgrading_to_METAMOD_2.13_from_2.12"
>Upgrading to METAMOD 2.13 from 2.12</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="PostgreSQL_9.1"
>PostgreSQL 9.1</a></h2>

<p>METAMOD now supports initializing databases on servers running PostgreSQL 9.1.
Previous versions only supported running v.9 clients against v.8 servers.</p>

<p>Support for PostgreSQL 8.2 and earlier have been disabled to avoid unneccessary errors,
but may be reenabled by editing <em>base/init/createdb.sh</em> (ca.
line 80).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Dependency_libraries"
>Dependency libraries</a></h2>

<p>Metamod now contains all necessary Perl dependencies included in the Debian package.
The previous <em>metno-perl-webdev-ver1</em> package will no longer work since METAMOD 2.13 now requires Catalyst 5.9.</p>

<p>If installing from source,
you must build the necessary Perl modules yourself,
preferably in a local lib using Carton.
See <a href="./../installation.html?view=co" class="podlinkpod"
>Installation</a> for details.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Static_files"
>Static files</a></h2>

<p>Serving of static files via Apache has been re-enabled.
Apache now looks for each file first in the custom/static application directory,
defaulting if not present to the installation directory.
<b>Note that mod_rewrite now must be enabled in Apache for METAMOD to function correctly.</b></p>

<pre>  $ sudo a2enmod rewrite
  $ sudo service apache restart</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Configuration"
>Configuration</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="lsconf"
>lsconf</a></h3>

<p>A new utility <code>lsconf</code> has been added to check current configuration settings:</p>

<pre>  $ ./lsconf [--config &#60;config file or dir&#62;] [--split] [&#60;variable&#62;]</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Deprecated_configuration_settings"
>Deprecated configuration settings</a></h3>

<p>The following directives have been deprecated and should be removed from <em>master_config.txt</em> (they are now defined in <em>default_config.txt</em> and only used in case <code>WMS_MAPS</code> should happen to be unset):</p>

<dl>
<dt><a name="WMS_BACKGROUND_MAPSERVER"
>WMS_BACKGROUND_MAPSERVER</a></dt>

<dd>
<dt><a name="WMS_NORTHPOLE_MAP"
>WMS_NORTHPOLE_MAP</a></dt>

<dd>
<dt><a name="WMS_SOUTHPOLE_MAP"
>WMS_SOUTHPOLE_MAP</a></dt>

<dd>
<dt><a name="WMS_WORLD_MAP"
>WMS_WORLD_MAP</a></dt>
</dl>

<p>In addition, <code>CATALYST_LIB</code> is now automatically computed and should be unset in <em>master_config.txt</em>, unless your dependencies are located somewhere else than in the METAMOD tree.</p>

<p>To check that your configuration is valid, run <code>lsconf --check</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="New_WMS_features"
>New WMS features</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="WMS_background_maps"
>WMS background maps</a></h3>

<p>The WMS background map configuration, which due to technical difficulties was hardcoded in earlier versions is now fully configurable. In addition, several WMS maps have been made available as a public service and are ready configured in <em>default_config.txt</em>:</p>

<pre>  WMS_MAPS =
      EPSG:32661  http://public-wms.met.no/backgroundmaps/northpole.map
      EPSG:32761  http://public-wms.met.no/backgroundmaps/southpole.map
      EPSG:4326   http://public-wms.met.no/backgroundmaps/world.map
      EPSG:3408   http://public-wms.met.no/backgroundmaps/northpole.map
      EPSG:3409   http://public-wms.met.no/backgroundmaps/southpole.map
      EPSG:3410   http://public-wms.met.no/backgroundmaps/world.map
      EPSG:3411   http://public-wms.met.no/backgroundmaps/northpole.map
      EPSG:3412   http://public-wms.met.no/backgroundmaps/southpole.map
      EPSG:3413   http://public-wms.met.no/backgroundmaps/northpole.map
      EPSG:3995   http://public-wms.met.no/backgroundmaps/northpole.map
      EPSG:3031   http://public-wms.met.no/backgroundmaps/southpole.map
      EPSG:32633  http://public-wms.met.no/backgroundmaps/world.map</pre>

<p>To replace or extend this list, copy the whole directive to <em>master_config.txt</em> and edit as desired.</p>

<p>Names and bounding boxes are also defined in <em>default_config.txt</em> under <code>WMS_PROJECTIONS</code> and <code>WMS_BOUNDING_BOXES</code>, but may be overridden in <em>master_config.txt</em>.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Dynamic_map_search"
>Dynamic map search</a></h3>

<p>The static maps in the search interface for the non-standard projections EPSG:93031 and 93995 have now been deprecated, in favour of dynamic WMS maps. These will automatically be enabled if any of your search projections (defined in <code>SRID_ID_COLUMNS</code>) have a corresponding URL defined in <code>WMS_MAPS</code> as described above.</p>

<p>From 2.13 the default <code>SRID_ID_COLUMNS</code> are:</p>

<pre>  SRID_ID_COLUMNS = 93995 93031 3995 3031 4326</pre>

<p>The first two are only used for stored searches. The last three are available for dynamic map search using the maps at public-wms.met.no.</p>

<p>To enable new SRIDs you need to re-initialize the metadata database and re-import all datasets (preferably by running <code>base/init/create_and_load_all.sh</code>). <b>Make sure to remove/edit any <code>SRID_ID_COLUMNS</code> in <em>master_config.txt</em> so it doesn&#39;t override the default configuration.</b></p>

<p>Since it is not possible to mix static and dynamic maps (and the previous projections EPSG:93031 and 93995 are difficult to support in WMS) you must set up WMS maps for all the additional SRIDS you want to support searching in. Existing stored searches (as in Subscriptions) will continue to run as long as the projections are included in <code>SRID_ID_COLUMNS</code>, but they cannot be edited.</p>

<h4><a class='u' href='#___top' title='click to go to top of document'
name="Running_under_older_PostgreSQL_version_(8.x)"
>Running under older PostgreSQL version (8.x)</a></h4>

<p>WMS map search is officially only supported using PostgreSQL 9.x. For older versions, make sure the new SRIDs are supported in your current version of PostGIS:</p>

<pre>  # select auth_srid from spatial_ref_sys where auth_name=&#39;EPSG&#39; and auth_srid in(3995, 3031, 4326);
   auth_srid
  -----------
        4326
        3031
        3995
  (3 rows)</pre>

<p>In case any of these projections are missing you must either install support for them using data from <a href="http://spatialreference.org/" class="podlinkurl"
>spatialreference.org</a> or remove them from <code>SRID_ID_COLUMNS</code>, otherwise <code>create_and_load_all.sh</code> will probably fail.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Querystring_parameters_now_permitted_in_WMS_URLs"
>Querystring parameters now permitted in WMS URLs</a></h3>

<p>Whereas METAMOD 2.12 and earlier only allowed WMS URLs of the form <code>http://domain/path</code>, in 2.13 you can now use <code>http://domain/path?param=value</code> which is needed in some cases. However this also means a stricter conformation to the WMS standard, which requires all WMS URLS to contain the query string separator <i>&#34;?&#34;</i> somewhere in the string (at the end in most cases). This should be updated in the XML/XMD files and the database.</p>

<p><b>Note:</b> While METAMOD in some cases can work around missing <i>&#34;?&#34;</i>s, this is by no means universal and old URLs (particularly when used in XSLT or for thumbnails) are not guaranteed to work. The command <code>lsds --wms</code> can be helpful here.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Validation_of_ISO_19139/19115_documents_in_OAI-PMH"
>Validation of ISO 19139/19115 documents in OAI-PMH</a></h2>

<p>Due to a bug in libxml2 2.7.8 and earlier, validation of ISO files is not possible and has been disabled in METAMOD. To enable this under Precise you need to compile 2.9.1 from source and install in a custom location:</p>

<pre>  $ wget ftp://xmlsoft.org/libxml2/libxml2-2.9.1.tar.gz
  $ tar xfvz libxml2-2.9.1.tar.gz
  $ cd libxml2-2.9.1/
  $ ./configure --prefix=/opt/local --without-python
  $ make &#38;&#38; sudo make install</pre>

<p>After this is done you can add an external validation script in master_config:</p>

<p>PMH_LOCAL_VALIDATION = iso19115 &#39;/opt/local/bin/xmllint --noout --schema [SCHEMA] [FILE]&#39; iso19139 &#39;/opt/local/bin/xmllint --noout --schema [SCHEMA] [FILE]&#39;</p>

<p>From Ubuntu 14.4, ISO validation will be handled normally in METAMOD without the need for external validators.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="New_operations_on_datasets_((2.13.13+)"
>New operations on datasets ((2.13.13+)</a></h2>

<p>The download, transformation and timeseries functionality has been improved; however this necessitates editing and re-importating dataset XML files. The following fields are currently supported, with more to come later:</p>

<dl>
<dt><a name="dataref_OPENDAP"
>dataref_OPENDAP</a></dt>

<dd>
<dt><a name="dataref_HTTPServer"
>dataref_HTTPServer</a></dt>

<dd>
<dt><a name="dataref_WMS_(experimental,_not_yet_implemented)"
>dataref_WMS (experimental, not yet implemented)</a></dt>
</dl>

<p>In addition, the projectionInfo section in XMD is no longer used for transformation/reprojection and can usually be removed. It is currently only required for the /search/fimexdownload subservice, which does not seem to be in general use anymore.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="get_dataref.pl"
>get_dataref.pl</a></h3>

<p>To help insert datarefs into the XML files, there is now a script which can communicate with THREDDS and insert the dataref elements automatically. See the script documentation for details (get_dataref.pl --help).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Importing_data"
>Importing data</a></h3>

<p>To enable the new features, use the following procedure:</p>

<ol>
<li>Update searchdata.xml with new dataref_* elements (only necessary if not using app/default)</li>

<li>Run import_searchdata.pl to reload database</li>

<li>Update XML files with dataref_* elements (see get_dataref.pl for help)</li>

<li>Re-import XML files using import_dataset.pl</li>
</ol>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Consolidated_transform_and_timeseries_plot/download"
>Consolidated transform and timeseries plot/download</a></h3>

<p>These functions have now been merged, and the <code>timeseries</code> variable is no longer needed in the MM2 file. However, this feature is considered experimental for the time being. To enable it, set CONSOLIDATE_TRANSFORM_FUNCTIONS to true in <em>master_config.txt</em>.</p>

<!-- end doc -->

</body></html>
