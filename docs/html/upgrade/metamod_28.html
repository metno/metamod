<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Upgrading to METAMOD 2.8</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<body style="background-color: white">


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#upgrading_to_metamod_2_8">Upgrading to METAMOD 2.8</a></li>
	<ul>

		<li><a href="#from_version_2_7">From version 2.7</a></li>
		<li><a href="#from_version_2_6">From version 2.6</a></li>
		<ul>

			<li><a href="#staticdata">Staticdata</a></li>
			<li><a href="#master_configuration">Master configuration</a></li>
			<li><a href="#database">Database</a></li>
			<li><a href="#xml_metadata_files">XML metadata files</a></li>
			<li><a href="#installation">Installation</a></li>
			<li><a href="#starting_and_testing">Starting and testing</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->

<p>
</p>
<h1><a name="upgrading_to_metamod_2_8">Upgrading to METAMOD 2.8</a></h1>
<p>
</p>
<h2><a name="from_version_2_7">From version 2.7</a></h2>
<p>METAMOD 2.7 was an internal release only, using Catalyst for the search interface.
Upgrading is mostly the same as 2.6.</p>
<p>
</p>
<h2><a name="from_version_2_6">From version 2.6</a></h2>
<p>
</p>
<h3><a name="staticdata">Staticdata</a></h3>
<dl>
<dt><strong><a name="staticdata_searchdata_xml" class="item">staticdata/searchdata.xml</a></strong></dt>

<dd>
<p>All &lt;sc id=“x” type=“x”…&gt; have change to &lt;sc id=“1” idname=“activity_types” type=“basickey”…&gt; (named ids + named rather than numeric types), see app/example for names and types.</p>
<p>Add dataset_file_location and dataset_file_size (see app/example):</p>
<pre>
  &lt;mt name=&quot;data_file_location&quot; share=&quot;FALSE&quot;
   def=&quot;The location of the dataset on disk. Only for level 2 datasets&quot; /&gt;
  &lt;mt name=&quot;data_file_size&quot; share=&quot;FALSE&quot;
   def=&quot;The size of the file in bytes. Only for level 2 datasets&quot; /&gt;</pre>
</dd>
</dl>
<p>
</p>
<h3><a name="master_configuration">Master configuration</a></h3>
<p>There are several new directives which must be set in master_config. Some examples:</p>
<pre>
    APPLICATION_USER - owner of webrun directory and Apache/Catalyst processes
    CATALYST_PORT    - run Catalyst on this port (normally 3000)
    PG_CONTRIB       - Directory for PostgreSQL contrib libs
    LDAP_SERVER      - LDAP server used for authentication
    LDAP_BASE_DN     - base DN for LDAP
    PMH_SYNCHRONIZE_ISO_IDENTIFIER - make OAI-PMH identifier the same as ISO-identifier
    APPLICATION_USER</pre>
<pre>
    WMS_BACKGROUND_MAPSERVER - URL to background map server delivering coastlines and reticules
    WMS_NORTHPOLE_MAP - map names for different projections
    WMS_SOUTHPOLE_MAP - &quot; &quot;
    WMS_WORLD_MAP     - &quot; &quot;</pre>
<p>Site-specific texts are no longer configured in master_config, but instead
in a custom Template Toolkit file (applic/custom/templates/custom.tt). Custom
images and CSS styles are similarly specified in applic/custom/static. Note that
applic/filelist.txt must be updated for the files being copied to target. This
concerns the following directives</p>
<pre>
    APP_HEADER_HTML
    APP_FOOTER_HTML
    SEARCH_APP_NAME
    SEARCH_APP_TITLE
    SEARCH_APP_HEADER_HTML
    SEARCH_APP_DESCRIPTION
    SEARCH_APP_PRESENTATION_HTML
    UPLOAD_APP_TITLE
    UPLOAD_APP_LOGIN_TEXT
    UPLOAD_APP_INLOGGED_TEXT
    UPLOAD_APP_COMMON_TEXT
    QUEST_TITLE
    QUEST_FORM_DEFINITON_FILE
    QUEST_METADATA_UPLOAD_FORM
    QUEST_SENDER_ADDRESS
    QUEST_RECIPIENTS
    QUEST_OKMESSAGE
    QUEST_ADM_BACKGROUND
    QUEST_ADM_TOPDIR</pre>
<p>The following other directives are also no longer in use and should be removed:</p>
<pre>
    ADMIN_DOMAIN
    ADMIN_WEBUSER
    CATALINA_HOME
    CATALYST_SITE_CONFIG
    WMS_URL
    WMS_ONLINE_RESOURCE
    METADATA_SEARCH_URL
    UPLOAD_URL</pre>
<p>SEARCH_CATEGORY_SEQUENCE must now use the alphabetical idnames from searchdata.xml
(as modified in previous section) instead of numeric ids. Also, remove dataref
from SEARCH_APP_SHOW_COLUMNS.</p>
<p>APP_MENU should no longer include links to the standard sections of the site
(METADATA_SEARCH_URL, UPLOAD_URL) since these are now generated by Catalyst.
See app/example for more information.</p>
<p>
</p>
<h3><a name="database">Database</a></h3>
<p>Some minor changes to the metadata database. Suggest recreating the database
and reimporting the metadata files:</p>
<pre>
  cd target/init
  ./create_and_load_all.sh</pre>
<p>The userdatabase has been extensively modified, including support for login roles and
SHA1-hashed passwords. Upgrade by running this script:</p>
<pre>
  target/userinit/upgradeuserdb_26-28.sh</pre>
<p>
</p>
<h3><a name="xml_metadata_files">XML metadata files</a></h3>
<p>The XML files must be updated to include the attribute 'data_file_location',
otherwise collection basket will not work. To update, run the script
write_data_file_location.pl against the XML file directory, making sure
you have access to the data files (NetCDF) since they must be read simultaneously.</p>
<p>
</p>
<h3><a name="installation">Installation</a></h3>
<p>Generation of Apache config and init scripts are now fully automated. After running
update_target.pl you will find the following files in your target directory:</p>
<dl>
<dt><strong><a name="etc_httpd_conf" class="item">etc/httpd.conf</a></strong></dt>

<dd>
<p>Apache configuration, destined either for /etc/apache2/sites-available (if using DNS-based virtual hosts)
or /etc/apache2/conf.d (otherwise).</p>
</dd>
<dt><strong><a name="etc_init_d_catalyst_myapp" class="item">etc/init.d/catalyst-myapp</a></strong></dt>

<dd>
<p>Init.d script to start/stop Catalyst.</p>
</dd>
<dt><strong><a name="metamodinit_sh" class="item">metamodInit.sh</a></strong></dt>

<dd>
<p>Script to start/stop the main METAMOD services.</p>
</dd>
</dl>
<p>To install these scripts systemwide, run install_jobs.sh from the target directory.
You will need sudo permissions to execute it properly (the sudo commands are inside the script).
This will place the following symlinks to the target directory:</p>
<dl>
<dt><strong><a name="etc_" class="item">etc/apache2/conf.d/APPLICATION_ID</a></strong></dt>

<dt><strong>etc/apache2/sites-available/APPLICATION_ID</strong></dt>

<dd>
<p>Apache configuration, using either URL-based or DNS-based hosting. For the latter
it will also run a2ensite to enable it.</p>
</dd>
<dt><strong><a name="etc_init_d_catalyst_application_id" class="item">/etc/init.d/catalyst-APPLICATION_ID</a></strong></dt>

<dd>
<p>Init.d script to start/stop Catalyst.</p>
</dd>
<dt><strong><a name="etc_init_d_metamodservices_application_id" class="item">/etc/init.d/metamodServices-APPLICATION_ID</a></strong></dt>

<dd>
<p>Actually not a symlink, but a one-line script to run metamodInit.sh as the correct user.</p>
</dd>
</dl>
<p><strong>Note:</strong> The configuration system is designed to work on a freshly installed Linux.
Take care if you have already configured a site manually that it will not
conflict with the newly generated config. Installation will abort if there are existing files in /etc
with the same names. However, it is still possible if you have configured Apache manually
in /etc/apache2/sites-enabled/default that the new directives in conf.d will never be applied.
If so please remove your manual configuration to see if METAMOD will run, then reapply your
custom config one bit at a time.</p>
<p>
</p>
<h3><a name="starting_and_testing">Starting and testing</a></h3>
<p>See the Deploying manual on how to start/stop METAMOD.</p>

</body>

</html>
