<html><head><title>Deploying a METAMOD application</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
</head>
<body class='pod'>
<!--
  generated by Metamod::Pod::Simple::HTML v,
  using Pod::Simple::PullParser v2.02,
  under Perl v5.010001 at Wed Feb  1 14:37:00 2012 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Metamod::Pod::Simple::HTML, and/or subclassing Metamod::Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Metamod::Pod::Simple::HTML for advice.
   See 'perldoc Metamod::Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<a name='___top' class='dummyTopAnchor' ></a>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#Deploying_a_METAMOD_application'>Deploying a METAMOD application</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Creating_the_webrun_directory'>Creating the webrun directory</a>
    <li class='indexItem indexItem2'><a href='#Installing_services'>Installing services</a>
    <li class='indexItem indexItem2'><a href='#Activating_environment_(optional)'>Activating environment (optional)</a>
    <li class='indexItem indexItem2'><a href='#Initializing_the_BASE_module'>Initializing the BASE module</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Authentication_(FIXME)'>Authentication (FIXME)</a>
      <li class='indexItem indexItem3'><a href='#Creating_databases'>Creating databases</a>
      <li class='indexItem indexItem3'><a href='#Email_configuration_(FIXME)'>Email configuration (FIXME)</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Starting_METAMOD'>Starting METAMOD</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Catalyst_daemon'>Catalyst daemon</a>
      <li class='indexItem indexItem3'><a href='#Apache'>Apache</a>
      <li class='indexItem indexItem3'><a href='#METAMOD_services'>METAMOD services</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#TESTING_(OBSOLETE_-_FIXME)'>TESTING (OBSOLETE - FIXME)</a>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Deploying_a_METAMOD_application"
>Deploying a METAMOD application</a></h1>

<p>Before you can deploy a METAMOD application you must set up a configuration directory,
see <a href="./configuration.html" class="podlinkpod"
>METAMOD Configuration</a>.</p>

<p>After the initial configuration has been completed,
a number of scripts must be run before the application is up and running.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Creating_the_webrun_directory"
>Creating the webrun directory</a></h2>

<p>The application also needs several directories to store files during operation.
Run the script</p>

<pre>  prepare_runtime_env.sh &#60;config&#62;</pre>

<p>which will initialize a runtime directory used by the application for logging, temporary files etc. owned by the APPLICATION_USER user. If already existing nothing will be deleted, although file ownership may be updated to the current configuration. (Note that if your current user does not have write privileges to WEBRUN_DIRECTORY this script will fail.)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Installing_services"
>Installing services</a></h2>

<p>After installation of the software and one or more configurations, you should now install the application services where the operating system can find it. Currently only Debian-based Linux systems are supported.</p>

<p>This script will create an Apache configuration file, as well as init.d scripts for automatic starting and stopping of Catalyst and the various METAMOD services for the specific application. These files will be placed in in &#60;configuration dir&#62;/etc, and then symlinked into /etc/apache2 and /etc/init.d.</p>

<pre>  install_jobs.sh &#60;config&#62;</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Activating_environment_(optional)"
>Activating environment (optional)</a></h2>

<p>To make it easier to run commandline scripts you can use the bash script activate_env that sets the correct environment variables. All commands also run without this command, but you must then specify the correct paths, configuration directory and PERL5LIB for all commands.</p>

<p>From anywhere execute the following command:</p>

<pre>  $ source /opt/metno-metamod-&#60;version&#62;/activate_env &#60;PATH TO CONFIGURATION DIR&#62;</pre>

<p>This will enable the correct environment. To disable the environment again execute</p>

<pre>  $ source /opt/metno-metamod-&#60;version&#62;/activate_env deactivate</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Initializing_the_BASE_module"
>Initializing the BASE module</a></h2>

<p>At this point, the deployment of the application is complete for all instances not using the BASE module. For an application using the BASE module, a few steps remains:</p>

<p>As explained in the <b>Data base</b> paragraph, several METAMOD applications may co-operate in a cluster, and share a common data base. One of these applications must use the BASE module, and no other. The last steps (described below) required for the base application must be done after the initial steps (described above), for all applications in the cluster, are completed.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Authentication_(FIXME)"
>Authentication (FIXME)</a></h3>

<p>Change local ident to trust in pg_hba.conf:</p>

<pre>    $ $EDITOR /etc/postgresql/8.4/main/pg_hba.conf
    change local ident to trust

    # Database administrative login by UNIX sockets
    local   all         postgres                          ident sameuser

    # TYPE  DATABASE    USER        CIDR-ADDRESS          METHOD

    # &#34;local&#34; is for Unix domain socket connections only
    #local   all         all                              ident sameuser
    local   all         all                               trust
    # IPv4 local connections:
    host    all         all         127.0.0.1/32          trust
    host    all         all         157.249.0.1/16        trust
    # IPv6 local connections:
    host    all         all         ::1/128               md5</pre>

<p>Then restart PostgreSQL:</p>

<pre>    /etc/init.d/postgresql stop
    /etc/init.d/postgresql start</pre>

<p>Alternatively, use .pgpass (FIXME)</p>

<p>Do not use PG_CONNECTSTRING_SHELL for shell connections to localhost (use sockets instead).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Creating_databases"
>Creating databases</a></h3>

<p>The two PostgreSQL databases used by the cluster must be initialized. Note that the two databases are operated through two database users. The name of these users are found in the <code>master_config.txt</code> file as the value of PG_ADMIN_USER and PG_WEB_USER configuration variables. These users must be defined in the PostgreSQL database environment before the database initialization scripts can be run:</p>

<pre>    base/init/createusers.sh</pre>

<p>It is only necessary to run this script once for a PostgreSQL database environment.</p>

<p>The first SQL database initialization script will create the Meta database.</p>

<pre>        create_and_load_all.sh</pre>

<p>This script will create the database, and load the static content of the database (taken from <code>staticdata/searchdata.xml</code>). You may check the output of this script in the <code>create_and_load_all.out</code> file in the directory where you are running the command.</p>

<p>The next SQL database initialization script will create the User database.</p>

<pre>        run_createuserdb.sh</pre>

<p>Note that <i>this script must only be used during setup of a completely new METAMOD cluster</i>. If a User database already exists, all data in the database will be lost. If this should happen, you must recreate the database from a backup copy you hopefully have. But METAMOD will not by itself ensure that such a backup exists.</p>

<p>This warning is only adequate for the <code>run_createuserdb.sh</code> script. The other scripts in this paragraph (<code>prepare_runtime_env.sh</code>, <code>create_and_load_all.sh</code>) may all be used on an existing installation, without harming existing data. The <code>create_and_load_all.sh</code> script will take some time to complete, though. On an existing installation, all metadata in the database will be loaded from the XML archive.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Email_configuration_(FIXME)"
>Email configuration (FIXME)</a></h3>

<p>configure exim</p>

<pre>    $ sudo dpkg-reconfigure exim4-config</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Starting_METAMOD"
>Starting METAMOD</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Catalyst_daemon"
>Catalyst daemon</a></h3>

<p>Start Catalyst by running</p>

<pre>        sudo /etc/init.d/catalyst-APPLICATION_ID start</pre>

<p>Then check if METAMOD is responding (usually on port 3000, use server name if not running locally):</p>

<pre>        http://localhost:3000/</pre>

<p>If all set you should see the METAMOD search interface.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Apache"
>Apache</a></h3>

<p>If this has not already been done you need to enable the Apache proxy modules. Look in /etc/apache2/mods-enabled to see if they have already been enabled.</p>

<pre>   sudo a2enmod proxy
   sudo a2enmod proxy_http</pre>

<p>Restart Apache:</p>

<pre>        sudo apache2ctl restart</pre>

<p>or if the site is busy:</p>

<pre>        sudo apache2ctl graceful</pre>

<p>which will wait until all connections are terminated before restarting.</p>

<p>The site should now hopefully be available on</p>

<pre>        http://localhost/APPLICATION_ID</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="METAMOD_services"
>METAMOD services</a></h3>

<p>Start METAMOD:</p>

<pre>        sudo /etc/init.d/metamodServices-APPLICATION_ID start</pre>

<p>This should start the required services daemons.</p>

<p>----------------</p>

<p>Copy the example config:</p>

<pre>  $ cp -r /opt/metno-metamod-2.10/app/example .</pre>

<p>Then edit example/master_config.txt as needed. For local testing, set APPLICATION_USER to your own login.</p>

<pre>  $ /opt/metno-metamod-2.10/common/prepare_runtime_env.sh example

  $ export PERL5LIB=/opt/metno-metamod-2.10/common/lib:/opt/metno-metamod-2.10/catalyst/lib:/opt/metno-perl-webdev-ver1/lib/perl5</pre>

<p>Try starting Catalyst:</p>

<pre>  $ /opt/metno-metamod-2.10/catalyst/script/metamodweb_server.pl -d example</pre>

<p>MetamodWeb should now be available on http://localhost:3000/. Stop with ctrl-c.</p>

<p>To install all services:</p>

<pre>  $ /opt/metno-metamod-2.10/install_jobs.sh example</pre>

<p>To start all services (substitute EXAMPLE with your APPLICATION_ID):</p>

<pre>  $ sudo /etc/init.d/catalyst-EXAMPLE start
  $ sudo /etc/init.d/metamodServices-EXAMPLE start</pre>

<p>--------------------</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TESTING_(OBSOLETE_-_FIXME)"
>TESTING (OBSOLETE - FIXME)</a></h2>

<p>2. To copy the software to the target directory and make the substitutions prescribed by the master_config.txt file, do the following: cd to the source directory (i.e. this directory) run: ./update_target.pl app/example</p>

<p>3. Assuming the PostgreSQL software is already installed, the PostgreSQL users (admin and webuser) that are to access the database must be created. This step is only needed one time. PostgreSQL users are for the whole PostgreSQL installation, and not connected to specific databases. cd to the target directory run: scripts/createusers.sh</p>

<p>4. Initialize the runtime environment: cd to the target directory run: ./prepare_runtime_env.sh</p>

<p>5. Initialize the database, and load static data: cd to the target directory cd init run: ./create_and_load_all.sh You may check the output of this script in the create_and_load_all.out file in the same init directory.</p>

<p>6. Ensure that you have a working Apache 2.x installation with mod_proxy. The httpd daemon should run as the same user as the METAMOD 2.x perl scripts. Otherwise problems with access rights to files in the webrun directory will arise. These problems could be solved by using &#39;umask&#39; and similar tools, but the METAMOD 2.x software is not prepared for this. The Apache installation must allow .htaccess files and softlinks.</p>

<p>7. Make the METAMOD 2.x URLs accessible through the Apache server. This can either be done by making the METAMOD 2.x htdocs directory the Apache 2.x DocumentRoot directory. Otherwise, this can be done by providing a symbolic link in the Apache 2.x DocumentRoot directory to the METAMOD 2.x htdocs directory. This symbolic link must agree with the LOCAL_URL set up in the master_config.txt file.</p>

<p>8. At this time all the web applications should work. Confirm this by visiting the URLs for the two main web pages in the example application (METAMODSEARCH and METAMODUPLOAD) from a browser (the URLs are found in the master_config.txt file). Check also that the administration web page is working.</p>

<p>9. Enter the METAMODUPLOAD web page from a browser and create a user account. The operator will recieve an E-mail with the user details and an URL. Activating this URL will admit the user into the system. After activating this URL, the user recieves an E-mail with a password. In the test environment, this E-mail will be sent to the operator instead.</p>

<p>10. Start the perl scripts responsible for loading data into the database: cd to the target directory run: ./metamodInit.sh start</p>

<p>11. Enter the METAMODUPLOAD web page from a browser and log into the user account you have created. Enter the &#34;Administration&#34; page and create the directory &#39;test1&#39; (this will also be the name of a new dataset that later will be loaded into the database). Go back to the &#34;Upload files&#34; page and upload the two files test1_arctic20.200611.cdl and test1_synop_99710.cdl found in the testdata directory.</p>

<p>12. After a few minutes, check that metadata from the files have been loaded into the database. This can be done by looking at the system log (path defined by the LOG4ALL_SYSTEM_LOG variable in master_config.txt), and by entering the METAMODSEARCH web page and search for the data.</p>

<p>13. Do a similar exercise with the files test2_arctic20.200611.cdl and test2_synop_99710.cdl. A new directory/dataset has to be created for these files in the administration page: &#39;test2&#39;. These files do not satisfy the requirements specified in the etc/conf_digest_nc.xml file. The perl script digesting these files will generate an error report that will be accessible from the METAMODUPLOAD web page. Also, the data provider will be sent an E-mail with a reference to this error report. In the test environment, this E-mail will be sent to the operator instead.</p>

<p>14. Stop the perl scripts responsible for loading data into the database: cd to the target directory run: ./metamodInit.sh stop</p>

<!-- end doc -->

</body></html>
