<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Deploying METAMOD</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<body style="background-color: white">


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#deploying_metamod">Deploying METAMOD</a></li>
	<ul>

		<li><a href="#introduction">Introduction</a></li>
		<li><a href="#data_base">Data base</a></li>
		<li><a href="#metamod_functional_modules">METAMOD functional modules</a></li>
		<li><a href="#directory_structure">Directory structure</a></li>
		<li><a href="#metamod_configuration">METAMOD configuration</a></li>
		<ul>

			<li><a href="#master_config_txt">master_config.txt</a></li>
			<li><a href="#metadata_configuration">Metadata configuration</a></li>
			<li><a href="#stylesheets_and_other_web_configuration">Stylesheets and other web configuration</a></li>
			<li><a href="#overriding_texts">Overriding texts</a></li>
			<li><a href="#overriding_the_css">Overriding the CSS</a></li>
			<li><a href="#path_to_images">Path to images</a></li>
		</ul>

		<li><a href="#deploying_a_metamod_application">Deploying a METAMOD application</a></li>
		<ul>

			<li><a href="#activating_environment">Activating environment</a></li>
			<li><a href="#generate_apache_config_for_the_site">Generate Apache config for the site</a></li>
			<li><a href="#generate_init_d_scripts">Generate init.d scripts</a></li>
			<li><a href="#creating_the_webrun_directory">Creating the webrun directory</a></li>
			<li><a href="#installing_services">Installing services</a></li>
			<li><a href="#initializing_the_base_module">Initializing the BASE module</a></li>
		</ul>

		<li><a href="#starting_metamod">Starting METAMOD</a></li>
		<ul>

			<li><a href="#catalyst_daemon">Catalyst daemon</a></li>
			<li><a href="#apache">Apache</a></li>
			<li><a href="#metamod_services">METAMOD services</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->

<p>
</p>
<h1><a name="deploying_metamod">Deploying METAMOD</a></h1>
<p>
</p>
<h2><a name="introduction">Introduction</a></h2>
<p>This document assumes that the basic METAMOD software are working on the various servers where METAMOD
are intended to run.  How to achieve this is described in a separate document: ... The current document
describes how to use the software to create a cluster of one or more co-operating METAMOD applications
(or METAMOD instances).</p>
<p>
</p>
<h2><a name="data_base">Data base</a></h2>
<p>All the METAMOD instances in a cluster share a common data base. This data base is divided into the
following parts:</p>
<dl>
<dt><strong><a name="metadatabase" class="item"><strong>Metadatabase</strong></a></strong></dt>

<dd>
<p>SQL Database for Metadata</p>
</dd>
<dt><strong><a name="user_database" class="item"><strong>User database</strong></a></strong></dt>

<dd>
<p>SQL Database for User administration</p>
</dd>
<dt><strong><a name="xml_archive" class="item"><strong>XML archive</strong></a></strong></dt>

<dd>
<p>Metadata file archive based on XML</p>
</dd>
<dt><strong><a name="data_repository" class="item"><strong>Data repository</strong></a></strong></dt>

<dd>
<p>Archive of netCDF files</p>
</dd>
</dl>
<p>One of the METAMOD applications in a cluster is responsible for the SQL databases. Initialization and
administration of the SQL databases are done through this application, which is called the <em>base</em>
application.</p>
<p>Although the METAMOD instances in a cluster may operate on different servers, they must share a common
file system where the XML archive and the Data repository resides. Technically they may reside on
different file systems, but for each file, the file paths on the various servers must be the same.
Furthermore, for a smooth operation, the clocks on all the involved servers must be synchronized.</p>
<p>The SQL databases may reside on a separate server, different from any of the servers where
the METAMOD instances run.</p>
<p>
</p>
<h2><a name="metamod_functional_modules">METAMOD functional modules</a></h2>
<p>The METAMOD software comprise a broad range of functionality. The software is divided into different
<strong>modules</strong>, each representing a separate set of related functionality. One such module is the BASE module,
which is used in the base application described above. A METAMOD instance may use any combination of
modules. The only restriction is that one and only one application in a cluster must use the BASE
module.</p>
<p>The METAMOD software comprise the following modules:</p>
<dl>
<dt><strong><a name="base" class="item">BASE</a></strong></dt>

<dd>
<p>Responsibility for the SQL databases.</p>
</dd>
<dt><strong><a name="search" class="item">SEARCH</a></strong></dt>

<dd>
<p>Web interface for searching a part of the database for metadata.</p>
</dd>
<dt><strong><a name="upload" class="item">UPLOAD</a></strong></dt>

<dd>
<p>Web interface and scripts for uploading (or registering) netCDF files and for editing metadata.</p>
</dd>
<dt><strong><a name="harvest" class="item">HARVEST</a></strong></dt>

<dd>
<p>Module for harvesting metadata from internet servers offering OAI-PMH support.</p>
</dd>
<dt><strong><a name="pmh" class="item">PMH</a></strong></dt>

<dd>
<p>OAI-PMH provider. See <a href="http://www.openarchives.org/.">http://www.openarchives.org/.</a></p>
</dd>
<dt><strong><a name="thredds" class="item">THREDDS</a></strong></dt>

<dd>
<p>Used for automatic building of THREDDS catalogs that may be utilized by a THREDDS Data Server to
access the data repository.</p>
</dd>
</dl>
<p><strong>Note:</strong> SEARCH, PMH and UPLOAD are now integrated with Catalyst and will always be installed (however
you are free not to start it).</p>
<p>
</p>
<h2><a name="directory_structure">Directory structure</a></h2>
<p>On each server where METAMOD should run, the generic METAMOD software must be available in some directory.
If you installed METAMOD using a met.no Debian package it will be located in /opt/metamod-&lt;version&gt;.
In the description below, this directory is called the <strong>installation</strong> directory.</p>
<p>In addition to the generic installation directory you need a configuration
directory. This directory contains configuration files, style sheets etc., and
also files regulating metadata requirements. An example application configuration
directory is included in the generic installation directory (the <code>app/example</code>
subdirectory of the installation directory).</p>
<p>The main subdirectories of the generic installation directory are:</p>
<dl>
<dt><strong><a name="base" class="item">base</a></strong></dt>

<dd>
<p>Files only used in the BASE module</p>
</dd>
<dt><strong><a name="upload" class="item">upload</a></strong></dt>

<dd>
<p>Files only used in the UPLOAD module</p>
</dd>
<dt><strong><a name="harvest" class="item">harvest</a></strong></dt>

<dd>
<p>Files only used in the HARVEST module</p>
</dd>
<dt><strong><a name="thredds" class="item">thredds</a></strong></dt>

<dd>
<p>Files only used in the THREDDS module</p>
</dd>
<dt><strong><a name="common" class="item">common</a></strong></dt>

<dd>
<p>Files used by several modules</p>
</dd>
<dt><strong><a name="catalyst" class="item">catalyst</a></strong></dt>

<dd>
<p>Perl Catalyst framework files used for web content generation inside several modules</p>
</dd>
<dt><strong><a name="app" class="item">app</a></strong></dt>

<dd>
<p>Contains the example application source directory</p>
</dd>
<dt><strong><a name="docs" class="item">docs</a></strong></dt>

<dd>
<p>METAMOD documentation directory</p>
</dd>
</dl>
<p>The module directories (base, search, upload, harvest, pmh, thredds) and also the common directory
(which in the following is implicitly included among the module directories),
all have a similar set of subdirectories:</p>
<dl>
<dt><strong><a name="etc" class="item">etc</a></strong></dt>

<dt><strong><a name="scripts" class="item">scripts</a></strong></dt>

<dt><strong><a name="htdocs" class="item">htdocs</a></strong></dt>

<dt><strong><a name="lib" class="item">lib</a></strong></dt>

<dt><strong><a name="schema" class="item">schema</a></strong></dt>

<dt><strong><a name="init" class="item">init</a></strong></dt>

<dt><strong><a name="userinit" class="item">userinit</a></strong></dt>

<dt><strong><a name="staticdata" class="item">staticdata</a></strong></dt>

</dl>
<p>A module directory will not contain all of these subdirectories. Some subdirectories are only
found in one module directory.</p>
<p>
</p>
<h2><a name="metamod_configuration">METAMOD configuration</a></h2>
<p>
</p>
<h3><a name="master_config_txt">master_config.txt</a></h3>
<p>The application configuration directory contains a very important file, the <strong>master_config.txt</strong> file. This file
governs how METAMOD will run.</p>
<p>The master_config.txt file is a text file containing lines as follows:</p>
<pre>
   VARNAME = VALUE</pre>
<p>'VARNAME' must start from the first character on the line, and be all uppercase letters [A-Z], underscore
or digits. Any number of white space characters may separate 'VARNAME' and '=', and also '=' and
'VALUE'. 'VALUE' starts with the first non-whitespace character and ends with
the last non-whitespace character on the line. Additional lines may be
appended to 'VALUE' immediately after the initial 'VARNAME = ...' line. Such
lines must start with a space character. No whitespace are removed from such
appended lines.</p>
<p>A complete inventory of the variables that should be part of the master_config.txt file is found
in the <code>app/example/master_config.txt</code> file in the generic source directory.</p>
<p>
</p>
<h3><a name="metadata_configuration">Metadata configuration</a></h3>
<p>METAMOD is able to handle a large range of metadata frameworks. For metadata generated through the
UPLOAD module (by parsing netCDF files), METAMOD has defined its own XML format, called MM2. This
format has a similar structure as Dublin core; it is a flat structure with freely selected metadata
keywords. For each keyword one or more values may be found. Other metadata frameworks, like DIF or
ISO19115, are also accepted, and such frameworks will typically emerge when harvesting from other
metadata providers through OAI-PMH. While such frameworks (DIF, ISO19115) are hierarchical in nature,
a flattening of these structures takes place when they are imported to the SQL database and
presented through the METAMOD search interface.</p>
<p>The following configuration files regulate which metadata are imported to the SQL database and
available for search, how metadata imported by the HARVEST module are translated into the internal
flat structure used in the SQL database, and how metadata found in the uploaded netCDF files are
translated to MM2 XML files.</p>
<dl>
<dt><strong><a name="staticdata_searchdata_xml" class="item">staticdata/searchdata.xml</a></strong></dt>

<dd>
<p>This XML file contains metadata vocabularies that are imported into the SQL database, and used
in the SEARCH module for setting up the interactive forms for web users searching the database.</p>
</dd>
<dt><strong><a name="etc_conf_digest_nc_xml" class="item">etc/conf_digest_nc.xml</a></strong></dt>

<dd>
<p>This XML file describes the parsing of netCDF files in the UPLOAD module. Specifically how
attributes and variable values in a netCDF file are translated into keyword - value pairs
and stored into an MM2 XML file. The <code>conf_digest_nc.xml</code> file will contain rules regarding which
metadata are required in the netCDF files. The <code>app/example/etc/conf_digest_nc.xml</code> file
represents a well commented example of such a file that can be used as a starting point for a
version tailored to specific needs.</p>
</dd>
<dt><strong><a name="etc_usererrors_conf" class="item">etc/usererrors.conf</a></strong></dt>

<dd>
<p>This file contain html templates that are used in error reports sent to data providers that have
uploaded netCDF files using the UPLOAD module. Each template corresponds to an error condition
defined in the etc/conf_digest_nc.xml file. An example file in the <code>app/example/etc</code> directory
corresponds to the <code>conf_digest_nc.xml</code> in the same directory.</p>
</dd>
<dt><strong><a name="xslt" class="item">XSLT</a></strong></dt>

<dd>
<p>Files for translating from foreign metadata formats (... more text is needed)</p>
</dd>
</dl>
<p>
</p>
<h3><a name="stylesheets_and_other_web_configuration">Stylesheets and other web configuration</a></h3>
<p>METAMOD can be configured with custom texts and stylesheets. To modify the
styles of the application add the following directories to your application
configuration directory.</p>
<dl>
<dt><strong><a name="custom_templates" class="item">custom/templates</a></strong></dt>

<dd>
<p>This directory contains the Template::Toolkit templates that you want to
override in your configuration. It is generally never a good idea to override
anything other than the <a href="#custom_tt"><code>custom.tt</code></a> file.</p>
</dd>
<dt><strong><a name="custom_" class="item">custom/static/css</a></strong></dt>

<dd>
<p>This directory contains the CSS files that you want to override in your
configuration. It is generally never a good idea to override anything but the
<a href="#custom_css"><code>custom.css</code></a> file in this folder.</p>
</dd>
<dt><strong>custom/static/images</strong></dt>

<dd>
<p>This folder contains the images that you use in your style configuration.</p>
</dd>
</dl>
<p>
</p>
<h3><a name="overriding_texts">Overriding texts</a></h3>
<p>To override texts in the application you use the <a href="#custom_tt"><code>custom.tt</code></a> file.
<a href="#custom_tt"><code>custom.tt</code></a> is a file in <code>Template::Toolkit</code> format.</p>
<p>The way it is used is that it re-defines the default texts found in
<code>defaults.tt</code>.</p>
<p>For instance the following would re-define the HTML used for the header of the
application.</p>
<pre>
  [%</pre>
<pre>
    # get a safe path to the header image that works in both Apache and outside of Apache
    SET header_image_url = c.uri_for('/static/images/logo.png');
    app.common.header_html = '&lt;img src=&quot;' _ header_image_url _ '&quot; /&gt;';</pre>
<pre>
  %]</pre>
<p>In the same way you can re-define any of the variables found in <code>defaults.tt</code></p>
<p>
</p>
<h3><a name="overriding_the_css">Overriding the CSS</a></h3>
<p>In METAMOD you can override any of the CSS styles in the application using
<a href="#custom_css"><code>custom.css</code></a> since this stylesheet will be the last one loaded by the
application. It is however wise to <code>only</code> modify properties such as background
colors, foreground colors, borders and font size. Modifying the height, width,
padding, margins, display type etc. of elements can lead to the application not
displaying properly in different browsers. Also modifying these properties can
break between different versions of METAMOD.</p>
<p>The style for any element can be modified, but only a few are usually needed.
For an example of the common ones see <code>app/example/custom/css/custom.css</code></p>
<p>
</p>
<h3><a name="path_to_images">Path to images</a></h3>
<p>One of the most common customisations are adding a logo image to the header and
the footer of the page. When adding images to the style it is important to get
the path to the image right.</p>
<dl>
<dt><strong><a name="custom_tt" class="item">custom.tt</a></strong></dt>

<dd>
<p>To get the path correct in the <a href="#custom_tt"><code>custom.tt</code></a> file you can use the following helper function.</p>
<pre>
 SET image_url = c.uri_for('/static/images/&lt;your image name here&gt;');</pre>
<p>This makes a variable <code>image_url</code> that contains the correct URL to the image file.</p>
</dd>
<dt><strong><a name="custom_css" class="item">custom.css</a></strong></dt>

<dd>
<p>To get the path correct in the <a href="#custom_css"><code>custom.css</code></a> file you can use the following path.</p>
<pre>
  url(&quot;../images/aboutheader.gif&quot;);</pre>
<p>as in</p>
<pre>
  background-image: url(&quot;../images/aboutheader.gif&quot;);</pre>
</dd>
</dl>
<p>
</p>
<h2><a name="deploying_a_metamod_application">Deploying a METAMOD application</a></h2>
<p>After the initial configuration has been completed, a number of scripts must be run before the
application is up and running. As these scripts will create files and directories that also are used
by the Apache runtime environment, it is important that
<em>the user running these scripts is the same as the user running Apache</em>.</p>
<p>
</p>
<h3><a name="activating_environment">Activating environment</a></h3>
<p>To make it easier to run the following scripts you can use the bash script activate_env that sets
the correct environment variables. All commands also run without this command, but you must then
specify the correct paths, configuration directory and PERL5LIB for all commands.</p>
<p>From anywhere execute the following command:</p>
<pre>
  $ source /opt/metno-metamod-&lt;version&gt;/activate_env &lt;PATH TO CONFIGURATION DIR&gt;</pre>
<p>This will enable the correct environment. To disable the environment again execute</p>
<pre>
 $ source /opt/metno-metamod-&lt;version&gt;/activate_env deactivate</pre>
<p>
</p>
<h3><a name="generate_apache_config_for_the_site">Generate Apache config for the site</a></h3>
<p>Create an Apache configuration file for the application. This is done by</p>
<pre>
  gen_httpd_conf.pl</pre>
<p>which creates a file &lt;configuration dir&gt;/etc/httpd.conf with the necessary configuration.</p>
<p>
</p>
<h3><a name="generate_init_d_scripts">Generate init.d scripts</a></h3>
<p>Create init.d scripts for automatic starting and stopping of Catalyst and the various METAMOD
services.</p>
<pre>
  gen_initd_script.pl</pre>
<p>This script generates a file in &lt;configuration dir&gt;/etc/init.d/ and
&lt;configuration dir&gt;/etc/default/</p>
<p>
</p>
<h3><a name="creating_the_webrun_directory">Creating the webrun directory</a></h3>
<p>The application also needs several directories to store files during operation.
Run the</p>
<pre>
  prepare_runtime_env.sh</pre>
<p>This script will initialize a runtime directory used by the application for logging, temporary
files etc.</p>
<p>
</p>
<h3><a name="installing_services">Installing services</a></h3>
<p>After installation, you should now install the application services where the
operating system can find it. Currently only Debian-based Linux systems are
supported. The following scripts will generate symlinks in /etc for Apache and
init.d pointing back to the configuration directory, as well as a small script for running
metamodInit.sh. You will need sudo permissions to successfully run the script.</p>
<pre>
  install_jobs.sh</pre>
<p>
</p>
<h3><a name="initializing_the_base_module">Initializing the BASE module</a></h3>
<p>At this point, the deployment of the application is complete for all instances not using the BASE
module. For an application using the BASE module, a few steps remains:</p>
<p>As explained in the <strong>Data base</strong> paragraph, several METAMOD applications may co-operate in a cluster,
and share a common data base. One of these applications must use the BASE module, and no other.
The last steps (described below) required for the base application must be done after the initial
steps (described above), for all applications in the cluster, are completed.</p>
<p>The two PostgreSQL databases used by the cluster must be initialized. Note that the two databases are
operated through two database users. The name of these users are found in the <code>master_config.txt</code>
file as the value of PG_ADMIN_USER and PG_WEB_USER configuration variables. These users must be
defined in the PostgreSQL database environment before the database initialization scripts can be
run. The <code>base/init/createusers.sh</code> script may be used for this purpose. It is only necessary to run this
script once for a PostgreSQL database environment.</p>
<p>The first SQL database initialization script will create the Meta database.</p>
<pre>
        create_and_load_all.sh</pre>
<p>This script will create the database, and load the static content of the database (taken from
<a href="#staticdata_searchdata_xml"><code>staticdata/searchdata.xml</code></a>). You may check the output of this script in the
<code>create_and_load_all.out</code> file in the directory where you are running the command.</p>
<p>The next SQL database initialization script will create the User database.</p>
<pre>
        run_createuserdb.sh</pre>
<p>Note that <em>this script must only be used during setup of a completely new METAMOD cluster</em>. If a
User database already exists, all data in the database will be lost. If this should happen, you must
recreate the database from a backup copy you hopefully have. But METAMOD will not by itself ensure
that such a backup exists.</p>
<p>This warning is only adequate for the <code>run_createuserdb.sh</code> script. The other scripts in this
paragraph (<code>prepare_runtime_env.sh</code>, <code>create_and_load_all.sh</code>) may all be
used on an existing installation, without harming existing data. The <code>create_and_load_all.sh</code> script
will take some time to complete, though. On an existing installation, all metadata in the database
will be loaded from the XML archive.</p>
<p>
</p>
<h2><a name="starting_metamod">Starting METAMOD</a></h2>
<p>
</p>
<h3><a name="catalyst_daemon">Catalyst daemon</a></h3>
<p>Start Catalyst by running</p>
<pre>
        sudo /etc/init.d/catalyst-APPLICATION_ID start</pre>
<p>Then check if METAMOD is responding (usually on port 3000, use server name if not running locally):</p>
<pre>
        <a href="http://localhost:3000/">http://localhost:3000/</a></pre>
<p>If all set you should see the METAMOD search interface.</p>
<p>
</p>
<h3><a name="apache">Apache</a></h3>
<p>If this has not already been done you need to enable the Apache proxy modules.
Look in /etc/apache2/mods-enabled to see if they have already been enabled.</p>
<pre>
   sudo a2enmod proxy
   sudo a2enmod proxy_http</pre>
<p>Restart Apache:</p>
<pre>
        sudo apache2ctl restart</pre>
<p>or if the site is busy:</p>
<pre>
        sudo apache2ctl graceful</pre>
<p>which will wait until all connections are terminated before restarting.</p>
<p>The site should now hopefully be available on</p>
<pre>
        <a href="http://localhost/APPLICATION_ID">http://localhost/APPLICATION_ID</a></pre>
<p>
</p>
<h3><a name="metamod_services">METAMOD services</a></h3>
<p>Start METAMOD:</p>
<pre>
        sudo /etc/init.d/metamodServices-APPLICATION_ID start</pre>
<p>This should start the required services daemons.</p>

</body>

</html>
