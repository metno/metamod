<html><head><title>Deploying a METAMOD application</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" type="text/css" title="pod_stylesheet" href="mmdocs.css?view=co">

</head>
<body class='pod'>
<!--
  generated by Metamod::Pod::Simple::HTML v,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Fri May 24 15:49:38 2013 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Metamod::Pod::Simple::HTML, and/or subclassing Metamod::Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Metamod::Pod::Simple::HTML for advice.
   See 'perldoc Metamod::Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<a name='___top' class='dummyTopAnchor' ></a>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#Deploying_a_METAMOD_application'>Deploying a METAMOD application</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Installing_services'>Installing services</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Users_with_restricted_sudo_privileges'>Users with restricted sudo privileges</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Setting_the_environment'>Setting the environment</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Using_activate_env_(optional)'>Using activate_env (optional)</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Creating_the_webrun_directory'>Creating the webrun directory</a>
    <li class='indexItem indexItem2'><a href='#Initializing_the_BASE_module'>Initializing the BASE module</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Authentication_(FIXME)'>Authentication (FIXME)</a>
      <li class='indexItem indexItem3'><a href='#Creating_databases'>Creating databases</a>
      <li class='indexItem indexItem3'><a href='#Email_configuration_(FIXME)'>Email configuration (FIXME)</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Starting_METAMOD'>Starting METAMOD</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#Catalyst_daemon'>Catalyst daemon</a>
      <li class='indexItem indexItem3'><a href='#Apache'>Apache</a>
      <li class='indexItem indexItem3'><a href='#METAMOD_services'>METAMOD services</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Deploying_a_METAMOD_application"
>Deploying a METAMOD application</a></h1>

<p>Back to <a href="./index.html?view=co" class="podlinkpod"
>Index</a></p>

<p>Before you can deploy a METAMOD application you must set up a configuration directory,
see <a href="./configuration.html?view=co" class="podlinkpod"
>METAMOD Configuration</a>.</p>

<p>After the initial configuration has been completed,
a number of scripts must be run before the application is up and running.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Installing_services"
>Installing services</a></h2>

<p>After installation of the software and one or more configurations,
you should now install the application services where the operating system can find it.
Currently only Debian-based Linux systems are supported.</p>

<p>This script will create an Apache configuration file,
as well as init.d scripts for automatic starting and stopping of Catalyst and the various METAMOD services for the specific application.
These files are normally owned by root and will be placed in in <em>&#60;configuration dir&#62;/etc</em>,
and then symlinked into <em>/etc/apache2</em> and <em>/etc/init.d</em>.</p>

<pre>  $ cd /opt/metno-metamod-2.11 # or elsewhere if installed from source
  $ ./install_jobs.sh &#60;config&#62;</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Users_with_restricted_sudo_privileges"
>Users with restricted sudo privileges</a></h3>

<p>Some users may not have full sudo rights, and/or having PERL5LIB stripped out when running under sudo (see <a href="http://www.sudo.ws/sudo/alerts/perl_env.html" class="podlinkurl"
>http://www.sudo.ws/sudo/alerts/perl_env.html</a>). You will then typically get the following error message:</p>

<pre>  sudo: sorry, you are not allowed to set the following environment variables: PERL5LIB</pre>

<p>If so you may run install_jobs with the -u option (for unprivileged), in which case all files will be owned by yourself instead of root:</p>

<pre>  $ ./install_jobs.sh -u &#60;config&#62;</pre>

<p>Note that this is not recommended in production environments where several login users are administering the system.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Setting_the_environment"
>Setting the environment</a></h2>

<p>Before running any other scripts you must tell METAMOD where to find its libraries:</p>

<pre>  $ export PERL5LIB=&#34;/opt/metno-perl-webdev-ver1/lib/perl5&#34;</pre>

<p>If desired you may also predefine the application config path. Then you won&#39;t have to specify the &#60;config&#62; parameter for each script.</p>

<pre>  $ export METAMOD_MASTER_CONFIG=&#34;/path/to/applic/config&#34;</pre>

<p>All commands also run without these variables, but you must then specify the correct executable paths, configuration directory and PERL5LIB for all commands.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Using_activate_env_(optional)"
>Using activate_env (optional)</a></h3>

<p>For simplicity you may instead use the bash script <em>activate_env</em> that sets the relevant environment variables.</p>

<p>From anywhere execute the following command:</p>

<pre>  $ source /opt/metno-metamod-&#60;version&#62;/activate_env &#60;PATH TO CONFIGURATION DIR&#62;</pre>

<p>This will enable the correct environment. To disable the environment again execute</p>

<pre>  $ source /opt/metno-metamod-&#60;version&#62;/activate_env deactivate</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Creating_the_webrun_directory"
>Creating the webrun directory</a></h2>

<p>The application also needs several directories to store files during operation. Run the script</p>

<pre>  prepare_runtime_env.sh &#60;config&#62;</pre>

<p>which will initialize a runtime directory used by the application for logging, temporary files etc. owned by the APPLICATION_USER user. If already existing nothing will be deleted, although file ownership may be updated to the current configuration. (Note that if your current user does not have write privileges to WEBRUN_DIRECTORY this script will fail.)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Initializing_the_BASE_module"
>Initializing the BASE module</a></h2>

<p>At this point, the deployment of the application is complete for all instances not using the BASE module. For an application using the BASE module, a few steps remains:</p>

<p>As explained in the <b>Data base</b> paragraph, several METAMOD applications may co-operate in a cluster, and share a common data base. One of these applications must use the BASE module, and no other. The last steps (described below) required for the base application must be done after the initial steps (described above), for all applications in the cluster, are completed.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Authentication_(FIXME)"
>Authentication (FIXME)</a></h3>

<p>Change local ident to trust in pg_hba.conf (replace 9.1 with correct version):</p>

<pre>    $ $EDITOR /etc/postgresql/9.1/main/pg_hba.conf
    change local ident to trust

    # Database administrative login by UNIX sockets
    local   all         postgres                          ident sameuser

    # TYPE  DATABASE    USER        CIDR-ADDRESS          METHOD

    # &#34;local&#34; is for Unix domain socket connections only
    #local   all         all                              ident sameuser
    local   all         all                               trust
    # IPv4 local connections:
    host    all         all         127.0.0.1/32          trust
    host    all         all         157.249.0.1/16        trust
    # IPv6 local connections:
    host    all         all         ::1/128               md5</pre>

<p>Then restart PostgreSQL:</p>

<pre>    /etc/init.d/postgresql stop
    /etc/init.d/postgresql start</pre>

<p>Alternatively, use .pgpass (FIXME)</p>

<p>Do not use PG_CONNECTSTRING_SHELL for shell connections to localhost (use sockets instead).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Creating_databases"
>Creating databases</a></h3>

<p>The two PostgreSQL databases used by the cluster must be initialized. Note that the two databases are operated through two database users. The name of these users are found in the <code>master_config.txt</code> file as the value of PG_ADMIN_USER and PG_WEB_USER configuration variables. These users must be defined in the PostgreSQL database environment before the database initialization scripts can be run:</p>

<pre>    base/init/createusers.sh</pre>

<p>It is only necessary to run this script once for a PostgreSQL database environment.</p>

<p>The first SQL database initialization script will create the Meta database.</p>

<pre>        base/init/create_and_load_all.sh</pre>

<p>This script will create the database, and load the static content of the database (taken from <code>staticdata/searchdata.xml</code>). You may check the output of this script in the <code>create_and_load_all.out</code> file in the directory where you are running the command.</p>

<p>The next SQL database initialization script will create the User database.</p>

<pre>        base/init/run_createuserdb.sh</pre>

<p>Note that <i>this script must only be used during setup of a completely new METAMOD cluster</i>. If a User database already exists, all data in the database will be lost. If this should happen, you must recreate the database from a backup copy you hopefully have. But METAMOD will not by itself ensure that such a backup exists.</p>

<p>This warning is only adequate for the <code>run_createuserdb.sh</code> script. The other scripts in this paragraph (<code>prepare_runtime_env.sh</code>, <code>create_and_load_all.sh</code>) may all be used on an existing installation, without harming existing data. The <code>create_and_load_all.sh</code> script will take some time to complete, though. On an existing installation, all metadata in the database will be loaded from the XML archive.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Email_configuration_(FIXME)"
>Email configuration (FIXME)</a></h3>

<p>To configure exim, run:</p>

<pre>    $ sudo dpkg-reconfigure exim4-config</pre>

<p>See the Exim documentation for more information.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Starting_METAMOD"
>Starting METAMOD</a></h2>

<p>There are two ways of starting METAMOD; either as a system service (recommended for production environments) or as a series of command line script (recommended for development). In the latter case you would normally run the Catalyst web server continously and start the other daemons as necessary (prepare_download, harvester et al).</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Catalyst_daemon"
>Catalyst daemon</a></h3>

<p>First, try starting Catalyst by running</p>

<pre>  $ export PERL5LIB=/opt/metno-metamod-2.12/common/lib:/opt/metno-metamod-2.12/catalyst/lib:/opt/metno-perl-webdev-ver1/lib/perl5
  $ /opt/metno-metamod-2.12/catalyst/script/metamodweb_server.pl -d myapp</pre>

<p>replacing the path to METAMOD on line 2 if running from source.</p>

<p>MetamodWeb should now be available on <a href="http://localhost:3000/" class="podlinkurl"
>http://localhost:3000/</a>. If all set you should see the METAMOD search interface. Stop with ctrl-c.</p>

<p>If that worked, you may then try to start it as a service:</p>

<pre>        sudo /etc/init.d/catalyst-APPLICATION_ID start</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Apache"
>Apache</a></h3>

<p>Accessing METAMOD directly from Catalyst is not recommended in production; instead a proxy server like Apache is recommended. <code>./install_jobs.sh</code> automatically generates the necessary Apache setup files for you.</p>

<p>If this has not already been done you need to enable the Apache proxy modules. Look in /etc/apache2/mods-enabled to see if they have already been enabled.</p>

<pre>   sudo a2enmod proxy
   sudo a2enmod proxy_http</pre>

<p>Restart Apache:</p>

<pre>        sudo apache2ctl restart</pre>

<p>or if the site is busy:</p>

<pre>        sudo apache2ctl graceful</pre>

<p>which will wait until all connections are terminated before restarting.</p>

<p>The site should now hopefully be available on</p>

<pre>        http://localhost/APPLICATION_ID</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="METAMOD_services"
>METAMOD services</a></h3>

<p>Start METAMOD:</p>

<pre>        sudo /etc/init.d/metamodServices-APPLICATION_ID start</pre>

<p>This should start the required services daemons.</p>

<!-- end doc -->

</body></html>
