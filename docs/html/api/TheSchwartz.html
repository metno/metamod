<html><head><title>TheSchwartz</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="_grygrnw.css" media="all" >

<script type="text/javascript" src="_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:28 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#USAGE'>USAGE</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#TheSchwartz-%3Enew(_%25args_)'>TheSchwartz-&#62;new( %args )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Elist_jobs(_%25args_)'>$client-&#62;list_jobs( %args )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Elookup_job(_%24handle_id_)'>$client-&#62;lookup_job( $handle_id )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Eset_verbose(_%24verbose_)'>$client-&#62;set_verbose( $verbose )</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#POSTING_JOBS'>POSTING JOBS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#%24client-%3Einsert(_%24job_)'>$client-&#62;insert( $job )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Einsert(_%24funcname%2C_%24arg_)'>$client-&#62;insert( $funcname, $arg )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Einsert_jobs(_%40jobs_)'>$client-&#62;insert_jobs( @jobs )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Eset_prioritize(_%24prioritize_)'>$client-&#62;set_prioritize( $prioritize )</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#WORKING'>WORKING</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#%24client-%3Ecan_do(_%24ability_)'>$client-&#62;can_do( $ability )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Ework_once()'>$client-&#62;work_once()</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Ework_until_done()'>$client-&#62;work_until_done()</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Ework(_%5B%24delay%5D_)'>$client-&#62;work( [$delay] )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Ework_on(%24handle)'>$client-&#62;work_on($handle)</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Egrab_and_work_on(%24handle)'>$client-&#62;grab_and_work_on($handle)</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Efind_job_for_workers(_%5B%24abilities%5D_)'>$client-&#62;find_job_for_workers( [$abilities] )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Efind_job_with_coalescing_value(_%24ability%2C_%24coval_)'>$client-&#62;find_job_with_coalescing_value( $ability, $coval )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Efind_job_with_coalescing_prefix(_%24ability%2C_%24coval_)'>$client-&#62;find_job_with_coalescing_prefix( $ability, $coval )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Eget_server_time(_%24driver_)'>$client-&#62;get_server_time( $driver )</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#THE_SCOREBOARD'>THE SCOREBOARD</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#%24client-%3Eset_scoreboard(_%24dir_)'>$client-&#62;set_scoreboard( $dir )</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Escoreboard()'>$client-&#62;scoreboard()</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Estart_scoreboard()'>$client-&#62;start_scoreboard()</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Eend_scoreboard()'>$client-&#62;end_scoreboard()</a>
    <li class='indexItem indexItem2'><a href='#%24client-%3Eclean_scoreboard()'>$client-&#62;clean_scoreboard()</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#PASSING_IN_AN_EXISTING_DRIVER'>PASSING IN AN EXISTING DRIVER</a>
  <li class='indexItem indexItem1'><a href='#COPYRIGHT%2C_LICENSE_%26_WARRANTY'>COPYRIGHT, LICENSE &#38; WARRANTY</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>TheSchwartz - reliable job queue</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>    # MyApp.pm
    package MyApp;

    sub work_asynchronously {
        my %args = @_;

        my $client = TheSchwartz-&#62;new( databases =&#62; $DATABASE_INFO );
        $client-&#62;insert(&#39;MyWorker&#39;, \%args);
    }


    # myworker.pl
    package MyWorker;
    use base qw( TheSchwartz::Worker );

    sub work {
        my $class = shift;
        my TheSchwartz::Job $job = shift;

        print &#34;Workin&#39; hard or hardly workin&#39;? Hyuk!!\n&#34;;

        $job-&#62;completed();
    }

    package main;

    my $client = TheSchwartz-&#62;new( databases =&#62; $DATABASE_INFO );
    $client-&#62;can_do(&#39;MyWorker&#39;);
    $client-&#62;work();</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>TheSchwartz is a reliable job queue system. Your application can put jobs into the system, and your worker processes can pull jobs from the queue atomically to perform. Failed jobs can be left in the queue to retry later.</p>

<p><i>Abilities</i> specify what jobs a worker process can perform. Abilities are the names of <code>TheSchwartz::Worker</code> subclasses, as in the synopsis: the <code>MyWorker</code> class name is used to specify that the worker script can perform the job. When using the <code>TheSchwartz</code> client&#39;s <code>work</code> functions, the class-ability duality is used to automatically dispatch to the proper class to do the actual work.</p>

<p>TheSchwartz clients will also prefer to do jobs for unused abilities before reusing a particular ability, to avoid exhausting the supply of one kind of job while jobs of other types stack up.</p>

<p>Some jobs with high setup times can be performed more efficiently if a group of related jobs are performed together. TheSchwartz offers a facility to <i>coalesce</i> jobs into groups, which a properly constructed worker can find and perform at once. For example, if your worker were delivering email, you might store the domain name from the recipient&#39;s address as the coalescing value. The worker that grabs that job could then batch deliver all the mail for that domain once it connects to that domain&#39;s mail server.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="USAGE"
>USAGE</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TheSchwartz-&#62;new(_%args_)"
><code>TheSchwartz-&#62;new( %args )</code></a></h2>

<p>Optional members of <code>%args</code> are:</p>

<ul>
<li><code>databases</code>
<p>An arrayref of database information. TheSchwartz workers can use multiple databases, such that if any of them are unavailable, the worker will search for appropriate jobs in the other databases automatically.</p>

<p>Each member of the <code>databases</code> value should be a hashref containing either:</p>

<ul>
<li><code>dsn</code>
<p>The database DSN for this database.</p>
</li>

<li><code>user</code>
<p>The username to use when connecting to this database.</p>
</li>

<li><code>pass</code>
<p>The password to use when connecting to this database.</p>
</li>
</ul>

<p>or</p>

<ul>
<li><code>driver</code>
<p>A <code>Data::ObjectDriver::Driver::DBI</code> object.</p>

<p>See note below.</p>
</li>
</ul>
</li>

<li><code>verbose</code>
<p>A value indicating whether to log debug messages. If <code>verbose</code> is a coderef, it is called to log debug messages. If <code>verbose</code> is not a coderef but is some other true value, debug messages will be sent to <code>STDERR</code>. Otherwise, debug messages will not be logged.</p>
</li>

<li><code>prioritize</code>
<p>A value indicating whether to utilize the job &#39;priority&#39; field when selecting jobs to be processed. If unspecified, jobs will always be executed in a randomized order.</p>
</li>

<li><code>driver_cache_expiration</code>
<p>Optional value to control how long database connections are cached for in seconds. By default, connections are not cached. To re-use the same database connection for five minutes, pass driver_cache_expiration =&#62; 300 to the constructor. Improves job throughput in cases where the work to process a job is small compared to the database connection set-up and tear-down time.</p>
</li>

<li><code>retry_seconds</code>
<p>The number of seconds after which to try reconnecting to apparently dead databases. If not given, TheSchwartz will retry connecting to databases after 30 seconds.</p>
</li>
</ul>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;list_jobs(_%args_)"
><code>$client-&#62;list_jobs( %args )</code></a></h2>

<p>Returns a list of <code>TheSchwartz::Job</code> objects matching the given arguments. The required members of <code>%args</code> are:</p>

<ul>
<li><code>funcname</code>
<p>the name of the function or a reference to an array of functions</p>
</li>

<li><code>run_after</code>
<p>the value you want to check &#60;= against on the run_after column</p>
</li>

<li><code>grabbed_until</code>
<p>the value you want to check &#60;= against on the grabbed_until column</p>
</li>

<li><code>coalesce_op</code>
<p>defaults to &#39;=&#39;, set it to whatever you want to compare the coalesce field too if you want to search, you can use &#39;LIKE&#39;</p>
</li>

<li><code>coalesce</code>
<p>coalesce value to search for, if you set op to &#39;LIKE&#39; you can use &#39;%&#39; here, do remember that &#39;%&#39; searches anchored at the beginning of the string are much faster since it is can do a btree index lookup</p>
</li>

<li><code>want_handle</code>
<p>if you want all your jobs to be set up using a handle. defaults to true. this option might be removed, as you should always have this on a Job object.</p>
</li>
</ul>

<p>It is important to remember that this function doesnt lock anything, it just returns as many jobs as there is up to amount of databases * FIND_JOB_BATCH_SIZE</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;lookup_job(_$handle_id_)"
><code>$client-&#62;lookup_job( $handle_id )</code></a></h2>

<p>Returns a <code>TheSchwartz::Job</code> corresponding to the given handle ID.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;set_verbose(_$verbose_)"
><code>$client-&#62;set_verbose( $verbose )</code></a></h2>

<p>Sets the current logging function to <code>$verbose</code> if it&#39;s a coderef. If not a coderef, enables debug logging to <code>STDERR</code> if <code>$verbose</code> is true; otherwise, disables logging.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="POSTING_JOBS"
>POSTING JOBS</a></h1>

<p>The methods of TheSchwartz clients used by applications posting jobs to the queue are:</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;insert(_$job_)"
><code>$client-&#62;insert( $job )</code></a></h2>

<p>Adds the given <code>TheSchwartz::Job</code> to one of the client&#39;s job databases.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;insert(_$funcname,_$arg_)"
><code>$client-&#62;insert( $funcname, $arg )</code></a></h2>

<p>Adds a new job with funcname <code>$funcname</code> and arguments <code>$arg</code> to the queue.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;insert_jobs(_@jobs_)"
><code>$client-&#62;insert_jobs( @jobs )</code></a></h2>

<p>Adds the given <code>TheSchwartz::Job</code> objects to one of the client&#39;s job databases. All the given jobs are recorded in <i>one</i> job database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;set_prioritize(_$prioritize_)"
><code>$client-&#62;set_prioritize( $prioritize )</code></a></h2>

<p>Set the <code>prioritize</code> value as described in the constructor.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="WORKING"
>WORKING</a></h1>

<p>The methods of TheSchwartz clients for use in worker processes are:</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;can_do(_$ability_)"
><code>$client-&#62;can_do( $ability )</code></a></h2>

<p>Adds <code>$ability</code> to the list of abilities <code>$client</code> is capable of performing. Subsequent calls to that client&#39;s <code>work</code> methods will find jobs requiring the given ability.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;work_once()"
><code>$client-&#62;work_once()</code></a></h2>

<p>Find and perform one job <code>$client</code> can do.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;work_until_done()"
><code>$client-&#62;work_until_done()</code></a></h2>

<p>Find and perform jobs <code>$client</code> can do until no more such jobs are found in any of the client&#39;s job databases.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;work(_[$delay]_)"
><code>$client-&#62;work( [$delay] )</code></a></h2>

<p>Find and perform any jobs <code>$client</code> can do, forever. When no job is available, the working process will sleep for <code>$delay</code> seconds (or 5, if not specified) before looking again.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;work_on($handle)"
><code>$client-&#62;work_on($handle)</code></a></h2>

<p>Given a job handle (a scalar string) <i>$handle</i>, runs the job, then returns.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;grab_and_work_on($handle)"
><code>$client-&#62;grab_and_work_on($handle)</code></a></h2>

<p>Similar to <a href="./%24client-%3Ework_on(%24handle).html" class="podlinkpod"
>$client-&#62;work_on($handle)</a>, except that the job will be grabbed before being run. It guarantees that only one worker will work on it (at least in the <code>grab_for</code> interval).</p>

<p>Returns false if the worker couldn&#39;t grab the job, and true if the worker worked on it.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;find_job_for_workers(_[$abilities]_)"
><code>$client-&#62;find_job_for_workers( [$abilities] )</code></a></h2>

<p>Returns a <code>TheSchwartz::Job</code> for a random job that the client can do. If specified, the job returned matches one of the abilities in the arrayref <code>$abilities</code>, rather than <code>$client</code>&#39;s abilities.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;find_job_with_coalescing_value(_$ability,_$coval_)"
><code>$client-&#62;find_job_with_coalescing_value( $ability, $coval )</code></a></h2>

<p>Returns a <code>TheSchwartz::Job</code> for a random job for a worker capable of <code>$ability</code> and with a coalescing value of <code>$coval</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;find_job_with_coalescing_prefix(_$ability,_$coval_)"
><code>$client-&#62;find_job_with_coalescing_prefix( $ability, $coval )</code></a></h2>

<p>Returns a <code>TheSchwartz::Job</code> for a random job for a worker capable of <code>$ability</code> and with a coalescing value beginning with <code>$coval</code>.</p>

<p>Note the <code>TheSchwartz</code> implementation of this function uses a <code>LIKE</code> query to find matching jobs, with all the attendant performance implications for your job databases.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;get_server_time(_$driver_)"
><code>$client-&#62;get_server_time( $driver )</code></a></h2>

<p>Given an open driver <i>$driver</i> to a database, gets the current server time from the database.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="THE_SCOREBOARD"
>THE SCOREBOARD</a></h1>

<p>The scoreboards can be used to monitor what the TheSchwartz::Worker subclasses are currently working on. Once the scoreboard has been enabled in the workers with <code>set_scoreboard</code> method the <code>thetop</code> utility (shipped with TheSchwartz distribuition in the <code>extras</code> directory) can be used to list all current jobs being worked on.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;set_scoreboard(_$dir_)"
><code>$client-&#62;set_scoreboard( $dir )</code></a></h2>

<p>Enables the scoreboard. Setting this to <code>1</code> or <code>on</code> will cause TheSchwartz to create a scoreboard file in a location it determines is optimal.</p>

<p>Passing in any other option sets the directory the TheSchwartz scoreboard directory should be created in. For example, if you set this to <code>/tmp</code> then this would create a directory called <code>/tmp/theschwartz</code> and a scoreboard file <code>/tmp/theschwartz/scoreboard.pid</code> in it (where pid is the current process pid.)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;scoreboard()"
><code>$client-&#62;scoreboard()</code></a></h2>

<p>Returns the path to the current scoreboard file.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;start_scoreboard()"
><code>$client-&#62;start_scoreboard()</code></a></h2>

<p>Writes the current job information to the scoreboard file (called by the worker in work_safely before it actually starts working)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;end_scoreboard()"
><code>$client-&#62;end_scoreboard()</code></a></h2>

<p>Appends the current job duration to the end of the scoreboard file (called by the worker in work_safely once work has been completed)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="$client-&#62;clean_scoreboard()"
><code>$client-&#62;clean_scoreboard()</code></a></h2>

<p>Removes the scoreboard file (but not the scoreboard directory.) Automatically called by TheSchwartz during object destruction (i.e. when the instance goes out of scope)</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="PASSING_IN_AN_EXISTING_DRIVER"
>PASSING IN AN EXISTING DRIVER</a></h1>

<p>You can pass in a existing <code>Data::Object::Driver::DBI</code> object which also allows you to reuse exist Database handles like so:</p>

<pre>        my $dbh = DBI-&#62;connect( $dsn, &#34;root&#34;, &#34;&#34;, {
                RaiseError =&#62; 1,
                PrintError =&#62; 0,
                AutoCommit =&#62; 1,
            } ) or die $DBI::errstr;
        my $driver = Data::ObjectDriver::Driver::DBI-&#62;new( dbh =&#62; $dbh);
        return TheSchwartz-&#62;new(databases =&#62; [{ driver =&#62; $driver }]);</pre>

<p><b>Note</b>: it&#39;s important that the <code>RaiseError</code> and <code>AutoCommit</code> flags are set on the handle for various bits of functionality to work.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="COPYRIGHT,_LICENSE_&#38;_WARRANTY"
>COPYRIGHT, LICENSE &#38; WARRANTY</a></h1>

<p>This software is Copyright 2007, Six Apart Ltd, cpan@sixapart.com. All rights reserved.</p>

<p>TheSchwartz is free software; you may redistribute it and/or modify it under the same terms as Perl itself.</p>

<p>TheScwhartz comes with no warranty of any kind.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
