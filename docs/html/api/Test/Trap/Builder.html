<html><head><title>Test::Trap::Builder</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >

<script type="text/javascript" src="../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:28 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#VERSION'>VERSION</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#EXPORTS'>EXPORTS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Prop_%5BPACKAGE%5D'>Prop [PACKAGE]</a>
    <li class='indexItem indexItem2'><a href='#DESTROY'>DESTROY</a>
    <li class='indexItem indexItem2'><a href='#Run'>Run</a>
    <li class='indexItem indexItem2'><a href='#Next'>Next</a>
    <li class='indexItem indexItem2'><a href='#Teardown_SUBS'>Teardown SUBS</a>
    <li class='indexItem indexItem2'><a href='#TestAccessor'>TestAccessor</a>
    <li class='indexItem indexItem2'><a href='#TestFailure'>TestFailure</a>
    <li class='indexItem indexItem2'><a href='#Exception_STRINGS'>Exception STRINGS</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#METHODS'>METHODS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#new'>new</a>
    <li class='indexItem indexItem2'><a href='#trap_TRAPPER%2C_GLOBREF%2C_LAYERARRAYREF%2C_CODE'>trap TRAPPER, GLOBREF, LAYERARRAYREF, CODE</a>
    <li class='indexItem indexItem2'><a href='#layer_NAME%2C_CODE'>layer NAME, CODE</a>
    <li class='indexItem indexItem2'><a href='#output_layer_NAME%2C_GLOBREF'>output_layer NAME, GLOBREF</a>
    <li class='indexItem indexItem2'><a href='#output_layer_backend_NAME%2C_%5BCODE%5D'>output_layer_backend NAME, [CODE]</a>
    <li class='indexItem indexItem2'><a href='#first_output_layer_backend_SPEC'>first_output_layer_backend SPEC</a>
    <li class='indexItem indexItem2'><a href='#multi_layer_NAME%2C_LAYERS'>multi_layer NAME, LAYERS</a>
    <li class='indexItem indexItem2'><a href='#layer_implementation_TRAPPER%2C_LAYERS'>layer_implementation TRAPPER, LAYERS</a>
    <li class='indexItem indexItem2'><a href='#accessor_NAMED_ARGS'>accessor NAMED_ARGS</a>
    <li class='indexItem indexItem2'><a href='#test_NAME%2C_ARGSPEC%2C_CODE'>test NAME, ARGSPEC, CODE</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#EXAMPLE'>EXAMPLE</a>
  <li class='indexItem indexItem1'><a href='#CAVEATS'>CAVEATS</a>
  <li class='indexItem indexItem1'><a href='#BUGS'>BUGS</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#COPYRIGHT_%26_LICENSE'>COPYRIGHT &#38; LICENSE</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>Test::Trap::Builder - Backend for building test traps</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="VERSION"
>VERSION</a></h1>

<p>Version 0.2.2</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  package My::Test::Trap;

  use Test::Trap::Builder;
  my $B = Test::Trap::Builder-&#62;new;

  $B-&#62;layer( $layer_name =&#62; \&#38;layer_implementation );
  $B-&#62;accessor( simple =&#62; [ $layer_name ] );

  $B-&#62;multi_layer( $multi_name =&#62; @names );

  $B-&#62;test( $test_name =&#62; &#39;trap, predicate, name&#39;, \&#38;test_function );</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p><a href="../../Test/Trap.html" class="podlinkpod"
>Test::Trap</a> neither traps nor tests everything you may want to trap or test. So, Test::Trap::Builder provides methods to write your own trap layers, accessors, and test callbacks -- preferably for use with your own modules (trappers).</p>

<p>Note that layers are methods with mangled names (names are prefixed with <code>layer:</code>), and so inherited like any other method, while accessors are ordinary methods. Meanwhile, test callbacks are not referenced in the symbol table by themselves, but only in combinations with accessors, all methods of the form <i>ACCESSOR</i>_<i>TEST</i>.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="EXPORTS"
>EXPORTS</a></h1>

<p>Trappers should not inherit from Test::Trap::Builder, but may import a few convenience methods for use in building the trap. Do not use them as methods of Test::Trap::Builder -- they are intended to be methods of trap objects. (If you inherit from another trapper, you need not, and probably should not, import these yourself -- you should inherit these methods like any other.)</p>

<p>Trappers may import any number of these methods, or all of them by way of the <code>:methods</code> tag.</p>

<p>Layers should be implemented as methods, and while they need not call any of these convenience methods in turn, that likely makes for more readable code than any alternative. Likewise, test callbacks may use convenience methods for more readable code.</p>

<p>Of course, certain convenience methods may also be useful in more generic methods messing with trap or builder objects.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Prop_[PACKAGE]"
>Prop [PACKAGE]</a></h2>

<p>A method returning a reference to a hash, holding the <i>PACKAGE</i>&#39;s (by default the caller&#39;s) tag-on properties for the (current) trap object. Currently, Test::Trap::Builder defines the following properties:</p>

<dl>
<dt><a name="layers"
>layers</a></dt>

<dd>
<p>While the trap is springing, the queue of layers remaining. Usually set by the <a href="#trap" class="podlinkpod"
>&#34;trap&#34;</a> method and consumed by the <a href="#Next" class="podlinkpod"
>&#34;Next&#34;</a> method.</p>

<dt><a name="teardown"
>teardown</a></dt>

<dd>
<p>While the trap is springing, the queue of teardown actions remaining. Usually accumulated through the <a href="#Teardown" class="podlinkpod"
>&#34;Teardown&#34;</a> method and invoked by the <a href="#trap" class="podlinkpod"
>&#34;trap&#34;</a> method.</p>

<dt><a name="code"
>code</a></dt>

<dd>
<p>The user code trapped. Usually set by the <a href="#trap" class="podlinkpod"
>&#34;trap&#34;</a> method and invoked by the <a href="#Run" class="podlinkpod"
>&#34;Run&#34;</a> method.</p>

<dt><a name="exception"
>exception</a></dt>

<dd>
<p>An internal exception. Usually set through the <a href="#Exception" class="podlinkpod"
>&#34;Exception&#34;</a> method and examined by the <a href="#trap" class="podlinkpod"
>&#34;trap&#34;</a> method.</p>

<dt><a name="on_test_failure"
>on_test_failure</a></dt>

<dd>
<p>A callback invoked by the <a href="#TestFailure" class="podlinkpod"
>&#34;TestFailure&#34;</a> method. Layers in particular may want to set this.</p>

<dt><a name="test_accessor"
>test_accessor</a></dt>

<dd>
<p>The name and (optionally) the index of the accessor, the contents of which we&#39;re currently testing. Best accessed through the <a href="#TestAccessor" class="podlinkpod"
>&#34;TestAccessor&#34;</a> method, and usually set by the <a href="#test" class="podlinkpod"
>&#34;test&#34;</a> and <a href="#accessor" class="podlinkpod"
>&#34;accessor&#34;</a> methods, but if you are writing your own tests or accessors directly, you just might need to set it. Perhaps.</p>
</dd>
</dl>

<p>Be nice: Treat another module&#39;s tag-on properties as you would treat another module&#39;s global variables. Don&#39;t use them except as documented.</p>

<p>Example:</p>

<pre>  # in a layer, setting the callback for TestFailure:
  $self-&#62;Prop(&#39;Test::Trap::Builder&#39;)-&#62;{on_test_failure} = \&#38;mydiag;</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="DESTROY"
>DESTROY</a></h2>

<p>This cleans up the tag-on properties when the trap object is destroyed. Don&#39;t try to make a trapper that doesn&#39;t call this; it will get confused.</p>

<p>If your trapper needs its own <code>DESTROY</code>, make sure it calls this one as well:</p>

<pre>  sub DESTROY {
    my $self = shift;
    # do your thing
    $self-&#62;Test::Trap::Builder::DESTROY;
    # and more things
  }</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Run"
>Run</a></h2>

<p>A terminating layer should call this method to run the user code. Should only be called in a dynamic context in which layers are being applied.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Next"
>Next</a></h2>

<p>Every non-terminating layer should call this method (or an equivalent) to progress to the next layer. Should only be called in a dynamic context in which layers are being applied. Note that this method need not return, so any tear-down actions should probably be registered with the Teardown method (see below).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Teardown_SUBS"
>Teardown SUBS</a></h2>

<p>If your layer wants to clean up its setup, it may use this method to register any number of tear-down actions, to be performed (in reverse registration order) once the user code has been executed. Should only be called in a dynamic context in which layers are being applied.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TestAccessor"
>TestAccessor</a></h2>

<p>Returns a string of the form <code>&#34;<i>NAME</i>(<i>INDEX</i>)&#34;</code>, where <i>NAME</i> and <i>INDEX</i> are the name of the accessor and the index (if any) being tested. Should only be called in the dynamic context of test callbacks.</p>

<p>This is intended for diagnostics:</p>

<pre>  diag( sprintf &#39;Expected %s in %s; got %s&#39;,
        $expected, $self-&#62;TestAccessor, dump($got),
      );</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TestFailure"
>TestFailure</a></h2>

<p>Runs the <code>on_test_failure</code> tag-on property (if any) on the trap object. If you are writing unregistered tests, you might want to include (some variation of) this call:</p>

<pre>  $ok or $self-&#62;TestFailure;</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Exception_STRINGS"
>Exception STRINGS</a></h2>

<p>Layer implementations may run into exceptional situations, in which they want the entire trap to fail. Unfortunately, another layer may be trapping ordinary exceptions, so you need some kind of magic in order to throw an untrappable exception. This is one convenient way.</p>

<p>Should only be called in a dynamic context in which layers are being applied.</p>

<p>Note: The Exception method won&#39;t work if called from outside of the regular control flow, like inside a DESTROY method or signal handler. If anything like this happens, CORE::exit will be called with an exit code of 8.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="METHODS"
>METHODS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="new"
>new</a></h2>

<p>Returns a singleton object. Don&#39;t expect this module to work with a different instance object of this class.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="trap_TRAPPER,_GLOBREF,_LAYERARRAYREF,_CODE"
>trap TRAPPER, GLOBREF, LAYERARRAYREF, CODE</a></h2>

<p>Implements a trap for the <i>TRAPPER</i> module, applying the layers of <i>LAYERARRAYREF</i>, trapping various outcomes of the user <i>CODE</i>, and storing the trap object into the scalar slot of <i>GLOBREF</i>.</p>

<p>In most cases, the trapper should conveniently export a function calling this method.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="layer_NAME,_CODE"
>layer NAME, CODE</a></h2>

<p>Registers a layer by <i>NAME</i> to the calling trapper. When the layer is applied, the <i>CODE</i> will be invoked on the trap object being built, with no arguments, and should call either the Next() or Run() method or equivalent.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="output_layer_NAME,_GLOBREF"
>output_layer NAME, GLOBREF</a></h2>

<p>Registers (by <i>NAME</i> and to the calling trapper) a layer for trapping output on the file handle of the <i>GLOBREF</i>, using <i>NAME</i> also as the attribute name.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="output_layer_backend_NAME,_[CODE]"
>output_layer_backend NAME, [CODE]</a></h2>

<p>When called with two arguments, registers (by <i>NAME</i> and globally) a backend for output trap layers. When called with a single argument, looks up and returns the backend registered by <i>NAME</i> (or undef).</p>

<p>When a layer using this backend is applied, the <i>CODE</i> will be called on the trap object, with the layer name and the output handle&#39;s fileno and globref as arguments.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="first_output_layer_backend_SPEC"
>first_output_layer_backend SPEC</a></h2>

<p>Where <i>SPEC</i> is empty, just returns.</p>

<p>Where <i>SPEC</i> is a string of comma-or-semicolon separated backend names, runs through the names, returning the first implementation it finds. Dies if no implementation is found by any of these names.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="multi_layer_NAME,_LAYERS"
>multi_layer NAME, LAYERS</a></h2>

<p>Registers (by <i>NAME</i>) a layer that just pushes a number of other <i>LAYERS</i> on the stack of layers. If any of the <i>LAYERS</i> is neither an anonymous method nor the name of a layer registered to the caller or a trapper it inherits from, an exception is raised.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="layer_implementation_TRAPPER,_LAYERS"
>layer_implementation TRAPPER, LAYERS</a></h2>

<p>Returns the subroutines that implement the requested <i>LAYERS</i>. If any of the <i>LAYERS</i> is neither an anonymous method nor the name of a layer registered to or inherited by the <i>TRAPPER</i>, an exception is raised.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="accessor_NAMED_ARGS"
>accessor NAMED_ARGS</a></h2>

<p>Generates and registers any number of accessors according to the <i>NAMED_ARGS</i>, and also generates the proper test methods for these accessors (see below).</p>

<p>The following named arguments are recognized:</p>

<dl>
<dt><a name="is_leaveby"
>is_leaveby</a></dt>

<dd>
<p>If true, the tests methods will generate better diagnostics if the trap was not left as specified. Also, a special did_<i>ACCESSOR</i> test method will be generated (unless already present), simply passing as long as the trap was left as specified.</p>

<dt><a name="is_array"
>is_array</a></dt>

<dd>
<p>If true, the simple accessor(s) will be smart about context and arguments, returning an arrayref on no argument (in any context), an array slice in list context (on any number of arguments), and the element indexed by the first argument otherwise.</p>

<dt><a name="simple"
>simple</a></dt>

<dd>
<p>Should be a reference to an array of accessor names. For each name, an accessor (assuming hash based trap object with accessor names as keys), will be generated and registered.</p>

<dt><a name="flexible"
>flexible</a></dt>

<dd>
<p>Should be a reference to a hash. For each pair, a name and an implementation, an accessor is generated and registered.</p>
</dd>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="test_NAME,_ARGSPEC,_CODE"
>test NAME, ARGSPEC, CODE</a></h2>

<p>Registers a test callback by <i>NAME</i> and to the calling trapper.</p>

<p>Trappers inherit test callbacks like methods (though they are not implemented as such; don&#39;t expect to find them in the symbol table).</p>

<p>Test methods of the form <i>ACCESSOR</i>_<i>TEST</i> will be made available (directly or by inheritence) to every trapper that registers or inherits both the accessor named <i>ACCESSOR</i> and the test named <i>TEST</i>.</p>

<p>(In more detail, the method will be generated in every trapper that either (1) registers both the test and the accessor, or (2) registers either and inherits the other.)</p>

<p>When the test method is called, any implicit leaveby condition will be tested first, and if it passes (or there were none), the <i>CODE</i> is called with arguments according to the words found in the <i>ARGSPEC</i> string:</p>

<dl>
<dt><a name="trap"
>trap</a></dt>

<dd>
<p>The trap object.</p>

<dt><a name="entirety"
>entirety</a></dt>

<dd>
<p>The <i>ACCESSOR</i>&#39;s return value when called without arguments.</p>

<dt><a name="element"
>element</a></dt>

<dd>
<p>The <i>ACCESSOR</i>&#39;s return value when called with index, if applicable (i.e. for array accessors). Index is not applicable to scalar accessors, so such are still called without index.</p>

<p>The index, when applicable, will be taken from the test method&#39;s arguments.</p>

<dt><a name="predicate"
>predicate</a></dt>

<dd>
<p>What the <i>ACCESSOR</i>&#39;s return value should be tested against (taken from the test method&#39;s arguments). (There may be any fixed number of predicates.)</p>

<dt><a name="name"
>name</a></dt>

<dd>
<p>The test name (taken from the test method&#39;s arguments).</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="EXAMPLE"
>EXAMPLE</a></h1>

<p>A complete example, implementing a <i>timeout</i> layer (depending on Time::HiRes::ualarm being present), a <i>simpletee</i> layer (printing the trapped stdout/stderr to the original file handles after the trap has sprung), and a <i>cmp_ok</i> test method template:</p>

<pre>  package My::Test::Trap;
  use base &#39;Test::Trap&#39;; # for example
  use Test::Trap::Builder;

  my $B = Test::Trap::Builder-&#62;new;

  # example (layer:timeout):
  use Time::HiRes qw/ualarm/;
  $B-&#62;layer( timeout =&#62; $_ ) for sub {
    my $self = shift;
    eval {
      local $SIG{ALRM} = sub {
        $self-&#62;{timeout} = 1; # simple truth
        $SIG{ALRM} = sub {die};
        die;
      };
      ualarm 1000, 1; # one second max, then die repeatedly!
      $self-&#62;Next;
    };
    alarm 0;
    if ($self-&#62;{timeout}) {
      $self-&#62;{leaveby} = &#39;timeout&#39;;
      delete $self-&#62;{$_} for qw/ die exit return /;
    }
  };
  $B-&#62;accessor( is_leaveby =&#62; 1,
                simple =&#62; [&#39;timeout&#39;],
              );

  # example (layer:simpletee):
  $B-&#62;layer( simpletee =&#62; $_ ) for sub {
    my $self = shift;
    for (qw/ stdout stderr /) {
      exists $self-&#62;{$_} or $self-&#62;Exception(&#34;Too late to tee $_&#34;);
    }
    $self-&#62;Teardown($_) for sub {
      print STDOUT $self-&#62;{stdout} if exists $self-&#62;{stdout};
      print STDERR $self-&#62;{stderr} if exists $self-&#62;{stderr};
    };
    $self-&#62;Next;
  };
  # no accessor for this layer

  $B-&#62;multi_layer( flow =&#62; qw/ raw die exit timeout / );
  $B-&#62;multi_layer( default =&#62; qw/ flow stdout stderr warn simpletee / );

  $B-&#62;test_method( cmp_ok =&#62; 1, 2, \&#38;Test::More::cmp_ok );</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CAVEATS"
>CAVEATS</a></h1>

<p>The interface of this module is likely to remain somewhat in flux for a while yet.</p>

<p>The different implementations of output trap layers have their own caveats; see <a href="../../Test/Trap/Builder/Tempfile.html" class="podlinkpod"
>Test::Trap::Builder::Tempfile</a>, <a href="../../Test/Trap/Builder/PerlIO.html" class="podlinkpod"
>Test::Trap::Builder::PerlIO</a>, <a href="../../Test/Trap/Builder/SystemSafe.html" class="podlinkpod"
>Test::Trap::Builder::SystemSafe</a>.</p>

<p>Multiple inheritance is not (yet?) fully supported. If one parent has registered a test callback <code>X</code> and another has registered an accessor <code>Y</code>, the test method <code>Y_X</code> will not be generated.</p>

<p>Threads? No idea. It might even work correctly.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="BUGS"
>BUGS</a></h1>

<p>Please report any bugs or feature requests directly to the author.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Eirik Berg Hanssen, <code>&#60;ebhanssen@allverden.no&#62;</code></p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="COPYRIGHT_&#38;_LICENSE"
>COPYRIGHT &#38; LICENSE</a></h1>

<p>Copyright 2006-2012 Eirik Berg Hanssen, All Rights Reserved.</p>

<p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
