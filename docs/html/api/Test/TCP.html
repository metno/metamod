<html><head><title>Test::TCP</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:28 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#METHODS'>METHODS</a>
  <li class='indexItem indexItem1'><a href='#OO-ish_interface'>OO-ish interface</a>
  <li class='indexItem indexItem1'><a href='#FAQ'>FAQ</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#THANKS_TO'>THANKS TO</a>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
  <li class='indexItem indexItem1'><a href='#LICENSE'>LICENSE</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>Test::TCP - testing TCP program</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>    use Test::TCP;

    my $server = Test::TCP-&#62;new(
        code =&#62; sub {
            my $port = shift;
            ...
        },
    );
    my $client = MyClient-&#62;new(host =&#62; &#39;127.0.0.1&#39;, port =&#62; $server-&#62;port);
    undef $server; # kill child process on DESTROY</pre>

<p>Using memcached:</p>

<pre>    use Test::TCP;

    my $memcached = Test::TCP-&#62;new(
        code =&#62; sub {
            my $port = shift;

            exec $bin, &#39;-p&#39; =&#62; $port;
            die &#34;cannot execute $bin: $!&#34;;
        },
    );
    my $memd = Cache::Memcached-&#62;new({servers =&#62; [&#39;127.0.0.1:&#39; . $memcached-&#62;port]});
    ...</pre>

<p>And functional interface is available:</p>

<pre>    use Test::TCP;
    test_tcp(
        client =&#62; sub {
            my ($port, $server_pid) = @_;
            # send request to the server
        },
        server =&#62; sub {
            my $port = shift;
            # run server
        },
    );</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>Test::TCP is test utilities for TCP/IP programs.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="METHODS"
>METHODS</a></h1>

<dl>
<dt><a name="empty_port"
>empty_port</a></dt>

<dd>
<pre>    my $port = empty_port();</pre>

<p>Get the available port number, you can use.</p>

<p>Normally, empty_port() finds empty port number from 49152..65535. See <a href="http://www.iana.org/assignments/port-numbers" class="podlinkurl"
>http://www.iana.org/assignments/port-numbers</a></p>

<p>But you want to use another range, use a following form:</p>

<pre>    # 5963..65535
    my $port = empty_port(5963);</pre>

<dt><a name="test_tcp"
>test_tcp</a></dt>

<dd>
<p>Functional interface.</p>

<pre>    test_tcp(
        client =&#62; sub {
            my $port = shift;
            # send request to the server
        },
        server =&#62; sub {
            my $port = shift;
            # run server
        },
        # optional
        port =&#62; 8080
    );</pre>

<dt><a name="wait_port"
>wait_port</a></dt>

<dd>
<pre>    wait_port(8080);</pre>

<p>Waits for a particular port is available for connect.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="OO-ish_interface"
>OO-ish interface</a></h1>

<dl>
<dt><a name="my_$server_=_Test::TCP-&#62;new(%args);"
>my $server = Test::TCP-&#62;new(%args);</a></dt>

<dd>
<p>Create new instance of Test::TCP.</p>

<p>Arguments are following:</p>

<dl>
<dt><a name="$args{auto_start}:_Boolean"
>$args{auto_start}: Boolean</a></dt>

<dd>
<p>Call <code>$server-&#62;start()</code> after create instance.</p>

<p>Default: true</p>

<dt><a name="$args{code}:_CodeRef"
>$args{code}: CodeRef</a></dt>

<dd>
<p>The callback function. Argument for callback function is: <code>$code-&#62;($pid)</code>.</p>

<p>This parameter is required.</p>
</dd>
</dl>

<dt><a name="$server-&#62;start()"
>$server-&#62;start()</a></dt>

<dd>
<p>Start the server process. Normally, you don&#39;t need to call this method.</p>

<dt><a name="$server-&#62;stop()"
>$server-&#62;stop()</a></dt>

<dd>
<p>Stop the server process.</p>

<dt><a name="my_$pid_=_$server-&#62;pid();"
>my $pid = $server-&#62;pid();</a></dt>

<dd>
<p>Get the pid of child process.</p>

<dt><a name="my_$port_=_$server-&#62;port();"
>my $port = $server-&#62;port();</a></dt>

<dd>
<p>Get the port number of child process.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FAQ"
>FAQ</a></h1>

<dl>
<dt><a name="How_to_invoke_two_servers?"
>How to invoke two servers?</a></dt>

<dd>
<p>You can call test_tcp() twice!</p>

<pre>    test_tcp(
        client =&#62; sub {
            my $port1 = shift;
            test_tcp(
                client =&#62; sub {
                    my $port2 = shift;
                    # some client code here
                },
                server =&#62; sub {
                    my $port2 = shift;
                    # some server2 code here
                },
            );
        },
        server =&#62; sub {
            my $port1 = shift;
            # some server1 code here
        },
    );</pre>

<p>Or use OO-ish interface instead.</p>

<pre>    my $server1 = Test::TCP-&#62;new(code =&#62; sub {
        my $port1 = shift;
        ...
    });
    my $server2 = Test::TCP-&#62;new(code =&#62; sub {
        my $port2 = shift;
        ...
    });

    # your client code here.
    ...</pre>

<dt><a name="How_do_you_test_server_program_written_in_other_languages_like_memcached?"
>How do you test server program written in other languages like memcached?</a></dt>

<dd>
<p>You can use <code>exec()</code> in child process.</p>

<pre>    use strict;
    use warnings;
    use utf8;
    use Test::More;
    use Test::TCP 1.08;
    use File::Which;

    my $bin = scalar which &#39;memcached&#39;;
    plan skip_all =&#62; &#39;memcached binary is not found&#39; unless defined $bin;

    my $memcached = Test::TCP-&#62;new(
        code =&#62; sub {
            my $port = shift;

            exec $bin, &#39;-p&#39; =&#62; $port;
            die &#34;cannot execute $bin: $!&#34;;
        },
    );

    use Cache::Memcached;
    my $memd = Cache::Memcached-&#62;new({servers =&#62; [&#39;127.0.0.1:&#39; . $memcached-&#62;port]});
    $memd-&#62;set(foo =&#62; &#39;bar&#39;);
    is $memd-&#62;get(&#39;foo&#39;), &#39;bar&#39;;

    done_testing;</pre>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Tokuhiro Matsuno &#60;tokuhirom@gmail.com&#62;</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="THANKS_TO"
>THANKS TO</a></h1>

<p>kazuhooku</p>

<p>dragon3</p>

<p>charsbar</p>

<p>Tatsuhiko Miyagawa</p>

<p>lestrrat</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="LICENSE"
>LICENSE</a></h1>

<p>This library is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
