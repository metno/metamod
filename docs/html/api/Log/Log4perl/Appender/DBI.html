<html><head><title>Log::Log4perl::Appender::DBI</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../../_grygrnw.css" media="all" >

<script type="text/javascript" src="../../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:19 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#CAVEAT'>CAVEAT</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION_2'>DESCRIPTION 2</a>
  <li class='indexItem indexItem1'><a href='#MISC_PARAMETERS'>MISC PARAMETERS</a>
  <li class='indexItem indexItem1'><a href='#CHANGING_DBH_CONNECTIONS_(POOLING)'>CHANGING DBH CONNECTIONS (POOLING)</a>
  <li class='indexItem indexItem1'><a href='#LIFE_OF_CONNECTIONS'>LIFE OF CONNECTIONS</a>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
  <li class='indexItem indexItem1'><a href='#LICENSE'>LICENSE</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>Log::Log4perl::Appender::DBI - implements appending to a DB</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>    my $config = q{
     log4j.category = WARN, DBAppndr
     log4j.appender.DBAppndr             = Log::Log4perl::Appender::DBI
     log4j.appender.DBAppndr.datasource  = DBI:CSV:f_dir=t/tmp
     log4j.appender.DBAppndr.username    = bobjones
     log4j.appender.DBAppndr.password    = 12345
     log4j.appender.DBAppndr.sql         = \
        insert into log4perltest           \
        (loglevel, custid, category, message, ipaddr) \
        values (?,?,?,?,?)
     log4j.appender.DBAppndr.params.1 = %p    
                                   #2 is custid from the log() call
     log4j.appender.DBAppndr.params.3 = %c
                                   #4 is the message from log()
                                   #5 is ipaddr from log()

     log4j.appender.DBAppndr.usePreparedStmt = 1
      #--or--
     log4j.appender.DBAppndr.bufferSize = 2

     #just pass through the array of message items in the log statement
     log4j.appender.DBAppndr.layout    = Log::Log4perl::Layout::NoopLayout
     log4j.appender.DBAppndr.warp_message = 0

     #driver attributes support
     log4j.appender.DBAppndr.attrs.f_encoding = utf8
    };

    $logger-&#62;warn( $custid, &#39;big problem!!&#39;, $ip_addr );</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CAVEAT"
>CAVEAT</a></h1>

<p>This is a very young module and there are a lot of variations in setups with different databases and connection methods, so make sure you test thoroughly! Any feedback is welcome!</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This is a specialized Log::Dispatch object customized to work with log4perl and its abilities, originally based on Log::Dispatch::DBI by Tatsuhiko Miyagawa but with heavy modifications.</p>

<p>It is an attempted compromise between what Log::Dispatch::DBI was doing and what log4j&#39;s JDBCAppender does. Note the log4j docs say the JDBCAppender &#34;is very likely to be completely replaced in the future.&#34;</p>

<p>The simplest usage is this:</p>

<pre>    log4j.category = WARN, DBAppndr
    log4j.appender.DBAppndr            = Log::Log4perl::Appender::DBI
    log4j.appender.DBAppndr.datasource = DBI:CSV:f_dir=t/tmp
    log4j.appender.DBAppndr.username   = bobjones
    log4j.appender.DBAppndr.password   = 12345
    log4j.appender.DBAppndr.sql        = \
       INSERT INTO logtbl                \
          (loglevel, message)            \
          VALUES (&#39;%c&#39;,&#39;%m&#39;)

    log4j.appender.DBAppndr.layout    = Log::Log4perl::Layout::PatternLayout


    $logger-&#62;fatal(&#39;fatal message&#39;);
    $logger-&#62;warn(&#39;warning message&#39;);

    ===============================
    |FATAL|fatal message          |
    |WARN |warning message        |
    ===============================</pre>

<p>But the downsides to that usage are:</p>

<ul>
<li>You&#39;d better be darn sure there are not quotes in your log message, or your insert could have unforseen consequences! This is a very insecure way to handle database inserts, using place holders and bind values is much better, keep reading. (Note that the log4j docs warn &#34;Be careful of quotes in your messages!&#34;) <b>*</b>.</li>

<li>It&#39;s not terribly high-performance, a statement is created and executed for each log call.</li>

<li>The only run-time parameter you get is the %m message, in reality you probably want to log specific data in specific table columns.</li>
</ul>

<p>So let&#39;s try using placeholders, and tell the logger to create a prepared statement handle at the beginning and just reuse it (just like Log::Dispatch::DBI does)</p>

<pre>    log4j.appender.DBAppndr.sql = \
       INSERT INTO logtbl \
          (custid, loglevel, message) \
          VALUES (?,?,?)

    #---------------------------------------------------
    #now the bind values:
                                  #1 is the custid
    log4j.appender.DBAppndr.params.2 = %p    
                                  #3 is the message
    #---------------------------------------------------

    log4j.appender.DBAppndr.layout    = Log::Log4perl::Layout::NoopLayout
    log4j.appender.DBAppndr.warp_message = 0
    
    log4j.appender.DBAppndr.usePreparedStmt = 1
    
    
    $logger-&#62;warn( 1234, &#39;warning message&#39; ); </pre>

<p>Now see how we&#39;re using the &#39;?&#39; placeholders in our statement? This means we don&#39;t have to worry about messages that look like</p>

<pre>    invalid input: 1234&#39;;drop table custid;</pre>

<p>fubaring our database!</p>

<p>Normally a list of things in the logging statement gets concatenated into a single string, but setting <code>warp_message</code> to 0 and using the NoopLayout means that in</p>

<pre>    $logger-&#62;warn( 1234, &#39;warning message&#39;, &#39;bgates&#39; );</pre>

<p>the individual list values will still be available for the DBI appender later on. (If <code>warp_message</code> is not set to 0, the default behavior is to join the list elements into a single string. If PatternLayout or SimpleLayout are used, their attempt to <code>render()</code> your layout will result in something like &#34;ARRAY(0x841d8dc)&#34; in your logs. More information on <code>warp_message</code> is in Log::Log4perl::Appender.)</p>

<p>In your insert SQL you can mix up &#39;?&#39; placeholders with conversion specifiers (%c, %p, etc) as you see fit--the logger will match the question marks to params you&#39;ve defined in the config file and populate the rest with values from your list. If there are more &#39;?&#39; placeholders than there are values in your message, it will use undef for the rest. For instance,</p>

<pre>        log4j.appender.DBAppndr.sql =                 \
           insert into log4perltest                   \
           (loglevel, message, datestr, subpoena_id)\
           values (?,?,?,?)
        log4j.appender.DBAppndr.params.1 = %p
        log4j.appender.DBAppndr.params.3 = %d

        log4j.appender.DBAppndr.warp_message=0


        $logger-&#62;info(&#39;arrest him!&#39;, $subpoena_id);</pre>

<p>results in the first &#39;?&#39; placholder being bound to %p, the second to &#34;arrest him!&#34;, the third to the date from &#34;%d&#34;, and the fourth to your $subpoenaid. If you forget the $subpoena_id and just log</p>

<pre>        $logger-&#62;info(&#39;arrest him!&#39;);</pre>

<p>then you just get undef in the fourth column.</p>

<p>If the logger statement is also being handled by other non-DBI appenders, they will just join the list into a string, joined with <code>$Log::Log4perl::JOIN_MSG_ARRAY_CHAR</code> (default is an empty string).</p>

<p>And see the <code>usePreparedStmt</code>? That creates a statement handle when the logger object is created and just reuses it. That, however, may be problematic for long-running processes like webservers, in which case you can use this parameter instead</p>

<pre>    log4j.appender.DBAppndr.bufferSize=2</pre>

<p>This copies log4j&#39;s JDBCAppender&#39;s behavior, it saves up that many log statements and writes them all out at once. If your INSERT statement uses only ? placeholders and no %x conversion specifiers it should be quite efficient because the logger can re-use the same statement handle for the inserts.</p>

<p>If the program ends while the buffer is only partly full, the DESTROY block should flush the remaining statements, if the DESTROY block runs of course.</p>

<p>* <i>As I was writing this, Danko Mannhaupt was coming out with his improved log4j JDBCAppender (http://www.mannhaupt.com/danko/projects/) which overcomes many of the drawbacks of the original JDBCAppender.</i></p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION_2"
>DESCRIPTION 2</a></h1>

<p>Or another way to say the same thing:</p>

<p>The idea is that if you&#39;re logging to a database table, you probably want specific parts of your log information in certain columns. To this end, you pass an list to the log statement, like</p>

<pre>    $logger-&#62;warn(&#39;big problem!!&#39;,$userid,$subpoena_nr,$ip_addr);</pre>

<p>and the array members drop into the positions defined by the placeholders in your SQL statement. You can also define information in the config file like</p>

<pre>    log4j.appender.DBAppndr.params.2 = %p    </pre>

<p>in which case those numbered placeholders will be filled in with the specified values, and the rest of the placeholders will be filled in with the values from your log statement&#39;s array.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="MISC_PARAMETERS"
>MISC PARAMETERS</a></h1>

<dl>
<dt><a name="usePreparedStmt"
>usePreparedStmt</a></dt>

<dd>
<p>See above.</p>

<dt><a name="warp_message"
>warp_message</a></dt>

<dd>
<p>see Log::Log4perl::Appender</p>

<dt><a name="max_col_size"
>max_col_size</a></dt>

<dd>
<p>If you&#39;re used to just throwing debugging messages like huge stacktraces into your logger, some databases (Sybase&#39;s DBD!!) may suprise you by choking on data size limitations. Normally, the data would just be truncated to fit in the column, but Sybases&#39;s DBD it turns out maxes out at 255 characters. Use this parameter in such a situation to truncate long messages before they get to the INSERT statement.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CHANGING_DBH_CONNECTIONS_(POOLING)"
>CHANGING DBH CONNECTIONS (POOLING)</a></h1>

<p>If you want to get your dbh from some place in particular, like maybe a pool, subclass and override _init() and/or create_statement(), for instance</p>

<pre>    sub _init {
        ; #no-op, no pooling at this level
    }
    sub create_statement {
        my ($self, $stmt) = @_;
    
        $stmt || croak &#34;Log4perl: sql not set in &#34;.__PACKAGE__;
    
        return My::Connections-&#62;getConnection-&#62;prepare($stmt) 
            || croak &#34;Log4perl: DBI-&#62;prepare failed $DBI::errstr\n$stmt&#34;;
    }</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="LIFE_OF_CONNECTIONS"
>LIFE OF CONNECTIONS</a></h1>

<p>If you&#39;re using <code>log4j.appender.DBAppndr.usePreparedStmt</code> this module creates an sth when it starts and keeps it for the life of the program. For long-running processes (e.g. mod_perl), connections might go stale, but if <code>Log::Log4perl::Appender::DBI</code> tries to write a message and figures out that the DB connection is no longer working (using DBI&#39;s ping method), it will reconnect.</p>

<p>The reconnection process can be controlled by two parameters, <code>reconnect_attempts</code> and <code>reconnect_sleep</code>. <code>reconnect_attempts</code> specifies the number of reconnections attempts the DBI appender performs until it gives up and dies. <code>reconnect_sleep</code> is the time between reconnection attempts, measured in seconds. <code>reconnect_attempts</code> defaults to 1, <code>reconnect_sleep</code> to 0.</p>

<p>Alternatively, use <code>Apache::DBI</code> or <code>Apache::DBI::Cache</code> and read CHANGING DB CONNECTIONS above.</p>

<p>Note that <code>Log::Log4perl::Appender::DBI</code> holds one connection open for every appender, which might be too many.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p><a href="../../../Log/Dispatch/DBI.html" class="podlinkpod"
>Log::Dispatch::DBI</a></p>

<p><a href="../../../Log/Log4perl/JavaMap/JDBCAppender.html" class="podlinkpod"
>Log::Log4perl::JavaMap::JDBCAppender</a></p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="LICENSE"
>LICENSE</a></h1>

<p>Copyright 2002-2013 by Mike Schilli &#60;m@perlmeister.com&#62; and Kevin Goess &#60;cpan@goess.org&#62;.</p>

<p>This library is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Please contribute patches to the project on Github:</p>

<pre>    http://github.com/mschilli/log4perl</pre>

<p>Send bug reports or requests for enhancements to the authors via our</p>

<p>MAILING LIST (questions, bug reports, suggestions/patches): log4perl-devel@lists.sourceforge.net</p>

<p>Authors (please contact them via the list above, not directly): Mike Schilli &#60;m@perlmeister.com&#62;, Kevin Goess &#60;cpan@goess.org&#62;</p>

<p>Contributors (in alphabetical order): Ateeq Altaf, Cory Bennett, Jens Berthold, Jeremy Bopp, Hutton Davidson, Chris R. Donnelly, Matisse Enzer, Hugh Esco, Anthony Foiani, James FitzGibbon, Carl Franks, Dennis Gregorovic, Andy Grundman, Paul Harrington, Alexander Hartmaier David Hull, Robert Jacobson, Jason Kohles, Jeff Macdonald, Markus Peter, Brett Rann, Peter Rabbitson, Erik Selberg, Aaron Straup Cope, Lars Thegler, David Viner, Mac Yang.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
