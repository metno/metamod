<html><head><title>Catalyst::Authentication::Store::DBIx::Class</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../../../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../../../_grygrnw.css" media="all" >

<script type="text/javascript" src="../../../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:02 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#VERSION'>VERSION</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#CONFIGURATION'>CONFIGURATION</a>
  <li class='indexItem indexItem1'><a href='#USAGE'>USAGE</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Simple_Retrieval'>Simple Retrieval</a>
    <li class='indexItem indexItem2'><a href='#Advanced_Retrieval'>Advanced Retrieval</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#The_dbix_class_key'>The dbix_class key</a>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#METHODS'>METHODS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#new_(_%24config%2C_%24app_)'>new ( $config, $app )</a>
    <li class='indexItem indexItem2'><a href='#find_user_(_%24authinfo%2C_%24c_)'>find_user ( $authinfo, $c )</a>
    <li class='indexItem indexItem2'><a href='#for_session_(_%24c%2C_%24user_)'>for_session ( $c, $user )</a>
    <li class='indexItem indexItem2'><a href='#from_session_(_%24c%2C_%24frozenuser)'>from_session ( $c, $frozenuser)</a>
    <li class='indexItem indexItem2'><a href='#user_supports'>user_supports</a>
    <li class='indexItem indexItem2'><a href='#auto_update_user(_%24authinfo%2C_%24c%2C_%24res_)'>auto_update_user( $authinfo, $c, $res )</a>
    <li class='indexItem indexItem2'><a href='#auto_create_user(_%24authinfo%2C_%24c_)'>auto_create_user( $authinfo, $c )</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#NOTES'>NOTES</a>
  <li class='indexItem indexItem1'><a href='#BUGS_AND_LIMITATIONS'>BUGS AND LIMITATIONS</a>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#LICENSE'>LICENSE</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>Catalyst::Authentication::Store::DBIx::Class - A storage class for Catalyst Authentication using DBIx::Class</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="VERSION"
>VERSION</a></h1>

<p>This documentation refers to version 0.1503.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>    use Catalyst qw/
                    Authentication
                    Authorization::Roles/;

    __PACKAGE__-&#62;config(&#39;Plugin::Authentication&#39; =&#62; {
        default_realm =&#62; &#39;members&#39;,
        realms =&#62; {
            members =&#62; {
                credential =&#62; {
                    class =&#62; &#39;Password&#39;,
                    password_field =&#62; &#39;password&#39;,
                    password_type =&#62; &#39;clear&#39;
                },
                store =&#62; {
                    class =&#62; &#39;DBIx::Class&#39;,
                    user_model =&#62; &#39;MyApp::User&#39;,
                    role_relation =&#62; &#39;roles&#39;,
                    role_field =&#62; &#39;rolename&#39;,
                }
            }
        }
    });

    # Log a user in:

    sub login : Global {
        my ( $self, $ctx ) = @_;

        $ctx-&#62;authenticate({
                          screen_name =&#62; $ctx-&#62;req-&#62;params-&#62;{username},
                          password =&#62; $ctx-&#62;req-&#62;params-&#62;{password},
                          status =&#62; [ &#39;registered&#39;, &#39;loggedin&#39;, &#39;active&#39;]
                          }))
    }

    # verify a role

    if ( $ctx-&#62;check_user_roles( &#39;editor&#39; ) ) {
        # do editor stuff
    }</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>The Catalyst::Authentication::Store::DBIx::Class class provides access to authentication information stored in a database via DBIx::Class.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CONFIGURATION"
>CONFIGURATION</a></h1>

<p>The DBIx::Class authentication store is activated by setting the store config&#39;s <b>class</b> element to DBIx::Class as shown above. See the <a href="../../../../Catalyst/Plugin/Authentication.html" class="podlinkpod"
>Catalyst::Plugin::Authentication</a> documentation for more details on configuring the store. You can also use <a href="../../../../Catalyst/Authentication/Realm/SimpleDB.html" class="podlinkpod"
>Catalyst::Authentication::Realm::SimpleDB</a> for a simplified setup.</p>

<p>The DBIx::Class storage module has several configuration options</p>

<pre>    __PACKAGE__-&#62;config(&#39;Plugin::Authentication&#39; =&#62; {
        default_realm =&#62; &#39;members&#39;,
        realms =&#62; {
            members =&#62; {
                credential =&#62; {
                    # ...
                },
                store =&#62; {
                    class =&#62; &#39;DBIx::Class&#39;,
                    user_model =&#62; &#39;MyApp::User&#39;,
                    role_relation =&#62; &#39;roles&#39;,
                    role_field =&#62; &#39;rolename&#39;,
                    ignore_fields_in_find =&#62; [ &#39;remote_name&#39; ],
                    use_userdata_from_session =&#62; 1,
                }
            }
        }
    });</pre>

<dl>
<dt><a name="class"
>class</a></dt>

<dd>
<p>Class is part of the core Catalyst::Plugin::Authentication module; it contains the class name of the store to be used.</p>

<dt><a name="user_model"
>user_model</a></dt>

<dd>
<p>Contains the model name (as passed to <code>$ctx-&#62;model()</code>) of the DBIx::Class schema to use as the source for user information. This config item is <b>REQUIRED</b>.</p>

<p>(Note that this option used to be called <code>user_class</code>. <code>user_class</code> is still functional, but should be used only for compatibility with previous configs. The setting called <code>user_class</code> on other authentication stores is present, but named <code>store_user_class</code> in this store)</p>

<dt><a name="role_column"
>role_column</a></dt>

<dd>
<p>If your role information is stored in the same table as the rest of your user information, this item tells the module which field contains your role information. The DBIx::Class authentication store expects the data in this field to be a series of role names separated by some combination of spaces, commas, or pipe characters.</p>

<dt><a name="role_relation"
>role_relation</a></dt>

<dd>
<p>If your role information is stored in a separate table, this is the name of the relation that will lead to the roles the user is in. If this is specified, then a role_field is also required. Also when using this method it is expected that your role table will return one row for each role the user is in.</p>

<dt><a name="role_field"
>role_field</a></dt>

<dd>
<p>This is the name of the field in the role table that contains the string identifying the role.</p>

<dt><a name="ignore_fields_in_find"
>ignore_fields_in_find</a></dt>

<dd>
<p>This item is an array containing fields that may be passed to the <code>$ctx-&#62;authenticate()</code> routine (and therefore find_user in the storage class), but which should be ignored when creating the DBIx::Class search to retrieve a user. This makes it possible to avoid problems when a credential requires an authinfo element whose name overlaps with a column name in your users table. If this doesn&#39;t make sense to you, you probably don&#39;t need it.</p>

<dt><a name="use_userdata_from_session"
>use_userdata_from_session</a></dt>

<dd>
<p>Under normal circumstances, on each request the user&#39;s data is re-retrieved from the database using the primary key for the user table. When this flag is set in the configuration, it causes the DBIx::Class store to avoid this database hit on session restore. Instead, the user object&#39;s column data is retrieved from the session and used as-is.</p>

<p><b>NOTE</b>: Since the user object&#39;s column data is only stored in the session during the initial authentication of the user, turning this on can potentially lead to a situation where the data in <code>$ctx-&#62;user</code> is different from what is stored the database. You can force a reload of the data from the database at any time by calling <code>$ctx-&#62;user-&#62;get_object(1);</code> Note that this will update <code>$ctx-&#62;user</code> for the remainder of this request. It will NOT update the session. If you need to update the session you should call <code>$ctx-&#62;update_user_in_session()</code> as well.</p>

<dt><a name="store_user_class"
>store_user_class</a></dt>

<dd>
<p>This allows you to override the authentication user class that the DBIx::Class store module uses to perform its work. Most of the work done in this module is actually done by the user class, <a href="../../../../Catalyst/Authentication/Store/DBIx/Class/User.html" class="podlinkpod"
>Catalyst::Authentication::Store::DBIx::Class::User</a>, so overriding this doesn&#39;t make much sense unless you are using your own class to extend the functionality of the existing class. Chances are you do not want to set this.</p>

<dt><a name="id_field"
>id_field</a></dt>

<dd>
<p>In most cases, this config variable does not need to be set, as Catalyst::Authentication::Store::DBIx::Class will determine the primary key of the user table on its own. If you need to override the default, or your user table has multiple primary keys, then id_field should contain the column name that should be used to restore the user. A given value in this column should correspond to a single user in the database. Note that this is used <b>ONLY</b> when restoring a user from the session and has no bearing whatsoever in the initial authentication process. Note also that if use_userdata_from_session is enabled, this config parameter is not used at all.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="USAGE"
>USAGE</a></h1>

<p>The <a href="../../../../Catalyst/Authentication/Store/DBIx/Class.html" class="podlinkpod"
>Catalyst::Authentication::Store::DBIx::Class</a> storage module is not called directly from application code. You interface with it through the $ctx-&#62;authenticate() call.</p>

<p>There are three methods you can use to retrieve information from the DBIx::Class storage module. They are Simple retrieval, and the advanced retrieval methods Searchargs and Resultset.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Simple_Retrieval"
>Simple Retrieval</a></h2>

<p>The first, and most common, method is simple retrieval. As its name implies simple retrieval allows you to simply to provide the column =&#62; value pairs that should be used to locate the user in question. An example of this usage is below:</p>

<pre>    if ($ctx-&#62;authenticate({
                          screen_name =&#62; $ctx-&#62;req-&#62;params-&#62;{&#39;username&#39;},
                          password =&#62; $ctx-&#62;req-&#62;params-&#62;{&#39;password&#39;},
                          status =&#62; [ &#39;registered&#39;, &#39;active&#39;, &#39;loggedin&#39;]
                         })) {

        # ... authenticated user code here
    }</pre>

<p>The above example would attempt to retrieve a user whose username column (here, screen_name) matched the username provided, and whose status column matched one of the values provided. These name =&#62; value pairs are used more or less directly in the DBIx::Class search() routine, so in most cases, you can use DBIx::Class syntax to retrieve the user according to whatever rules you have.</p>

<p>NOTE: Because the password in most cases is encrypted - it is not used directly but its encryption and comparison with the value provided is usually handled by the Password Credential. Part of the Password Credential&#39;s behavior is to remove the password argument from the authinfo that is passed to the storage module. See <a href="../../../../Catalyst/Authentication/Credential/Password.html" class="podlinkpod"
>Catalyst::Authentication::Credential::Password</a>.</p>

<p>One thing you need to know about this retrieval method is that the name portion of the pair is checked against the user class&#39;s column list. Pairs are only used if a matching column is found. Other pairs will be ignored. This means that you can only provide simple name-value pairs, and that some more advanced DBIx::Class constructs, such as &#39;-or&#39;, &#39;-and&#39;, etc. are in most cases not possible using this method. For queries that require this level of functionality, see the &#39;searchargs&#39; method below.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Advanced_Retrieval"
>Advanced Retrieval</a></h2>

<p>The Searchargs and Resultset retrieval methods are used when more advanced features of the underlying <a href="../../../../DBIx/Class.html" class="podlinkpod"
>DBIx::Class</a> schema are required. These methods provide a direct interface with the DBIx::Class schema and therefore require a better understanding of the DBIx::Class module.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="The_dbix_class_key"
>The dbix_class key</a></h3>

<p>Since the format of these arguments are often complex, they are not keys in the base authinfo hash. Instead, both of these arguments are placed within a hash attached to the store-specific &#39;dbix_class&#39; key in the base $authinfo hash. When the DBIx::Class authentication store sees the &#39;dbix_class&#39; key in the passed authinfo hash, all the other information in the authinfo hash is ignored and only the values within the &#39;dbix_class&#39; hash are used as though they were passed directly within the authinfo hash. In other words, if &#39;dbix_class&#39; is present, it replaces the authinfo hash for processing purposes.</p>

<p>The &#39;dbix_class&#39; hash can be used to directly pass arguments to the DBIx::Class authentication store. Reasons to do this are to avoid credential modification of the authinfo hash, or to avoid overlap between credential and store key names. It&#39;s a good idea to avoid using it in this way unless you are sure you have an overlap/modification issue. However, the two advanced retrieval methods, <b>searchargs</b>, <b>result</b> and <b>resultset</b>, require its use, as they are only processed as part of the &#39;dbix_class&#39; hash.</p>

<dl>
<dt><a name="Searchargs"
>Searchargs</a></dt>

<dd>
<p>The <b>searchargs</b> method of retrieval allows you to specify an arrayref containing the two arguments to the search() method from <a href="../../../../DBIx/Class/ResultSet.html" class="podlinkpod"
>DBIx::Class::ResultSet</a>. If provided, all other args are ignored, and the search args provided are used directly to locate the user. An example will probably make more sense:</p>

<pre>    if ($ctx-&#62;authenticate(
        {
            password =&#62; $password,
            &#39;dbix_class&#39; =&#62;
                {
                    searchargs =&#62; [ { -or =&#62; [ username =&#62; $username,
                                              email =&#62; $email,
                                              clientid =&#62; $clientid ]
                                   },
                                   { prefetch =&#62; qw/ preferences / }
                                 ]
                }
        } ) )
    {
        # do successful authentication actions here.
    }</pre>

<p>The above would allow authentication based on any of the three items - username, email, or clientid - and would prefetch the data related to that user from the preferences table. The searchargs array is passed directly to the search() method associated with the user_model.</p>

<dt><a name="Result"
>Result</a></dt>

<dd>
<p>The <b>result</b> method of retrieval allows you to look up the user yourself and pass on the loaded user to the authentication store.</p>

<pre>    my $user = $ctx-&#62;model(&#39;MyApp::User&#39;)-&#62;find({ ... });

    if ($ctx-&#62;authenticate({ dbix_class =&#62; { result =&#62; $user } })) {
        ...
    }</pre>

<p>Be aware that the result method will not verify that you are passing a result that is attached to the same user_model as specified in the config or even loaded from the database, as opposed to existing only in memory. It&#39;s your responsibility to make sure of that.</p>

<dt><a name="Resultset"
>Resultset</a></dt>

<dd>
<p>The <b>resultset</b> method of retrieval allows you to directly specify a resultset to be used for user retrieval. This allows you to create a resultset within your login action and use it for retrieving the user. A simple example:</p>

<pre>    my $rs = $ctx-&#62;model(&#39;MyApp::User&#39;)-&#62;search({ email =&#62; $ctx-&#62;request-&#62;params-&#62;{&#39;email&#39;} });
       ... # further $rs adjustments

    if ($ctx-&#62;authenticate({
                           password =&#62; $password,
                           &#39;dbix_class&#39; =&#62; { resultset =&#62; $rs }
                         })) {
       # do successful authentication actions here.
    }</pre>

<p>Be aware that the resultset method will not verify that you are passing a resultset that is attached to the same user_model as specified in the config.</p>

<p>NOTE: The resultset and searchargs methods of user retrieval, consider the first row returned to be the matching user. In most cases there will be only one matching row, but it is easy to produce multiple rows, especially when using the advanced retrieval methods. Remember, what you get when you use this module is what you would get when calling search(...)-&#62;first;</p>

<p>NOTE ALSO: The user info used to save the user to the session and to retrieve it is the same regardless of what method of retrieval was used. In short, the value in the id field (see &#39;id_field&#39; config item) is used to retrieve the user from the database upon restoring from the session. When the DBIx::Class storage module does this, it does so by doing a simple search using the id field. In other words, it will not use the same arguments you used to request the user initially. This is especially important to those using the advanced methods of user retrieval. If you need more complicated logic when reviving the user from the session, you will most likely want to subclass the <a href="../../../../Catalyst/Authentication/Store/DBIx/Class/User.html" class="podlinkpod"
>Catalyst::Authentication::Store::DBIx::Class::User</a> class and provide your own for_session and from_session routines.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="METHODS"
>METHODS</a></h1>

<p>There are no publicly exported routines in the DBIx::Class authentication store (or indeed in most authentication stores). However, below is a description of the routines required by <a href="../../../../Catalyst/Plugin/Authentication.html" class="podlinkpod"
>Catalyst::Plugin::Authentication</a> for all authentication stores. Please see the documentation for <a href="../../../../Catalyst/Plugin/Authentication/Internals.html" class="podlinkpod"
>Catalyst::Plugin::Authentication::Internals</a> for more information.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="new_(_$config,_$app_)"
>new ( $config, $app )</a></h2>

<p>Constructs a new store object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="find_user_(_$authinfo,_$c_)"
>find_user ( $authinfo, $c )</a></h2>

<p>Finds a user using the information provided in the $authinfo hashref and returns the user, or undef on failure. This is usually called from the Credential. This translates directly to a call to <a href="../../../../Catalyst/Authentication/Store/DBIx/Class/User.html" class="podlinkpod"
>Catalyst::Authentication::Store::DBIx::Class::User</a>&#39;s load() method.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="for_session_(_$c,_$user_)"
>for_session ( $c, $user )</a></h2>

<p>Prepares a user to be stored in the session. Currently returns the value of the user&#39;s id field (as indicated by the &#39;id_field&#39; config element)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="from_session_(_$c,_$frozenuser)"
>from_session ( $c, $frozenuser)</a></h2>

<p>Revives a user from the session based on the info provided in $frozenuser. Currently treats $frozenuser as an id and retrieves a user with a matching id.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="user_supports"
>user_supports</a></h2>

<p>Provides information about what the user object supports.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="auto_update_user(_$authinfo,_$c,_$res_)"
>auto_update_user( $authinfo, $c, $res )</a></h2>

<p>This method is called if the realm&#39;s auto_update_user setting is true. It will delegate to the user object&#39;s <code>auto_update</code> method.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="auto_create_user(_$authinfo,_$c_)"
>auto_create_user( $authinfo, $c )</a></h2>

<p>This method is called if the realm&#39;s auto_create_user setting is true. It will delegate to the user class&#39;s (resultset) <code>auto_create</code> method.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NOTES"
>NOTES</a></h1>

<p>As of the current release, session storage consists of simply storing the user&#39;s id in the session, and then using that same id to re-retrieve the user&#39;s information from the database upon restoration from the session. More dynamic storage of user information in the session is intended for a future release.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="BUGS_AND_LIMITATIONS"
>BUGS AND LIMITATIONS</a></h1>

<p>None known currently; please email the author if you find any.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p><a href="../../../../Catalyst/Plugin/Authentication.html" class="podlinkpod"
>Catalyst::Plugin::Authentication</a>, <a href="../../../../Catalyst/Plugin/Authentication/Internals.html" class="podlinkpod"
>Catalyst::Plugin::Authentication::Internals</a>, and <a href="../../../../Catalyst/Plugin/Authorization/Roles.html" class="podlinkpod"
>Catalyst::Plugin::Authorization::Roles</a></p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Jason Kuri (jayk@cpan.org)</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="LICENSE"
>LICENSE</a></h1>

<p>Copyright (c) 2007 the aforementioned authors. All rights reserved. This program is free software; you can redistribute it and/or modify it under the same terms as Perl itself.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
