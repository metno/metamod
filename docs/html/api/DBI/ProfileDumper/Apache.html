<html><head><title>DBI::ProfileDumper::Apache</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >

<script type="text/javascript" src="../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:15 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#USAGE'>USAGE</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#LOADING_THE_MODULE'>LOADING THE MODULE</a>
    <li class='indexItem indexItem2'><a href='#WRITING_PROFILE_DATA'>WRITING PROFILE DATA</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#When_using_mod_perl2'>When using mod_perl2</a>
      <li class='indexItem indexItem3'><a href='#Naming_the_files'>Naming the files</a>
      <li class='indexItem indexItem3'><a href='#Silencing_the_log'>Silencing the log</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#GATHERING_PROFILE_DATA'>GATHERING PROFILE DATA</a>
    <li class='indexItem indexItem2'><a href='#CLEANING_UP'>CLEANING UP</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#OTHER_ISSUES'>OTHER ISSUES</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Memory_usage'>Memory usage</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#COPYRIGHT_AND_LICENSE'>COPYRIGHT AND LICENSE</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>DBI::ProfileDumper::Apache - capture DBI profiling data from Apache/mod_perl</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p>Add this line to your <em>httpd.conf</em>:</p>

<pre>  PerlSetEnv DBI_PROFILE 2/DBI::ProfileDumper::Apache</pre>

<p>(If you&#39;re using mod_perl2, see <a href="#When_using_mod_perl2" class="podlinkpod"
>&#34;When using mod_perl2&#34;</a> for some additional notes.)</p>

<p>Then restart your server. Access the code you wish to test using a web browser, then shutdown your server. This will create a set of <em>dbi.prof.*</em> files in your Apache log directory.</p>

<p>Get a profiling report with <a href="../../dbiprof.html" class="podlinkpod"
>dbiprof</a>:</p>

<pre>  dbiprof /path/to/your/apache/logs/dbi.prof.*</pre>

<p>When you&#39;re ready to perform another profiling run, delete the old files and start again.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module interfaces DBI::ProfileDumper to Apache/mod_perl. Using this module you can collect profiling data from mod_perl applications. It works by creating a DBI::ProfileDumper data file for each Apache process. These files are created in your Apache log directory. You can then use the dbiprof utility to analyze the profile files.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="USAGE"
>USAGE</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="LOADING_THE_MODULE"
>LOADING THE MODULE</a></h2>

<p>The easiest way to use this module is just to set the DBI_PROFILE environment variable in your <em>httpd.conf</em>:</p>

<pre>  PerlSetEnv DBI_PROFILE 2/DBI::ProfileDumper::Apache</pre>

<p>The DBI will look after loading and using the module when the first DBI handle is created.</p>

<p>It&#39;s also possible to use this module by setting the Profile attribute of any DBI handle:</p>

<pre>  $dbh-&#62;{Profile} = &#34;2/DBI::ProfileDumper::Apache&#34;;</pre>

<p>See <a href="../../DBI/ProfileDumper.html" class="podlinkpod"
>DBI::ProfileDumper</a> for more possibilities, and <a href="../../DBI/Profile.html" class="podlinkpod"
>DBI::Profile</a> for full details of the DBI&#39;s profiling mechanism.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="WRITING_PROFILE_DATA"
>WRITING PROFILE DATA</a></h2>

<p>The profile data files will be written to your Apache log directory by default.</p>

<p>The user that the httpd processes run as will need write access to the directory. So, for example, if you&#39;re running the child httpds as user &#39;nobody&#39; and using chronolog to write to the logs directory, then you&#39;ll need to change the default.</p>

<p>You can change the destination directory either by specifying a <code>Dir</code> value when creating the profile (like <code>File</code> in the <a href="../../DBI/ProfileDumper.html" class="podlinkpod"
>DBI::ProfileDumper</a> docs), or you can use the <code>DBI_PROFILE_APACHE_LOG_DIR</code> env var to change that. For example:</p>

<pre>  PerlSetEnv DBI_PROFILE_APACHE_LOG_DIR /server_root/logs</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="When_using_mod_perl2"
>When using mod_perl2</a></h3>

<p>Under mod_perl2 you&#39;ll need to either set the <code>DBI_PROFILE_APACHE_LOG_DIR</code> env var, or enable the mod_perl2 <code>GlobalRequest</code> option, like this:</p>

<pre>  PerlOptions +GlobalRequest</pre>

<p>to the global config section you&#39;re about test with DBI::ProfileDumper::Apache. If you don&#39;t do one of those then you&#39;ll see messages in your error_log similar to:</p>

<pre>  DBI::ProfileDumper::Apache on_destroy failed: Global $r object is not available. Set:
    PerlOptions +GlobalRequest in httpd.conf at ..../DBI/ProfileDumper/Apache.pm line 144</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Naming_the_files"
>Naming the files</a></h3>

<p>The default file name is inherited from <a href="../../DBI/ProfileDumper.html" class="podlinkpod"
>DBI::ProfileDumper</a> via the filename() method, but DBI::ProfileDumper::Apache appends the parent pid and the current pid, separated by dots, to that name.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="Silencing_the_log"
>Silencing the log</a></h3>

<p>By default a message is written to STDERR (i.e., the apache error_log file) when flush_to_disk() is called (either explicitly, or implicitly via DESTROY).</p>

<p>That&#39;s usually very useful. If you don&#39;t want the log message you can silence it by setting the <code>Quiet</code> attribute true.</p>

<pre>  PerlSetEnv DBI_PROFILE 2/DBI::ProfileDumper::Apache/Quiet:1

  $dbh-&#62;{Profile} = &#34;!Statement/DBI::ProfileDumper/Quiet:1&#34;;

  $dbh-&#62;{Profile} = DBI::ProfileDumper-&#62;new(
      Path =&#62; [ &#39;!Statement&#39; ]
      Quiet =&#62; 1
  );</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GATHERING_PROFILE_DATA"
>GATHERING PROFILE DATA</a></h2>

<p>Once you have the module loaded, use your application as you normally would. Stop the webserver when your tests are complete. Profile data files will be produced when Apache exits and you&#39;ll see something like this in your error_log:</p>

<pre>  DBI::ProfileDumper::Apache writing to /usr/local/apache/logs/dbi.prof.2604.2619</pre>

<p>Now you can use dbiprof to examine the data:</p>

<pre>  dbiprof /usr/local/apache/logs/dbi.prof.2604.*</pre>

<p>By passing dbiprof a list of all generated files, dbiprof will automatically merge them into one result set. You can also pass dbiprof sorting and querying options, see <a href="../../dbiprof.html" class="podlinkpod"
>dbiprof</a> for details.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CLEANING_UP"
>CLEANING UP</a></h2>

<p>Once you&#39;ve made some code changes, you&#39;re ready to start again. First, delete the old profile data files:</p>

<pre>  rm /usr/local/apache/logs/dbi.prof.*</pre>

<p>Then restart your server and get back to work.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="OTHER_ISSUES"
>OTHER ISSUES</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Memory_usage"
>Memory usage</a></h2>

<p>DBI::Profile can use a lot of memory for very active applications because it collects profiling data in memory for each distinct query run. Calling <code>flush_to_disk()</code> will write the current data to disk and free the memory it&#39;s using. For example:</p>

<pre>  $dbh-&#62;{Profile}-&#62;flush_to_disk() if $dbh-&#62;{Profile};</pre>

<p>or, rather than flush every time, you could flush less often:</p>

<pre>  $dbh-&#62;{Profile}-&#62;flush_to_disk()
    if $dbh-&#62;{Profile} and ++$i % 100;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Sam Tregar &#60;sam@tregar.com&#62;</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="COPYRIGHT_AND_LICENSE"
>COPYRIGHT AND LICENSE</a></h1>

<p>Copyright (C) 2002 Sam Tregar</p>

<p>This program is free software; you can redistribute it and/or modify it under the same terms as Perl 5 itself.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
