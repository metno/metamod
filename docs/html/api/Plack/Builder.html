<html><head><title>Plack::Builder</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:25 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#INLINE_MIDDLEWARE'>INLINE MIDDLEWARE</a>
  <li class='indexItem indexItem1'><a href='#URLMap_support'>URLMap support</a>
  <li class='indexItem indexItem1'><a href='#CONDITIONAL_MIDDLEWARE_SUPPORT'>CONDITIONAL MIDDLEWARE SUPPORT</a>
  <li class='indexItem indexItem1'><a href='#OBJECT_ORIENTED_INTERFACE'>OBJECT ORIENTED INTERFACE</a>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>Plack::Builder - OO and DSL to enable Plack Middlewares</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  # in .psgi
  use Plack::Builder;

  my $app = sub { ... };

  builder {
      enable &#34;Deflater&#34;;
      enable &#34;Session&#34;, store =&#62; &#34;File&#34;;
      enable &#34;Debug&#34;, panels =&#62; [ qw(DBITrace Memory Timer) ];
      enable &#34;+My::Plack::Middleware&#34;;
      $app;
  };

  # use URLMap

  builder {
      mount &#34;/foo&#34; =&#62; builder {
          enable &#34;Foo&#34;;
          $app;
      };

      mount &#34;/bar&#34; =&#62; $app2;
      mount &#34;http://example.com/&#34; =&#62; builder { $app3 };
  };

  # using OO interface
  my $builder = Plack::Builder-&#62;new;
  $builder-&#62;add_middleware(&#39;Foo&#39;, opt =&#62; 1);
  $builder-&#62;add_middleware(&#39;Bar&#39;);
  $builder-&#62;wrap($app);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>Plack::Builder gives you a quick domain specific language (DSL) to wrap your application with <a href="../Plack/Middleware.html" class="podlinkpod"
>Plack::Middleware</a> subclasses. The middleware you&#39;re trying to use should use <a href="../Plack/Middleware.html" class="podlinkpod"
>Plack::Middleware</a> as a base class to use this DSL, inspired by Rack::Builder.</p>

<p>Whenever you call <code>enable</code> on any middleware, the middleware app is pushed to the stack inside the builder, and then reversed when it actually creates a wrapped application handler. <code>&#34;Plack::Middleware::&#34;</code> is added as a prefix by default. So:</p>

<pre>  builder {
      enable &#34;Foo&#34;;
      enable &#34;Bar&#34;, opt =&#62; &#34;val&#34;;
      $app;
  };</pre>

<p>is syntactically equal to:</p>

<pre>  $app = Plack::Middleware::Bar-&#62;wrap($app, opt =&#62; &#34;val&#34;);
  $app = Plack::Middleware::Foo-&#62;wrap($app);</pre>

<p>In other words, you&#39;re supposed to <code>enable</code> middleware from outer to inner.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="INLINE_MIDDLEWARE"
>INLINE MIDDLEWARE</a></h1>

<p>Plack::Builder allows you to code middleware inline using a nested code reference.</p>

<p>If the first argument to <code>enable</code> is a code reference, it will be passed an <code>$app</code> and should return another code reference which is a PSGI application that consumes <code>$env</code> at runtime. So:</p>

<pre>  builder {
      enable sub {
          my $app = shift;
          sub {
              my $env = shift;
              # do preprocessing
              my $res = $app-&#62;($env);
              # do postprocessing
              return $res;
          };
      };
      $app;
  };</pre>

<p>is equal to:</p>

<pre>  my $mw = sub {
      my $app = shift;
      sub { my $env = shift; $app-&#62;($env) };
  };

  $app = $mw-&#62;($app);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="URLMap_support"
>URLMap support</a></h1>

<p>Plack::Builder has a native support for <a href="../Plack/App/URLMap.html" class="podlinkpod"
>Plack::App::URLMap</a> via the <code>mount</code> method.</p>

<pre>  use Plack::Builder;
  my $app = builder {
      mount &#34;/foo&#34; =&#62; $app1;
      mount &#34;/bar&#34; =&#62; builder {
          enable &#34;Foo&#34;;
          $app2;
      };
  };</pre>

<p>See <a href="../Plack/App/URLMap.html" class="podlinkpod"
>Plack::App::URLMap</a>&#39;s <code>map</code> method to see what they mean. With <code>builder</code> you can&#39;t use <code>map</code> as a DSL, for the obvious reason :)</p>

<p><b>NOTE</b>: Once you use <code>mount</code> in your builder code, you have to use <code>mount</code> for all the paths, including the root path (<code>/</code>). You can&#39;t have the default app in the last line of <code>builder</code> like:</p>

<pre>  my $app = sub {
      my $env = shift;
      ...
  };

  builder {
      mount &#34;/foo&#34; =&#62; sub { ... };
      $app; # THIS DOESN&#39;T WORK
  };</pre>

<p>You&#39;ll get warnings saying that your mount configuration will be ignored. Instead you should use <code>mount &#34;/&#34; =&#62; ...</code> in the last line to set the default fallback app.</p>

<pre>  builder {
      mount &#34;/foo&#34; =&#62; sub { ... };
      mount &#34;/&#34; =&#62; $app;
  }</pre>

<p>Note that the <code>builder</code> DSL returns a whole new PSGI application, which means</p>

<ul>
<li><code>builder { ... }</code> should normally the last statement of a <code>.psgi</code> file, because the return value of <code>builder</code> is the application that is actually executed.</li>

<li>You can nest your <code>builder</code> blocks, mixed with <code>mount</code> statements (see <a href="#URLMap_support" class="podlinkpod"
>&#34;URLMap support&#34;</a> above):
<pre>  builder {
      mount &#34;/foo&#34; =&#62; builder {
          mount &#34;/bar&#34; =&#62; $app;
      }
  }</pre>

<p>will locate the <code>$app</code> under <code>/foo/bar</code>, since the inner <code>builder</code> block puts it under <code>/bar</code> and it results in a new PSGI application which is located under <code>/foo</code> because of the outer <code>builder</code> block.</p>
</li>
</ul>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CONDITIONAL_MIDDLEWARE_SUPPORT"
>CONDITIONAL MIDDLEWARE SUPPORT</a></h1>

<p>You can use <code>enable_if</code> to conditionally enable middleware based on the runtime environment.</p>

<pre>  builder {
      enable_if { $_[0]-&#62;{REMOTE_ADDR} eq &#39;127.0.0.1&#39; } &#39;StackTrace&#39;, force =&#62; 1;
      $app;
  };</pre>

<p>See <a href="../Plack/Middleware/Conditional.html" class="podlinkpod"
>Plack::Middleware::Conditional</a> for details.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="OBJECT_ORIENTED_INTERFACE"
>OBJECT ORIENTED INTERFACE</a></h1>

<p>Object oriented interface supports the same functionality with the DSL version in a clearer interace, probably with more typing required.</p>

<pre>  # With mount
  my $builder = Plack::Builder-&#62;new;
  $builder-&#62;add_middleware(&#39;Foo&#39;, opt =&#62; 1);
  $builder-&#62;mount(&#39;/foo&#39; =&#62; $foo_app);
  $builder-&#62;mount(&#39;/&#39; =&#62; $root_app);
  $builder-&#62;to_app;

  # Nested builders. Equivalent to:
  # builder {
  #     mount &#39;/foo&#39; =&#62; builder {
  #         enable &#39;Foo&#39;;
  #         $app;
  #     };
  #     mount &#39;/&#39; =&#62; $app2;
  # };
  my $builder_out = Plack::Builder-&#62;new;
  my $builder_in  = Plack::Builder-&#62;new;
  $builder_in-&#62;add_middleware(&#39;Foo&#39;);
  $builder_out-&#62;mount(&#34;/foo&#34; =&#62; $builder_in-&#62;wrap($app));
  $builder_out-&#62;mount(&#34;/&#34; =&#62; $app2);
  $builder_out-&#62;to_app;

  # conditional. You can also directly use Plack::Middleware::Conditional
  my $builder = Plack::Builder-&#62;new;
  $builder-&#62;add_middleware_if(sub { $_[0]-&#62;{REMOTE_ADDR} eq &#39;127.0.0.1&#39; }, &#39;StackTrace&#39;);
  $builder-&#62;wrap($app);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p><a href="../Plack/Middleware.html" class="podlinkpod"
>Plack::Middleware</a> <a href="../Plack/App/URLMap.html" class="podlinkpod"
>Plack::App::URLMap</a> <a href="../Plack/Middleware/Conditional.html" class="podlinkpod"
>Plack::Middleware::Conditional</a></p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
