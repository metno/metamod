<html><head><title>PDL::ParallelCPU</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:24 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#Terminology'>Terminology</a>
  <li class='indexItem indexItem1'><a href='#Functions_that_control_PDL_PThreads'>Functions that control PDL PThreads</a>
  <li class='indexItem indexItem1'><a href='#Global_Control_of_PDL_PThreading_using_Environment_Variables'>Global Control of PDL PThreading using Environment Variables</a>
  <li class='indexItem indexItem1'><a href='#How_It_Works'>How It Works</a>
  <li class='indexItem indexItem1'><a href='#Limitations'>Limitations</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Must_have_POSIX_Threads_Enabled'>Must have POSIX Threads Enabled</a>
    <li class='indexItem indexItem2'><a href='#Non-Threadsafe_Code'>Non-Threadsafe Code</a>
    <li class='indexItem indexItem2'><a href='#Size_of_PDL_Dimensions_and_PThread_Target'>Size of PDL Dimensions and PThread Target</a>
    <li class='indexItem indexItem2'><a href='#Speed_improvement_might_be_less_than_you_expect.'>Speed improvement might be less than you expect.</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#COPYRIGHT'>COPYRIGHT</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>PDL::ParallelCPU - Parallel Processor MultiThreading Support in PDL (Experimental)</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>PDL has support (currently experimental) for splitting up numerical processing between multiple parallel processor threads (or pthreads) using the <i>set_autopthread_targ</i> and <i>set_autopthread_size</i> functions.
This can improve processing performance (by greater than 2-4X in most cases) by taking advantage of multi-core and/or multi-processor machines.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  use PDL;
  
  # Set target of 4 parallel pthreads to create, with a lower limit of
  #  5Meg elements for splitting processing into parallel pthreads.
  set_autopthread_targ(4);
  set_autopthread_size(5);
  
  $a = zeroes(5000,5000); # Create 25Meg element array
  
  $b = $a + 5; # Processing will be split up into multiple pthreads
  
  # Get the actual number of pthreads for the last
  #  processing operation.
  $actualPthreads = get_autopthread_actual();</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Terminology"
>Terminology</a></h1>

<p>The use of the term <i>threading</i> can be confusing with PDL, because it can refer to <i>PDL threading</i>, as defined in the <a href="../PDL/Threading.html" class="podlinkpod"
>PDL::Threading</a> docs, or to <i>processor multi-threading</i>.</p>

<p>To reduce confusion with the existing PDL threading terminology, this document uses <b>pthreading</b> to refer to <i>processor multi-threading</i>, which is the use of multiple processor threads to split up numerical processing into parallel operations.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Functions_that_control_PDL_PThreads"
>Functions that control PDL PThreads</a></h1>

<p>This is a brief listing and description of the PDL pthreading functions, see the <a href="../PDL/Core.html" class="podlinkpod"
>PDL::Core</a> docs for detailed information.</p>

<dl>
<dt><a name="set_autopthread_targ"
>set_autopthread_targ</a></dt>

<dd>
<p>Set the target number of processor-threads (pthreads) for multi-threaded processing. Setting auto_pthread_targ to 0 means that no pthreading will occur.</p>

<p>See <a href="../set_autopthread_targ.html" class="podlinkpod"
>PDL::Core</a> for details.</p>

<dt><a name="set_autopthread_size"
>set_autopthread_size</a></dt>

<dd>
<p>Set the minimum size (in Meg-elements or 2**20 elements) of the largest PDL involved in a function where auto-pthreading will be performed. For small PDLs, it probably isn&#39;t worth starting multiple pthreads, so this function is used to define a minimum threshold where auto-pthreading won&#39;t be attempted.</p>

<p>See <a href="../set_autopthread_size.html" class="podlinkpod"
>PDL::Core</a> for details.</p>

<dt><a name="get_autopthread_actual"
>get_autopthread_actual</a></dt>

<dd>
<p>Get the actual number of pthreads executed for the last pdl processing function.</p>

<p>See <a href="../PDL/get_autopthread_actual.html" class="podlinkpod"
>PDL::get_autopthread_actual</a> for details.</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Global_Control_of_PDL_PThreading_using_Environment_Variables"
>Global Control of PDL PThreading using Environment Variables</a></h1>

<p>PDL PThreading can be globally turned on, without modifying existing code by setting environment variables <b>PDL_AUTOPTHREAD_TARG</b> and <b>PDL_AUTOPTHREAD_SIZE</b> before running a PDL script. These environment variables are checked when PDL starts up and calls to <i>set_autopthread_targ</i> and <i>set_autopthread_size</i> functions made with the environment variable&#39;s values.</p>

<p>For example, if the environment var <b>PDL_AUTOPTHREAD_TARG</b> is set to 3, and <b>PDL_AUTOPTHREAD_SIZE</b> is set to 10, then any pdl script will run as if the following lines were at the top of the file:</p>

<pre> set_autopthread_targ(3);
 set_autopthread_size(10);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="How_It_Works"
>How It Works</a></h1>

<p>The auto-pthreading process works by analyzing threaded array dimensions in PDL operations and splitting up processing based on the thread dimension sizes and desired number of pthreads (i.e. the pthread target or pthread_targ). The offsets and increments that PDL uses to step thru the data in memory are modified for each pthread so each one sees a different set of data when performing processing.</p>

<p><b>Example</b></p>

<pre> $a = sequence(20,4,3); # Small 3-D Array, size 20,4,3
 
 # Setup auto-pthreading:
 set_autopthread_targ(2); # Target of 2 pthreads
 set_autopthread_size(0); # Zero so that the small PDLs in this example will be pthreaded

 # This will be split up into 2 pthreads
 $c = maximum($a);</pre>

<p>For the above example, the <i>maximum</i> function has a signature of <code>(a(n); [o]c())</code>, which means that the first dimension of $a (size 20) is a <i>Core</i> dimension of the <i>maximum</i> function. The other dimensions of $a (size 4,3) are <i>threaded</i> dimensions (i.e. will be threaded-over in the <i>maximum</i> function.</p>

<p>The auto-pthreading algorithm examines the threaded dims of size (4,3) and picks the 4 dimension, since it is evenly divisible by the autopthread_targ of 2. The processing of the maximum function is then split into two pthreads on the size-4 dimension, with dim indexes 0,2 processed by one pthread and dim indexes 1,3 processed by the other pthread.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Limitations"
>Limitations</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Must_have_POSIX_Threads_Enabled"
>Must have POSIX Threads Enabled</a></h2>

<p>Auto-PThreading only works if your PDL installation was compiled with POSIX threads enabled. This is normally the case if you are running on linux, or other unix variants.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Non-Threadsafe_Code"
>Non-Threadsafe Code</a></h2>

<p>Not all the libraries that PDL intefaces to are thread-safe, i.e. they aren&#39;t written to operate in a multi-threaded environment without crashing or causing side-effects. Some examples in the PDL core is the <i>fft</i> function and the <i>pnmout</i> functions.</p>

<p>To operate properly with these types of functions, the PPCode flag <b>NoPthread</b> has been introduced to indicate a function as <i>not</i> being pthread-safe. See <a href="../PDL/PP.html" class="podlinkpod"
>PDL::PP</a> docs for details.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Size_of_PDL_Dimensions_and_PThread_Target"
>Size of PDL Dimensions and PThread Target</a></h2>

<p>Due to the way a PDL is split-up for operation using multiple pthreads, the size of a dimension must be evenly divisible by the pthread target. For example, if a PDL has threaded dimension sizes of (4,3,3) and the <i>auto_pthread_targ</i> has been set to 2, then the first threaded dimension (size 4) will be picked to be split up into two pthreads of size 2 and 2. However, if the threaded dimension sizes are (3,3,3) and the <i>auto_pthread_targ</i> is still 2, then pthreading won&#39;t occur, because no threaded dimensions are divisible by 2.</p>

<p>The algorithm that picks the actual number of pthreads has some smarts (but could probably be improved) to adjust down from the <i>auto_pthread_targ</i> to get a number of pthreads that can evenly divide one of the threaded dimensions. For example, if a PDL has threaded dimension sizes of (9,2,2) and the <i>auto_pthread_targ</i> is 4, the algorithm will see that no dimension is divisible by 4, then adjust down the target to 3, resulting in splitting up the first threaded dimension (size 9) into 3 pthreads.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Speed_improvement_might_be_less_than_you_expect."
>Speed improvement might be less than you expect.</a></h2>

<p>If you have a 8 core machine and call <i>auto_pthread_targ</i> with 8 to generate 8 parallel pthreads, you probably won&#39;t get a 8X improvement in speed, due to memory bandwidth issues. Even though you have 8 separate CPUs crunching away on data, you will have (for most common machine architectures) common RAM that now becomes your bottleneck. For simple calculations (e.g simple additions) you can run into a performance limit at about 4 pthreads. For more complex calculations the limit will be higher.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="COPYRIGHT"
>COPYRIGHT</a></h1>

<p>Copyright 2011 John Cerney. You can distribute and/or modify this document under the same terms as the current Perl license.</p>

<p>See: http://dev.perl.org/licenses/</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
