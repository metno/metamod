<html><head><title>PDL::Fit::LM</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >

<script type="text/javascript" src="../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:23 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#lmfit'>lmfit</a>
    <li class='indexItem indexItem2'><a href='#tlmfit'>tlmfit</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#BUGS'>BUGS</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>PDL::Fit::LM -- Levenberg-Marquardt fitting routine for PDL</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module provides fitting functions for PDL.
Currently,
only Levenberg-Marquardt fitting is implemented.
Other procedures should be added as required.
For a fairly concise overview on fitting see Numerical Recipes,
chapter 15 &#34;Modeling of data&#34;.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre> use PDL::Fit::LM;
 $ym = lmfit $x, $y, $sig, \&#38;expfunc, $a, {Maxiter =&#62; 300};</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="lmfit"
>lmfit</a></h2>

<p>Levenberg-Marquardt fitting of a user supplied model function</p>

<pre> ($ym,$a,$covar,$iters) =
      lmfit $x, $y, $sig, \&#38;expfunc, $a, {Maxiter =&#62; 300, Eps =&#62; 1e-3};</pre>

<p>Options:</p>

<pre> Maxiter:  maximum number of iterations before giving up
 Eps:      convergence citerium for fit; success when normalized change
           in chisquare smaller than Eps</pre>

<p>The user supplied sub routine reference should accept 4 arguments</p>

<ul>
<li>a vector of independent values $x</li>

<li>a vector of fitting parameters</li>

<li>a vector of dependent variables that will be assigned upon return</li>

<li>a matrix of partial derivatives with respect to the fitting parameters that will be assigned upon return</li>
</ul>

<p>As an example take this definition of a single exponential with 3 parameters (width, amplitude, offset):</p>

<pre> sub expdec {
   my ($x,$par,$ym,$dyda) = @_;
   my ($a,$b,$c) = map {$par-&#62;slice(&#34;($_)&#34;)} (0..2);
   my $arg = $x/$a;
   my $ex = exp($arg);
   $ym .= $b*$ex+$c;
   my (@dy) = map {$dyda-&#62;slice(&#34;,($_)&#34;)} (0..2);
   $dy[0] .= -$b*$ex*$arg/$a;
   $dy[1] .= $ex;
   $dy[2] .= 1;
 }</pre>

<p>Note usage of the <code>.=</code> operator for assignment</p>

<p>In scalar context returns a vector of the fitted dependent variable. In list context returns fitted y-values, vector of fitted parameters, an estimate of the covariance matrix (as an indicator of goodness of fit) and number of iterations performed.</p>

<p>An extended example script that uses lmfit is included below. This nice example was provided by John Gehman and should help you to master the initial hurdles. It can also be found in the <em>Example/Fit</em> directory.</p>

<pre>   use PDL;
   use PDL::Math;
   use PDL::Fit::LM;
   use strict;


   ### fit using pdl&#39;s lmfit (Marquardt-Levenberg non-linear least squares fitting)
   ###
   ### `lmfit&#39; Syntax: 
   ###
   ### ($ym,$a,$covar,$iters) 
   ###  = lmfit $x, $y, $sig, \&#38;fn, $initp, {Maxiter =&#62; 300, Eps =&#62; 1e-3};
   ###
   ### Explanation of variables
   ### 
   ### OUTPUT
   ### $ym =    pdl of fitted values
   ### $a  =    pdl of paramters
   ### $covar = covariance matrix
   ### $iters = number of iterations actually used
   ###
   ### INPUT
   ### $x =      x data
   ### $y =      y data
   ### $sig =    weights for y data (can be set to scalar 1 for equal weighting)
   ### \&#38;fn =    reference to function provided by user (more on this below) 
   ### $initp =  initial values for floating parameters 
   ###               (needs to be explicitly set prior to use of lmfit)
   ### Maxiter = maximum iterations
   ### Eps =     convergence criterium (maximum normalized change in Chi Sq.)

   ### Example:
   # make up experimental data:
   my $xdata = pdl sequence 5;
   my $ydata = pdl [1.1,1.9,3.05,4,4.9];

   # set initial prameters in a pdl (order in accord with fit function below)
   my $initp = pdl [0,1];

   # Weight all y data equally (else specify different weights in a pdl)
   my $wt = 1;

   # Use lmfit. Fourth input argument is reference to user-defined 
   # subroutine ( here \&#38;linefit ) detailed below.
   my ($yf,$pf,$cf,$if) = lmfit $xdata, $ydata, $wt, \&#38;linefit, $initp;

   # Note output
   print &#34;\nXDATA\n$xdata\nY DATA\n$ydata\n\nY DATA FIT\n$yf\n\n&#34;;
   print &#34;Slope and Intercept\n$pf\n\nCOVARIANCE MATRIX\n$cf\n\n&#34;;
   print &#34;NUMBER ITERATIONS\n$if\n\n&#34;;


   # simple example of user defined fit function. Guidelines included on
   # how to write your own function subroutine.
   sub linefit {

           # leave this line as is
           my ($x,$par,$ym,$dyda) = @_;

           # $m and $b are fit parameters, internal to this function
           # call them whatever make sense to you, but replace (0..1)
           # with (0..x) where x is equal to your number of fit parameters
           # minus 1
           my ($m,$b) = map { $par-&#62;slice(&#34;($_)&#34;) } (0..1);

           # Write function with dependent variable $ym,
           # independent variable $x, and fit parameters as specified above.
           # Use the .= (dot equals) assignment operator to express the equality 
           # (not just a plain equals)
           $ym .= $m * $x + $b;

           # Edit only the (0..1) part to (0..x) as above
           my (@dy) = map {$dyda -&#62; slice(&#34;,($_)&#34;) } (0..1);

           # Partial derivative of the function with respect to first 
           # fit parameter ($m in this case). Again, note .= assignment 
           # operator (not just &#34;equals&#34;)
           $dy[0] .= $x;

           # Partial derivative of the function with respect to next 
           # fit parameter ($b in this case)
           $dy[1] .= 1;

           # Add $dy[ ] .= () lines as necessary to supply 
           # partial derivatives for all floating paramters.
   }</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="tlmfit"
>tlmfit</a></h2>

<p>threaded version of Levenberg-Marquardt fitting routine mfit</p>

<pre> tlmfit $x, $y, float(1)-&#62;dummy(0), $na, float(200), float(1e-4),
       $ym=null, $afit=null, \&#38;expdec;</pre>

<pre>  Signature: tlmfit(x(n);y(n);sig(n);a(m);iter();eps();[o] ym(n);[o] ao(m);
           OtherPar =&#62; subref)</pre>

<p>a threaded version of <code>lmfit</code> by using perl threading. Direct threading in <code>lmfit</code> seemed difficult since we have an if condition in the iteration. In principle that can be worked around by using <code>where</code> but .... Send a threaded <code>lmfit</code> version if you work it out!</p>

<p>Since we are using perl threading here speed is not really great but it is just convenient to have a threaded version for many applications (no explicit for-loops required, etc). Suffers from some of the current limitations of perl level threading.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="BUGS"
>BUGS</a></h1>

<p>Not known yet.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>This file copyright (C) 1999, Christian Soeller (c.soeller@auckland.ac.nz). All rights reserved. There is no warranty. You are allowed to redistribute this software documentation under certain conditions. For details, see the file COPYING in the PDL distribution. If this file is separated from the PDL distribution, the copyright notice should be included in the file.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
