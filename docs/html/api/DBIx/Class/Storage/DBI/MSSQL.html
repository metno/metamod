<html><head><title>DBIx::Class::Storage::DBI::MSSQL</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../../../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../../../_grygrnw.css" media="all" >

<script type="text/javascript" src="../../../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Tue Mar 25 17:14:16 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#IMPLEMENTATION_NOTES'>IMPLEMENTATION NOTES</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#IDENTITY_information'>IDENTITY information</a>
    <li class='indexItem indexItem2'><a href='#identity_insert'>identity insert</a>
    <li class='indexItem indexItem2'><a href='#Ordered_Subselects'>Ordered Subselects</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
  <li class='indexItem indexItem1'><a href='#LICENSE'>LICENSE</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>DBIx::Class::Storage::DBI::MSSQL - Base Class for Microsoft SQL Server support in DBIx::Class</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p>This is the base class for Microsoft SQL Server support,
used by <a href="../../../../DBIx/Class/Storage/DBI/ODBC/Microsoft_SQL_Server.html" class="podlinkpod"
>DBIx::Class::Storage::DBI::ODBC::Microsoft_SQL_Server</a> and <a href="../../../../DBIx/Class/Storage/DBI/Sybase/Microsoft_SQL_Server.html" class="podlinkpod"
>DBIx::Class::Storage::DBI::Sybase::Microsoft_SQL_Server</a>.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="IMPLEMENTATION_NOTES"
>IMPLEMENTATION NOTES</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="IDENTITY_information"
>IDENTITY information</a></h2>

<p>Microsoft SQL Server supports three methods of retrieving the IDENTITY value for inserted row: IDENT_CURRENT,
@@IDENTITY,
and SCOPE_IDENTITY().
SCOPE_IDENTITY is used here because it is the safest.
However,
it must be called is the same execute statement,
not just the same connection.</p>

<p>So,
this implementation appends a SELECT SCOPE_IDENTITY() statement onto each INSERT to accommodate that requirement.</p>

<p><code>SELECT @@IDENTITY</code> can also be used by issuing:</p>

<pre>  $self-&#62;_identity_method(&#39;@@identity&#39;);</pre>

<p>it will only be used if SCOPE_IDENTITY() fails.</p>

<p>This is more dangerous, as inserting into a table with an on insert trigger that inserts into another table with an identity will give erroneous results on recent versions of SQL Server.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="identity_insert"
>identity insert</a></h2>

<p>Be aware that we have tried to make things as simple as possible for our users. For MSSQL that means that when a user tries to create a row, while supplying an explicit value for an autoincrementing column, we will try to issue the appropriate database call to make this possible, namely <code>SET IDENTITY_INSERT $table_name ON</code>. Unfortunately this operation in MSSQL requires the <code>db_ddladmin</code> privilege, which is normally not included in the standard write-permissions.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Ordered_Subselects"
>Ordered Subselects</a></h2>

<p>If you attempted the following query (among many others) in Microsoft SQL Server</p>

<pre> $rs-&#62;search ({}, {
  prefetch =&#62; &#39;relation&#39;,
  rows =&#62; 2,
  offset =&#62; 3,
 });</pre>

<p>You may be surprised to receive an exception. The reason for this is a quirk in the MSSQL engine itself, and sadly doesn&#39;t have a sensible workaround due to the way DBIC is built. DBIC can do truly wonderful things with the aid of subselects, and does so automatically when necessary. The list of situations when a subselect is necessary is long and still changes often, so it can not be exhaustively enumerated here. The general rule of thumb is a joined <a href="../../../../DBIx/Class/Relationship.html#has_many" class="podlinkpod"
>has_many</a> relationship with limit/group applied to the left part of the join.</p>

<p>In its &#34;pursuit of standards&#34; Microsft SQL Server goes to great lengths to forbid the use of ordered subselects. This breaks a very useful group of searches like &#34;Give me things number 4 to 6 (ordered by name), and prefetch all their relations, no matter how many&#34;. While there is a hack which fools the syntax checker, the optimizer may <b>still elect to break the subselect</b>. Testing has determined that while such breakage does occur (the test suite contains an explicit test which demonstrates the problem), it is relative rare. The benefits of ordered subselects are on the other hand too great to be outright disabled for MSSQL.</p>

<p>Thus compromise between usability and perfection is the MSSQL-specific <a href="../../../../DBIx/Class/ResultSet.html#ATTRIBUTES" class="podlinkpod"
>resultset attribute</a> <code>unsafe_subselect_ok</code>. It is deliberately not possible to set this on the Storage level, as the user should inspect (and preferably regression-test) the return of every such ResultSet individually. The example above would work if written like:</p>

<pre> $rs-&#62;search ({}, {
  unsafe_subselect_ok =&#62; 1,
  prefetch =&#62; &#39;relation&#39;,
  rows =&#62; 2,
  offset =&#62; 3,
 });</pre>

<p>If it is possible to rewrite the search() in a way that will avoid the need for this flag - you are urged to do so. If DBIC internals insist that an ordered subselect is necessary for an operation, and you believe there is a different/better way to get the same result - please file a bugreport.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>See <a href="../../../../DBIx/Class.html#AUTHOR" class="podlinkpod"
>&#34;AUTHOR&#34; in DBIx::Class</a> and <a href="../../../../DBIx/Class.html#CONTRIBUTORS" class="podlinkpod"
>&#34;CONTRIBUTORS&#34; in DBIx::Class</a>.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="LICENSE"
>LICENSE</a></h1>

<p>You may distribute this code under the same terms as Perl itself.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
