=head1 Deploying METAMOD

=head2 Introduction

This document assumes that the basic METAMOD software are working on the various servers where METAMOD
are intended to run.  How to achieve this is described in a separate document: ... The current document
describes how to use the software to create a cluster of one or more co-operating METAMOD applications
(or METAMOD instances).

=head2 Data base

All the METAMOD instances in a cluster share a common data base. This data base is divided into the
following parts:

=over 17

=item B<Metadatabase>

SQL Database for Metadata

=item B<User database>

SQL Database for User administration

=item B<XML archive>

Metadata file archive based on XML

=item B<Data repository>

Archive of netCDF files

=back

One of the METAMOD applications in a cluster is responsible for the SQL databases. Initialization and
administration of the SQL databases are done through this application, which is called the I<base>
application.

Although the METAMOD instances in a cluster may operate on different servers, they must share a common
file system where the XML archive and the Data repository resides. Technically they may reside on
different file systems, but for each file, the file paths on the various servers must be the same.
Furthermore, for a smooth operation, the clocks on all the involved servers must be synchronized.

The SQL databases may reside on a separate server, different from any of the servers where
the METAMOD instances run.

=head2 METAMOD functional modules

The METAMOD software comprise a broad range of functionality. The software is divided into different
B<modules>, each representing a separate set of related functionality. One such module is the BASE module,
which is used in the base application described above. A METAMOD instance may use any combination of
modules. The only restriction is that one and only one application in a cluster must use the BASE
module.

The METAMOD software comprise the following modules:

=over 10

=item BASE

Responsibility for the SQL databases.

=item SEARCH

Web interface for searching a part of the database for metadata.

=item UPLOAD

Web interface and scripts for uploading (or registering) netCDF files and for editing metadata.

=item HARVEST

Module for harvesting metadata from internet servers offering OAI-PMH support.

=item PMH

OAI-PMH provider. See http://www.openarchives.org/.

=item THREDDS

Used for automatic building of THREDDS catalogs that may be utilized by a THREDDS Data Server to
access the data repository.

=back

B<Note:> SEARCH, PMH and UPLOAD are now integrated with Catalyst and will always be installed (however
you are free not to start it).

=head2 Directory structure

On each server where METAMOD should run, the generic METAMOD software must be available in some directory.
If you installed METAMOD using a met.no Debian package it will be located in /opt/metamod-<version>.
In the description below, this directory is called the B<installation> directory.

In addition to the generic installation directory you need a configuration
directory. This directory contains configuration files, style sheets etc., and
also files regulating metadata requirements. An example application configuration
directory is included in the generic installation directory (the C<app/example>
subdirectory of the installation directory).

The main subdirectories of the generic installation directory are:

=over 10

=item base

Files only used in the BASE module

=item upload

Files only used in the UPLOAD module

=item harvest

Files only used in the HARVEST module

=item thredds

Files only used in the THREDDS module

=item common

Files used by several modules

=item catalyst

Perl Catalyst framework files used for web content generation inside several modules

=item app

Contains the example application source directory

=item docs

METAMOD documentation directory

=back

The module directories (base, search, upload, harvest, pmh, thredds) and also the common directory
(which in the following is implicitly included among the module directories),
all have a similar set of subdirectories:

=over

=item etc

=item scripts

=item htdocs

=item lib

=item schema

=item init

=item userinit

=item staticdata

=back

A module directory will not contain all of these subdirectories. Some subdirectories are only
found in one module directory.

=head2 METAMOD configuration

=head3 master_config.txt

The application configuration directory contains a very important file, the B<master_config.txt> file. This file
governs how METAMOD will run.

The master_config.txt file is a text file containing lines as follows:

   VARNAME = VALUE

'VARNAME' must start from the first character on the line, and be all uppercase letters [A-Z], underscore
or digits. Any number of white space characters may separate 'VARNAME' and '=', and also '=' and
'VALUE'. 'VALUE' starts with the first non-whitespace character and ends with
the last non-whitespace character on the line. Additional lines may be
appended to 'VALUE' immediately after the initial 'VARNAME = ...' line. Such
lines must start with a space character. No whitespace are removed from such
appended lines.

A complete inventory of the variables that should be part of the master_config.txt file is found
in the C<app/example/master_config.txt> file in the generic source directory.

=head3 Metadata configuration

METAMOD is able to handle a large range of metadata frameworks. For metadata generated through the
UPLOAD module (by parsing netCDF files), METAMOD has defined its own XML format, called MM2. This
format has a similar structure as Dublin core; it is a flat structure with freely selected metadata
keywords. For each keyword one or more values may be found. Other metadata frameworks, like DIF or
ISO19115, are also accepted, and such frameworks will typically emerge when harvesting from other
metadata providers through OAI-PMH. While such frameworks (DIF, ISO19115) are hierarchical in nature,
a flattening of these structures takes place when they are imported to the SQL database and
presented through the METAMOD search interface.

The following configuration files regulate which metadata are imported to the SQL database and
available for search, how metadata imported by the HARVEST module are translated into the internal
flat structure used in the SQL database, and how metadata found in the uploaded netCDF files are
translated to MM2 XML files.

=over

=item staticdata/searchdata.xml

This XML file contains metadata vocabularies that are imported into the SQL database, and used
in the SEARCH module for setting up the interactive forms for web users searching the database.

=item etc/conf_digest_nc.xml

This XML file describes the parsing of netCDF files in the UPLOAD module. Specifically how
attributes and variable values in a netCDF file are translated into keyword - value pairs
and stored into an MM2 XML file. The C<conf_digest_nc.xml> file will contain rules regarding which
metadata are required in the netCDF files. The C<app/example/etc/conf_digest_nc.xml> file
represents a well commented example of such a file that can be used as a starting point for a
version tailored to specific needs.

=item etc/usererrors.conf

This file contain html templates that are used in error reports sent to data providers that have
uploaded netCDF files using the UPLOAD module. Each template corresponds to an error condition
defined in the etc/conf_digest_nc.xml file. An example file in the C<app/example/etc> directory
corresponds to the C<conf_digest_nc.xml> in the same directory.

=item XSLT

Files for translating from foreign metadata formats (... more text is needed)

=back

=head3 Stylesheets and other web configuration

METAMOD can be configured with custom texts and stylesheets. To modify the
styles of the application add the following directories to your application
configuration directory.

=over

=item custom/templates

This directory contains the Template::Toolkit templates that you want to
override in your configuration. It is generally never a good idea to override
anything other than the C<custom.tt> file.

=item custom/static/css

This directory contains the CSS files that you want to override in your
configuration. It is generally never a good idea to override anything but the
C<custom.css> file in this folder.

=item custom/static/images

This folder contains the images that you use in your style configuration.

=back

=head3 Overriding texts

To override texts in the application you use the C<custom.tt> file.
C<custom.tt> is a file in C<Template::Toolkit> format.

The way it is used is that it re-defines the default texts found in
C<defaults.tt>.

For instance the following would re-define the HTML used for the header of the
application.

  [%

    # get a safe path to the header image that works in both Apache and outside of Apache
    SET header_image_url = c.uri_for('/static/images/logo.png');
    app.common.header_html = '<img src="' _ header_image_url _ '" />';

  %]

In the same way you can re-define any of the variables found in C<defaults.tt>

=head3 Overriding the CSS

In METAMOD you can override any of the CSS styles in the application using
C<custom.css> since this stylesheet will be the last one loaded by the
application. It is however wise to C<only> modify properties such as background
colors, foreground colors, borders and font size. Modifying the height, width,
padding, margins, display type etc. of elements can lead to the application not
displaying properly in different browsers. Also modifying these properties can
break between different versions of METAMOD.

The style for any element can be modified, but only a few are usually needed.
For an example of the common ones see C<app/example/custom/css/custom.css>

=head3 Path to images

One of the most common customisations are adding a logo image to the header and
the footer of the page. When adding images to the style it is important to get
the path to the image right.

=over

=item custom.tt

To get the path correct in the C<custom.tt> file you can use the following helper function.

 SET image_url = c.uri_for('/static/images/<your image name here>');

This makes a variable C<image_url> that contains the correct URL to the image file.

=item custom.css

To get the path correct in the C<custom.css> file you can use the following path.

  url("../images/aboutheader.gif");

as in

  background-image: url("../images/aboutheader.gif");

=back


=head2 Deploying a METAMOD application

After the initial configuration has been completed, a number of scripts must be run before the
application is up and running. As these scripts will create files and directories that also are used
by the Apache runtime environment, it is important that
I<the user running these scripts is the same as the user running Apache>.

=head3 Activating environment

To make it easier to run the following scripts you can use the bash script activate_env that sets
the correct environment variables. All commands also run without this command, but you must then
specify the correct paths, configuration directory and PERL5LIB for all commands.

From anywhere execute the following command:

  $ source /opt/metno-metamod-<version>/activate_env <PATH TO CONFIGURATION DIR>

This will enable the correct environment. To disable the environment again execute

 $ source /opt/metno-metamod-<version>/activate_env deactivate

=head3 Generate Apache config for the site

Create an Apache configuration file for the application. This is done by

  gen_httpd_conf.pl

which creates a file <configuration dir>/etc/httpd.conf with the necessary configuration.

=head3 Generate init.d scripts

Create init.d scripts for automatic starting and stopping of Catalyst and the various METAMOD
services.

  gen_initd_script.pl

This script generates a file in <configuration dir>/etc/init.d/ and
<configuration dir>/etc/default/

=head3 Creating the webrun directory

The application also needs several directories to store files during operation.
Run the

  prepare_runtime_env.sh

This script will initialize a runtime directory used by the application for logging, temporary
files etc.

=head3 Installing services

After installation, you should now install the application services where the
operating system can find it. Currently only Debian-based Linux systems are
supported. The following scripts will generate symlinks in /etc for Apache and
init.d pointing back to the configuration directory, as well as a small script for running
metamodInit.sh. You will need sudo permissions to successfully run the script.

  install_jobs.sh

=head3 Initializing the BASE module

At this point, the deployment of the application is complete for all instances not using the BASE
module. For an application using the BASE module, a few steps remains:

As explained in the B<Data base> paragraph, several METAMOD applications may co-operate in a cluster,
and share a common data base. One of these applications must use the BASE module, and no other.
The last steps (described below) required for the base application must be done after the initial
steps (described above), for all applications in the cluster, are completed.

The two PostgreSQL databases used by the cluster must be initialized. Note that the two databases are
operated through two database users. The name of these users are found in the C<master_config.txt>
file as the value of PG_ADMIN_USER and PG_WEB_USER configuration variables. These users must be
defined in the PostgreSQL database environment before the database initialization scripts can be
run. The C<base/init/createusers.sh> script may be used for this purpose. It is only necessary to run this
script once for a PostgreSQL database environment.

The first SQL database initialization script will create the Meta database.

	create_and_load_all.sh

This script will create the database, and load the static content of the database (taken from
C<staticdata/searchdata.xml>). You may check the output of this script in the
C<create_and_load_all.out> file in the directory where you are running the command.

The next SQL database initialization script will create the User database.

	run_createuserdb.sh

Note that I<this script must only be used during setup of a completely new METAMOD cluster>. If a
User database already exists, all data in the database will be lost. If this should happen, you must
recreate the database from a backup copy you hopefully have. But METAMOD will not by itself ensure
that such a backup exists.

This warning is only adequate for the C<run_createuserdb.sh> script. The other scripts in this
paragraph (C<prepare_runtime_env.sh>, C<create_and_load_all.sh>) may all be
used on an existing installation, without harming existing data. The C<create_and_load_all.sh> script
will take some time to complete, though. On an existing installation, all metadata in the database
will be loaded from the XML archive.

=head2 Starting METAMOD

=head3 Catalyst daemon

Start Catalyst by running

	sudo /etc/init.d/catalyst-APPLICATION_ID start

Then check if METAMOD is responding (usually on port 3000, use server name if not running locally):

	http://localhost:3000/

If all set you should see the METAMOD search interface.

=head3 Apache

If this has not already been done you need to enable the Apache proxy modules.
Look in /etc/apache2/mods-enabled to see if they have already been enabled.

   sudo a2enmod proxy
   sudo a2enmod proxy_http

Restart Apache:

	sudo apache2ctl restart

or if the site is busy:

	sudo apache2ctl graceful

which will wait until all connections are terminated before restarting.

The site should now hopefully be available on

	http://localhost/APPLICATION_ID


=head3 METAMOD services

Start METAMOD:

	sudo /etc/init.d//metamodServices-APPLICATION_ID start

This should start the required services daemons.
