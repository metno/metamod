<html xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <title>WMS client</title>

        <link rel="stylesheet" href="[% c.uri_for('/static/css/reset.css') %]" />
        <link rel="stylesheet" href="[% c.uri_for('/static/css/base.css') %]" />

        <link rel="stylesheet" href="[% c.uri_for('/static/css/metamod_theme/jquery-ui.css') %]" />
        <script type="text/javascript" src="[% c.uri_for('/static/js/jquery.min.js') %]"></script>
        <script type="text/javascript" src="[% c.uri_for('/static/js/jquery-ui.min.js') %]"></script>

        <script type="text/javascript" src="[% c.uri_for('/static/js/log4javascript-1.4.2/js/log4javascript.js') %]"></script>
        <script type="text/javascript" src="[% c.uri_for('/static/lib/Firebug/firebug.js') %]"></script>

        <style type="text/css">
            pre.rollup { display: none; font-size: small }
            p.info { font-size: smaller }
            div.list { font-size: smaller; padding-left: 20px; }
            h1 { font-size: large; }
            h3 { font-size: 14px; }
        </style>

    </head>
    <body>

    <h1>WMS layers</h1>

    <form action="[% c.uri_for('/search/wms') %]" method="get">

        [% FOREACH ds IN datasets %]
            [% url = ds.wmsinfo.documentElement.getAttribute('url') _ '?service=WMS&version=1.3.0&request=GetCapabilities' %]
            <h3><a href="[% url %]">[% ds.ds_id %]</a>: [% ds.ds_name %] <a href="#" onclick="$(setup_[% ds.ds_id %]).toggle(800)">*</a></h3>


            <pre id="setup_[% ds.ds_id %]" class="rollup">[% ds.wmsinfo.toString | html %]</pre>

            [% cap = ds.wmscap; projs = [] # FIXME: check projs valid for all layers %]
            
            <p class="info">
            [% FOREACH area IN ds.wmsinfo.findnodes('/*/*[local-name() = "displayArea"]');
                area.getAttribute('crs') _ ',';
                area.getAttribute('left') _ ',';
                area.getAttribute('top') _ ',';
                area.getAttribute('right') _ ',';
                area.getAttribute('bottom');
            %]
            [% END %]
            </p>

            <div class="list">
            [% FOREACH layer IN cap.findnodes('//*[local-name() = "Layer"]');
                FOREACH crs IN layer.getChildrenByLocalName('CRS');
                    projs.push(crs.textContent);
                END;
                names = layer.getChildrenByLocalName('Name');
                NEXT UNLESS names;
                name = names.first.textContent;
                title = layer.getChildrenByLocalName('Title').first.textContent;
            %]
                <input type="checkbox" name="layer_[% ds.ds_id %]" value="[% name %]"/>[% title %]

                <br/>
            [% END %]
            </div>

        [% END %]


    <div>
        <select name="crs">
            [% FOREACH p IN projs.sort.unique %]
                <option>[% p %]</option>
            [% END %]
        </select>
        w <input size="7" name="left" value="-3000000"/>
        n <input size="7" name="top" value="7000000"/>
        e <input size="7" name="right" value="7000000"/>
        s <input size="7" name="bottom" value="-3000000"/>
        <input type="submit" value="Visualize"/>
    </div>
    </form>

    </body>
</html>
